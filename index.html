</head>
<body>
    <div class="top-bar-container">
        <h1 class="page-main-title">Chrono HIIT</h1>
        <div class="app-header">
            <div class="header-actions">
                <button id="toggleThemeBtn" title="Cambiar Tema"><i data-feather="moon"></i></button>
                <button id="toggleFullScreenBtn" title="Modo Pantalla Completa"><i data-feather="maximize"></i></button>
            </div>
        </div>
    </div>
    <img id="userLogo" src="#" alt="Logo de usuario" class="hidden">
    <div class="container">
        <div id="configuracionSection" class="configuracion-section">
            <div class="config-item"><label for="numEjercicios">Ejercicios / Serie:</label><select id="numEjercicios"></select></div>
            <div id="exerciseNamesContainer" class="exercise-names-section hidden"></div>
            <div class="config-item"><label for="numSeries">Series Totales:</label><select id="numSeries"></select></div>
            <div class="config-item"><label for="tiempoEjercicio">T. Ejercicio (s):</label><select id="tiempoEjercicio"></select></div>
            <div class="config-item"><label for="descansoEjercicio">T. Desc. Ej. (s):</label><select id="descansoEjercicio"></select></div>
            <div class="config-item"><label for="descansoSerie">T. Desc. Serie (s):</label><select id="descansoSerie"></select></div>
        </div>
        <div id="estimatedTimeSection" class="estimated-time-section"><p>Duración Estimada: <span id="estimatedTimeDisplay">00:00:00</span></p></div>
        <div class="progress-indicators">
           <div class="progress-section"><span class="progress-label">Ejercicio Actual:</span><div id="exerciseProgress" class="progress-circles"></div></div>
           <div class="progress-section"><span class="progress-label">Serie Actual:</span><div id="seriesProgress" class="progress-circles"></div></div>
        </div>
        <div class="controls-section button-group">
            <button id="startPauseResumeBtn"><i data-feather="play"></i><span class="btn-text">Iniciar</span></button>
            <button id="restartExerciseBtn" class="hidden"><i data-feather="rewind"></i><span class="btn-text">Reiniciar Ej.</span></button>
            <button id="finishBtn" class="hidden"><i data-feather="x-circle"></i><span class="btn-text">Finalizar</span></button>
        </div>
        <div id="timerDisplaySection" class="timer-display-section hidden">
            <div id="estadoActual">Preparado</div>
            <div id="currentExerciseNameDisplay" class="current-exercise-name hidden"></div>
            <div id="cronometroActual">00:00</div>
            <div id="cronometroTotalLabel">Tiempo Total Acumulado</div><div id="cronometroTotal">00:00:00</div>
        </div>
    </div>
    <footer class="app-footer">
        <div class="footer-controls">
            <input type="file" id="logoUploadInput" accept="image/png, image/jpeg" class="hidden">
            <button id="uploadLogoBtn" class="footer-btn" title="Subir Logo"><i data-feather="upload"></i><span class="btn-text">Subir Logo</span></button>
            <button id="removeLogoBtn" class="footer-btn hidden" title="Quitar Logo"><i data-feather="trash-2"></i><span class="btn-text">Quitar Logo</span></button>
            <button id="exportSettingsBtn" class="footer-btn" title="Exportar Configuración"><i data-feather="download"></i><span class="btn-text">Exportar</span></button>
            <input type="file" id="importSettingsInput" accept=".json" class="hidden">
            <button id="importSettingsBtn" class="footer-btn" title="Importar Configuración"><i data-feather="upload-cloud"></i><span class="btn-text">Importar</span></button>
            <button id="saveRoutineBtn" class="footer-btn" title="Guardar Rutina Actual"><i data-feather="save"></i><span class="btn-text">Guardar Rutina</span></button>
            <button id="loadRoutineBtn" class="footer-btn" title="Cargar Rutina Guardada"><i data-feather="folder"></i><span class="btn-text">Cargar Rutinas</span></button>
            <button id="manageNamesBtn" class="footer-btn" title="Gestionar Nombres Guardados"><i data-feather="edit-3"></i><span class="btn-text">Nombres</span></button>
            <button id="showExplanationBtn" class="footer-btn" title="Mostrar Explicación de Ejercicios"><i data-feather="layout"></i><span class="btn-text">Ver Ej.</span></button>
        </div>
        <p class="creator-info"><img src="icons/image.webp" alt="Icono del Creador" class="footer-app-icon">Creado por <span class="seo-name">Enrique Gil</span></p>
    </footer>
<div id="explanationScreen" class="modal-screen hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Vista de Ejercicios</h2>
            <div class="modal-header-buttons">
                <button id="toggleExplanationFSBtn" class="modal-fs-btn" title="Maximizar Vista"><i data-feather="maximize-2"></i></button>
                <button id="closeExplanationBtn" class="modal-close-btn" title="Cerrar"><i data-feather="x"></i></button>
            </div>
        </div>
        <div id="explanationGrid" class="explanation-grid"></div>
    </div>
</div>

<div id="manageNamesScreen" class="modal-screen hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Gestionar Nombres Guardados</h2>
             <div class="modal-header-buttons">
                <button id="closeManageNamesBtn" class="modal-close-btn" title="Cerrar"><i data-feather="x"></i></button>
            </div>
        </div>
        <ul id="manageNamesList"></ul>
        <p id="noNamesMessage" class="no-items-message hidden">No hay nombres de ejercicios guardados.</p>
    </div>
</div>

<div id="loadRoutineScreen" class="modal-screen hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Cargar Rutina Guardada</h2>
            <div class="modal-header-buttons">
                <button id="closeLoadRoutineBtn" class="modal-close-btn" title="Cerrar"><i data-feather="x"></i></button>
            </div>
        </div>
        <ul id="loadRoutineList"></ul>
        <p id="noRoutinesMessage" class="no-items-message hidden">No hay rutinas guardadas.</p>
    </div>
</div>
<!-- Exercise suggestions dropdown will be created here by JS if needed, or appended to body -->
<script>
    // Variable para los ejercicios predefinidos, se llenará desde el CSV
    let predefinedExercises = {};

    // FUNCIÓN PARA PARSEAR CSV (simple, maneja comillas y comas dentro de campos)
    function parseCSV(csvText) {
        const lines = csvText.trim().split(/\r?\n/); // Maneja saltos de línea \n y \r\n
        if (lines.length < 2) return {}; // Necesita al menos encabezados y una línea de datos

        const headers = lines[0].split(',').map(header => header.trim());
        const data = {};

        for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim() === "") continue; // Saltar líneas vacías

            const values = [];
            let currentLine = lines[i];
            let inQuotes = false;
            let currentValue = '';
            let charIndex = 0;

            while(charIndex < currentLine.length) {
                let char = currentLine[charIndex];

                if (char === '"') {
                    // Si es una comilla de escape "" dentro de un campo entrecomillado
                    if (inQuotes && charIndex + 1 < currentLine.length && currentLine[charIndex + 1] === '"') {
                        currentValue += '"';
                        charIndex++; // Saltar la siguiente comilla
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(currentValue);
                    currentValue = '';
                } else {
                    currentValue += char;
                }
                charIndex++;
            }
            values.push(currentValue); // Añadir el último valor

            if (values.length === headers.length) {
                const entry = {};
                let exerciseNameKey = "";
                headers.forEach((header, index) => {
                    let value = values[index].trim();
                    // Quitar comillas de inicio/fin SOLO si el campo entero estaba entrecomillado
                    if (value.startsWith('"') && value.endsWith('"')) {
                         // Verificar que no sea solo una comilla escapada al inicio/fin
                        if (!value.startsWith('""') && !value.endsWith('""') || value.length === 2) {
                           value = value.substring(1, value.length - 1);
                        }
                    }
                    // Reemplazar comillas dobles escapadas ("") por una sola comilla (")
                    // Esta lógica ya está cubierta por el bucle anterior si se hace bien
                    // value = value.replace(/""/g, '"');


                    if (header === "NombreEjercicio") {
                        exerciseNameKey = value;
                    } else if (header === "URLImagen") {
                        entry.image = value;
                    } else if (header === "Descripcion") {
                        entry.description = value;
                    }
                });
                if (exerciseNameKey && typeof entry.image !== 'undefined' && typeof entry.description !== 'undefined') {
                    data[exerciseNameKey] = entry;
                } else {
                    console.warn("Línea de CSV omitida por datos incompletos o mal formateados:", lines[i], entry, exerciseNameKey);
                }
            } else {
                 console.warn("Línea de CSV omitida por número incorrecto de campos:", lines[i]);
            }
        }
        return data;
    }

    // FUNCIÓN PARA CARGAR EJERCICIOS DESDE CSV
    async function loadPredefinedExercisesFromCSV() {
        try {
            // Añadir un parámetro anti-caché para asegurar que se carga el archivo más reciente en desarrollo
            const response = await fetch('predefined_exercises.csv?v=' + new Date().getTime());
            if (!response.ok) {
                throw new Error(`Error al cargar el CSV: ${response.status} ${response.statusText}`);
            }
            const csvText = await response.text();
            predefinedExercises = parseCSV(csvText);
            console.log("Ejercicios predefinidos cargados desde CSV:", Object.keys(predefinedExercises).length, "ejercicios.");
            if (Object.keys(predefinedExercises).length === 0 && csvText.trim() !== "") {
                console.error("El CSV parece tener contenido pero el parseo resultó en 0 ejercicios. Revisa el formato del CSV y la función parseCSV.");
                 alert("Advertencia: El archivo CSV de ejercicios se cargó pero no se pudieron parsear ejercicios. Revisa la consola para más detalles.");
            }
        } catch (error) {
            console.error("No se pudieron cargar los ejercicios predefinidos desde el CSV:", error);
            predefinedExercises = { // Fallback
                 "Flexiones (Fallback)": { image: "images/flexiones_suelo.webp", description: "Ejercicio clásico para pecho, hombros y tríceps. (Cargado por defecto debido a error con CSV)" },
                 "Sentadillas (Fallback)": { image: "images/sentadillas_saco.webp", description: "Ejercicio para piernas. (Cargado por defecto debido a error con CSV)" }
            };
            alert("Error al cargar la lista de ejercicios predeterminados desde el archivo CSV. Se usarán valores por defecto. Revisa la consola para más detalles.");
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const getEl = id => document.getElementById(id);
        const qS = sel => document.querySelector(sel);

        // --- LLAMADA INICIAL PARA CARGAR EL CSV ---
        await loadPredefinedExercisesFromCSV();

        const numEjSel = getEl('numEjercicios'), numSerSel = getEl('numSeries'), tEjSel = getEl('tiempoEjercicio'), dEjSel = getEl('descansoEjercicio'), dSerSel = getEl('descansoSerie');
        const allSels = [numEjSel, numSerSel, tEjSel, dEjSel, dSerSel];
        if (allSels.some(s => !s)) { console.error("CRITICAL: Selects not found."); alert("Error: Controls not loaded."); return; }

        const startBtn = getEl('startPauseResumeBtn'), finishBtn = getEl('finishBtn'), restartEjBtn = getEl('restartExerciseBtn'), fsBtn = getEl('toggleFullScreenBtn'), themeBtn = getEl('toggleThemeBtn'), cfgSec = getEl('configuracionSection'), estTimeEl = getEl('estimatedTimeSection'), estTimeDispEl = getEl('estimatedTimeDisplay'), timerDispSec = getEl('timerDisplaySection'), estadoEl = getEl('estadoActual'), cronoActEl = getEl('cronometroActual'), cronoTotalEl = getEl('cronometroTotal'), ejProgEl = getEl('exerciseProgress'), serProgEl = getEl('seriesProgress'), bodyEl = document.body, contEl = qS('.container'), footerEl = qS('.app-footer'), ejNamesContEl = getEl('exerciseNamesContainer'), curEjNameDispEl = getEl('currentExerciseNameDisplay'), logoEl = getEl('userLogo'), logoUploadIn = getEl('logoUploadInput'), uploadLogoBtn = getEl('uploadLogoBtn'), remLogoBtn = getEl('removeLogoBtn'), exportBtn = getEl('exportSettingsBtn'), importIn = getEl('importSettingsInput'), importBtn = getEl('importSettingsBtn'), progIndEl = qS('.progress-indicators');
        const showExplBtn = getEl('showExplanationBtn'), explScreenEl = getEl('explanationScreen'), closeExplBtn = getEl('closeExplanationBtn'), explGridEl = getEl('explanationGrid'), toggleExplFSBtn = getEl('toggleExplanationFSBtn');
        const manageNamesBtn = getEl('manageNamesBtn'), manageNamesScreenEl = getEl('manageNamesScreen'), closeManageNamesBtn = getEl('closeManageNamesBtn'), manageNamesListEl = getEl('manageNamesList'), noNamesMsgEl = getEl('noNamesMessage');
        const saveRoutineBtn = getEl('saveRoutineBtn'), loadRoutineBtn = getEl('loadRoutineBtn'), loadRoutineScreenEl = getEl('loadRoutineScreen'), closeLoadRoutineBtn = getEl('closeLoadRoutineBtn'), loadRoutineListEl = getEl('loadRoutineList'), noRoutinesMsgEl = getEl('noRoutinesMessage');

        let rootSt = getComputedStyle(document.documentElement), phaseColors = {};
        function updPhaseColors() { rootSt = getComputedStyle(document.documentElement); phaseColors = { preparacion: rootSt.getPropertyValue('--phase-prep').trim(), ejercicio: rootSt.getPropertyValue('--phase-ex').trim(), descanso: rootSt.getPropertyValue('--phase-rest').trim(), descanso_ejercicio: rootSt.getPropertyValue('--phase-rest').trim(), descanso_serie: rootSt.getPropertyValue('--phase-rest').trim(), finalizado: rootSt.getPropertyValue('--phase-end').trim() }; }
        updPhaseColors();

        let audioCtx, beepStartBuf, beepEndBuf, beepMidBuf;
        const FREQ_START = 660, DUR_START = 0.15, FREQ_END = 440, DUR_END = 0.20, FREQ_MID = 880, DUR_MID = 0.08, BEEP_VOL = 1.0;
        let phaseTimer = null, totalTimer = null, totalSecs = 0, phaseSecs = 0;
        let cfg = { exerciseNames: [] }, curSer = 1, curEj = 1;
        let curPhase = '', running = false, paused = false, rePrep = false;
        const PREP_TIME = 5, RE_PREP_TIME = 5;
        const DB_NAME = 'ChronoHIIT_DB', DB_VER = 2;
        const USER_SETTINGS_STORE = 'userSettings', SAVED_ROUTINES_STORE = 'savedRoutines';
        const LOGO_K = 'userLogoData', EJ_NAMES_K = 'allExerciseNames';
        let db, allEjNamesSet = new Set();

        let suggestionsDropdown = null;
        let activeSuggestionInput = null;
        let blurTimeout = null;

        const openDB = () => new Promise((res, rej) => {
            const req = indexedDB.open(DB_NAME, DB_VER);
            req.onupgradeneeded = e => {
                const d = e.target.result;
                if (!d.objectStoreNames.contains(USER_SETTINGS_STORE)) d.createObjectStore(USER_SETTINGS_STORE);
                if (!d.objectStoreNames.contains(SAVED_ROUTINES_STORE)) d.createObjectStore(SAVED_ROUTINES_STORE, { keyPath: 'nombreRutina' });
            };
            req.onsuccess = e => { db = e.target.result; res(db); };
            req.onerror = e => { console.error('IDB err:', e.target.errorCode); rej('IDB err.'); };
        });
        const dbAction = async (storeName, mode, action, keyOrData, dataOnlyForPutKv) => {
            if (!db) await openDB();
            return new Promise((res, rej) => {
                const tx = db.transaction([storeName], mode);
                const store = tx.objectStore(storeName);
                let req;
                if (action === 'put' && storeName === SAVED_ROUTINES_STORE) req = store.put(keyOrData);
                else if (action === 'put_kv' && storeName === USER_SETTINGS_STORE) req = store.put(dataOnlyForPutKv, keyOrData);
                else if (action === 'get') req = store.get(keyOrData);
                else if (action === 'delete') req = store.delete(keyOrData);
                else if (action === 'getAll') req = store.getAll();
                else return rej('Invalid DB action');
                req.onsuccess = e => res(action === 'get' || action === 'getAll' ? e.target.result : true);
                req.onerror = e => { console.error(`DB ${action} err on ${storeName}:`, e); rej(e); };
            });
        };

        async function loadAllEjNames() { try { const names = await dbAction(USER_SETTINGS_STORE, 'readonly', 'get', EJ_NAMES_K); allEjNamesSet = (names && Array.isArray(names)) ? new Set(names) : new Set(); } catch (err) { console.error("Err load all ej names:", err); allEjNamesSet = new Set(); } }
        async function addEjNameToGlobal(name) { if (name && !allEjNamesSet.has(name) && !predefinedExercises[name]) { allEjNamesSet.add(name); try { await dbAction(USER_SETTINGS_STORE, 'readwrite', 'put_kv', EJ_NAMES_K, Array.from(allEjNamesSet)); } catch (err) { console.error("Err save global ej name list:", err); } } }
        async function removeEjNameFromGlobal(name) { if (name && allEjNamesSet.has(name)) { allEjNamesSet.delete(name); try { await dbAction(USER_SETTINGS_STORE, 'readwrite', 'put_kv', EJ_NAMES_K, Array.from(allEjNamesSet)); return true; } catch (err) { console.error("Err removing ej name from global list:", err); return false;} } return false; }
        async function loadLogo() { try { const stored = await dbAction(USER_SETTINGS_STORE, 'readonly', 'get', LOGO_K); logoEl.src = stored || '#'; logoEl.classList.toggle('hidden', !stored); logoEl.style.display = stored ? 'block' : 'none'; remLogoBtn.classList.toggle('hidden', !stored); uploadLogoBtn.classList.toggle('hidden', !!stored); bodyEl.classList.toggle('logo-visible', !!stored); if (typeof feather!=='undefined') feather.replace(); } catch (err) { console.error('Err load logo:', err); logoEl.src='#'; logoEl.classList.add('hidden'); logoEl.style.display='none'; remLogoBtn.classList.add('hidden'); uploadLogoBtn.classList.remove('hidden'); bodyEl.classList.remove('logo-visible'); if(typeof feather!=='undefined')feather.replace();}}
        function handleLogoUpload(e) { const f = e.target.files[0]; if (f && f.type.startsWith('image/')) { const r = new FileReader(); r.onload = async ev => { try { await dbAction(USER_SETTINGS_STORE, 'readwrite', 'put_kv',LOGO_K, ev.target.result); loadLogo(); } catch (err) { console.error('Err save logo:', err); alert('Err save logo.'); } }; r.readAsDataURL(f); } else if (f) alert('Use PNG/JPG.'); }
        async function remLogo() { try { await dbAction(USER_SETTINGS_STORE, 'readwrite', 'delete',LOGO_K); loadLogo(); } catch (err) { console.error('Err rem logo:', err); alert('Err rem logo.'); } }
        
        function getOrCreateSuggestionsDropdown() {
            if (!suggestionsDropdown) {
                suggestionsDropdown = document.createElement('div');
                suggestionsDropdown.id = 'exerciseSuggestionsDropdown';
                suggestionsDropdown.className = 'exercise-suggestions-dropdown hidden';
                document.body.appendChild(suggestionsDropdown);
                document.addEventListener('click', function(event) {
                    if (activeSuggestionInput && suggestionsDropdown && !suggestionsDropdown.classList.contains('hidden')) {
                        const isClickInsideInput = activeSuggestionInput.contains(event.target);
                        const isClickInsideDropdown = suggestionsDropdown.contains(event.target);
                        if (!isClickInsideInput && !isClickInsideDropdown) {
                            hideSuggestions();
                        }
                    }
                });
            }
            return suggestionsDropdown;
        }
        function hideSuggestions() {
            const dropdown = getOrCreateSuggestionsDropdown();
            dropdown.classList.add('hidden');
            activeSuggestionInput = null;
        }
        function populateAndFilterSuggestions(inputElement, filterText = "") {
            const dropdown = getOrCreateSuggestionsDropdown();
            dropdown.innerHTML = '';
            const combinedNames = new Set([...Object.keys(predefinedExercises), ...Array.from(allEjNamesSet)]);
            const sortedNames = Array.from(combinedNames).sort((a, b) => a.localeCompare(b));
            const lowerFilterText = filterText.toLowerCase();
            const filtered = sortedNames.filter(name => name.toLowerCase().includes(lowerFilterText));

            if (filtered.length === 0 && !filterText) { hideSuggestions(); return; }
            if (filtered.length === 0 && filterText) {
                const noResultItem = document.createElement('div');
                noResultItem.textContent = 'No hay sugerencias';
                noResultItem.style.fontStyle = 'italic';
                noResultItem.style.pointerEvents = 'none';
                dropdown.appendChild(noResultItem);
            } else {
                filtered.forEach(name => {
                    const item = document.createElement('div');
                    item.textContent = name;
                    item.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        inputElement.value = name;
                        inputElement.dispatchEvent(new Event('blur', { bubbles: true, cancelable: true }));
                        hideSuggestions();
                    });
                    dropdown.appendChild(item);
                });
            }
            const inputRect = inputElement.getBoundingClientRect();
            dropdown.style.left = `${inputRect.left + window.scrollX}px`;
            dropdown.style.top = `${inputRect.bottom + window.scrollY}px`;
            dropdown.style.width = `${inputRect.width}px`;
            if ((filtered.length > 0) || (filtered.length === 0 && filterText)) {
                dropdown.classList.remove('hidden');
            } else {
                hideSuggestions();
            }
        }
        function popEjNameInputs() {
            if (!ejNamesContEl || !numEjSel) return;
            const numEj = parseInt(numEjSel.value) || 0;
            ejNamesContEl.innerHTML = '';
            const oldDlEl = getEl('ej-names-sugg');
            if (oldDlEl) oldDlEl.remove();
            if (numEj === 0 || numEjSel.disabled) {
                ejNamesContEl.classList.add('hidden');
                if(suggestionsDropdown) hideSuggestions();
                return;
            }
            ejNamesContEl.classList.remove('hidden');
            for (let i = 0; i < numEj; i++) {
                const itmDiv = document.createElement('div'); itmDiv.className = 'exercise-name-item';
                const lbl = document.createElement('label'); lbl.htmlFor = `ejName${i+1}`; lbl.textContent = `Ejercicio ${i+1}:`;
                const inp = document.createElement('input'); inp.type = 'text'; inp.id = `ejName${i+1}`; inp.placeholder = `Nombre Ej. ${i+1}`; inp.dataset.index = i; inp.disabled = numEjSel.disabled;
                inp.autocomplete = "off";
                inp.addEventListener('focus', (ev) => { activeSuggestionInput = ev.target; clearTimeout(blurTimeout); populateAndFilterSuggestions(ev.target, ev.target.value); });
                inp.addEventListener('input', (ev) => { populateAndFilterSuggestions(ev.target, ev.target.value); });
                inp.addEventListener('blur', async (ev) => {
                    blurTimeout = setTimeout(() => { if (activeSuggestionInput === ev.target) { hideSuggestions(); }}, 150);
                    const name = ev.target.value.trim();
                    if (name && !name.startsWith('Ejercicio ') && !predefinedExercises[name]) { await addEjNameToGlobal(name); }
                });
                inp.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') { hideSuggestions(); ev.target.blur(); }});
                if (cfg && cfg.exerciseNames && cfg.exerciseNames[i]) inp.value = cfg.exerciseNames[i];
                itmDiv.append(lbl, inp); ejNamesContEl.appendChild(itmDiv);
            }
        }

        function genProgCircles(cont, count) { if (!cont) return; cont.innerHTML = ''; for (let i = 0; i < count; i++) { const circ = document.createElement('div'); circ.className = 'progress-circle'; circ.dataset.index = i; cont.appendChild(circ); } }
        function updProgCircles(type, count, completed = false) { const cont = type === 'exercise' ? ejProgEl : serProgEl; if (!cont) return; const circs = cont.querySelectorAll('.progress-circle'); circs.forEach((c, idx) => { c.classList.remove('completed', 'active'); if (idx < count - 1) c.classList.add('completed'); else if (idx === count - 1) { if (completed) c.classList.add('completed'); else if ((running || rePrep) && curPhase !== 'finalizado' && curPhase !== 'preparacion') { if (type === 'exercise' && (curPhase === 'ejercicio' || rePrep)) c.classList.add('active'); else if (type === 'series' && (curPhase === 'ejercicio' || rePrep || curPhase.startsWith('descanso_'))) c.classList.add('active'); } } }); if (curPhase === 'finalizado' && !running) circs.forEach(c => { c.classList.remove('active'); c.classList.add('completed'); }); }
        const createBeep = (freq, dur, vol = BEEP_VOL) => { if (!audioCtx) return null; const sr = audioCtx.sampleRate, nFrames = dur * sr, buf = audioCtx.createBuffer(1, nFrames, sr), data = buf.getChannelData(0); for (let i = 0; i < nFrames; i++) data[i] = Math.sin(2 * Math.PI * freq * i / sr) * vol; return buf; };
        async function initAudio() { if (!audioCtx && (window.AudioContext || window.webkitAudioContext)) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') await audioCtx.resume(); } if (audioCtx && !beepStartBuf) { beepStartBuf = createBeep(FREQ_START, DUR_START); beepEndBuf = createBeep(FREQ_END, DUR_END); beepMidBuf = createBeep(FREQ_MID, DUR_MID); } }
        const playBeep = buf => { if (!audioCtx || !buf || audioCtx.state === 'suspended') return; try { const src = audioCtx.createBufferSource(); src.buffer = buf; src.connect(audioCtx.destination); src.start(); } catch (e) { console.error("Beep err:", e); } };
        function popSel(sel, s, e, stp, def) { if (!sel) return; sel.innerHTML = ''; for (let i = s; i <= e; i += stp) { const opt = document.createElement('option'); opt.value = i; opt.textContent = i; if (i === def) opt.selected = true; sel.appendChild(opt); } }
        if (numEjSel) popSel(numEjSel, 1, 20, 1, 4); if (numSerSel) popSel(numSerSel, 1, 10, 1, 3); if (tEjSel) popSel(tEjSel, 30, 90, 5, 45); if (dEjSel) popSel(dEjSel, 15, 30, 5, 15); if (dSerSel) popSel(dSerSel, 30, 120, 15, 60);
        const fmtTime = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
        const fmtTotalTime = s => `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
        function calcEstTime() { if (allSels.some(s => !s)) return; const c = { numS: parseInt(numSerSel.value), numE: parseInt(numEjSel.value), tE: parseInt(tEjSel.value), dE: parseInt(dEjSel.value), dS: parseInt(dSerSel.value) }; let total = PREP_TIME; if (c.numS <= 0 || c.numE <= 0) { if (estTimeDispEl) estTimeDispEl.textContent = fmtTotalTime(PREP_TIME); return; } let tSet = (c.numE * c.tE) + (c.numE > 1 ? (c.numE - 1) * c.dE : 0); total += tSet * c.numS + (c.numS > 1 ? (c.numS - 1) * c.dS : 0); if (estTimeDispEl) estTimeDispEl.textContent = fmtTotalTime(total); }
        function updUIDisp() { if (cronoActEl) cronoActEl.textContent = fmtTime(phaseSecs); if (cronoTotalEl) cronoTotalEl.textContent = fmtTotalTime(totalSecs); if (curEjNameDispEl) { curEjNameDispEl.textContent = ''; curEjNameDispEl.classList.add('hidden'); } if (estadoEl) estadoEl.className = ''; if (timerDispSec) { const cls = Array.from(timerDispSec.classList); timerDispSec.classList.remove(...cls.filter(c => c.startsWith('bg-') || c === 'paused-overlay')); } const phClsPfx = 'phase-'; bodyEl.classList.remove(...Array.from(bodyEl.classList).filter(c => c.startsWith(phClsPfx) && c !== 'dark-theme'), 'active-timer-bg'); contEl.classList.remove(...Array.from(contEl.classList).filter(c => c.startsWith(phClsPfx)), 'active-timer-bg'); let txt = '', serInfo = (cfg.numSeries > 1) ? ` (Serie ${curSer}/${cfg.numSeries})` : '', timerBgCls = '', stTxtCls = '', curPhStyle = '', bodyPhClr = '', curEjName = ''; if (rePrep) { txt = "¡Ajusta Posición!"; timerBgCls = 'bg-preparacion'; stTxtCls = 'preparacion-text'; curPhStyle = 'preparacion'; curEjName = (cfg.exerciseNames && cfg.exerciseNames[curEj-1]) ? cfg.exerciseNames[curEj-1] : (cfg.numEjercicios > 0 ? `Ejercicio ${curEj}` : ''); } else if (running && curPhase && curPhase !== 'finalizado') { curPhStyle = curPhase; switch (curPhase) { case 'preparacion': txt = "Prepárate"; timerBgCls = 'bg-preparacion'; stTxtCls = 'preparacion-text'; curEjName = (cfg.exerciseNames && cfg.exerciseNames[0]) ? `Siguiente: ${cfg.exerciseNames[0]}` : (cfg.numEjercicios > 0 ? `Siguiente: Ejercicio 1` : ''); break; case 'ejercicio': txt = `Ejercicio ${curEj}${serInfo}`; timerBgCls = 'bg-ejercicio'; stTxtCls = 'ejercicio-text'; curEjName = (cfg.exerciseNames && cfg.exerciseNames[curEj-1]) ? cfg.exerciseNames[curEj-1] : (cfg.numEjercicios > 0 ? `Ejercicio ${curEj}` : ''); break; case 'descanso_ejercicio': txt = `Descanso Ej.${serInfo}`; timerBgCls = 'bg-descanso'; stTxtCls = 'descanso-text'; curEjName = (cfg.exerciseNames && cfg.exerciseNames[curEj]) ? `Siguiente: ${cfg.exerciseNames[curEj]}` : (cfg.numEjercicios > 0 && curEj < cfg.numEjercicios ? `Siguiente: Ejercicio ${curEj+1}` : ''); break; case 'descanso_serie': txt = "Descanso Serie"; timerBgCls = 'bg-descanso'; stTxtCls = 'descanso-text'; curEjName = (cfg.exerciseNames && cfg.exerciseNames[0]) ? `Siguiente: ${cfg.exerciseNames[0]}` : (cfg.numEjercicios > 0 ? `Siguiente: Ejercicio 1` : ''); break; } } else if (curPhase === 'finalizado') { txt = "¡Finalizado!"; timerBgCls = 'bg-finalizado'; stTxtCls = 'finalizado-text'; curPhStyle = 'finalizado'; curEjName = "¡Buen trabajo!"; } else { txt = "Listo"; if (curEjNameDispEl) curEjNameDispEl.classList.add('hidden'); } if (curPhStyle && phaseColors[curPhStyle]) { bodyPhClr = phaseColors[curPhStyle]; bodyEl.classList.add(`phase-${curPhStyle}`); contEl.classList.add(`phase-${curPhStyle}`); if (running || rePrep) { bodyEl.classList.add('active-timer-bg'); contEl.classList.add('active-timer-bg'); } } bodyEl.style.backgroundColor = ((bodyEl.classList.contains('full-screen-mode') && (running || rePrep || curPhase === 'finalizado')) || (!bodyEl.classList.contains('full-screen-mode') && (running || rePrep || curPhase === 'finalizado'))) ? (bodyPhClr || '') : ''; if (estadoEl) { estadoEl.textContent = txt; if (stTxtCls) estadoEl.classList.add(stTxtCls); } if (curEjNameDispEl && curEjName) { curEjNameDispEl.textContent = curEjName; curEjNameDispEl.classList.remove('hidden'); } else if (curEjNameDispEl) curEjNameDispEl.classList.add('hidden'); if (timerDispSec && timerBgCls) timerDispSec.classList.add(timerBgCls); else if (timerDispSec) timerDispSec.classList.remove(...Array.from(timerDispSec.classList).filter(c => c.startsWith('bg-'))); if (paused && running && timerDispSec && !rePrep) timerDispSec.classList.add('paused-overlay'); }
        function setUI(st) { const enCfg = (st === 'initial' || st === 'finished'), isFs = bodyEl.classList.contains('full-screen-mode'); allSels.forEach(s => { if(s) s.disabled = !enCfg; }); if(cfgSec) cfgSec.classList.toggle('hidden', isFs || !enCfg); if(estTimeEl) estTimeEl.classList.toggle('hidden', isFs || !enCfg); if(ejNamesContEl){const nInps=ejNamesContEl.querySelectorAll('input[type="text"]'); nInps.forEach(i=>i.disabled=!enCfg); const nEj = numEjSel ? parseInt(numEjSel.value) : 0; ejNamesContEl.classList.toggle('hidden', isFs || !enCfg || nEj === 0); if(enCfg) popEjNameInputs();} logoEl.style.display = logoEl.classList.contains('hidden') ? 'none' : 'block'; if(timerDispSec){timerDispSec.classList.toggle('hidden', st==='initial' && !isFs); if(st==='initial'){timerDispSec.classList.remove(...Array.from(timerDispSec.classList).filter(c=>c.startsWith('bg-')||c==='paused-overlay')); if(estadoEl){estadoEl.className=''; estadoEl.textContent="Listo";} if(cronoActEl) cronoActEl.textContent="00:00"; if(cronoTotalEl) cronoTotalEl.textContent="00:00:00"; if(curEjNameDispEl){curEjNameDispEl.textContent=''; curEjNameDispEl.classList.add('hidden');} curPhase=''; rePrep=false; if(ejProgEl)ejProgEl.innerHTML=''; if(serProgEl)serProgEl.innerHTML='';}else if(curEjNameDispEl)curEjNameDispEl.classList.remove('hidden');} if(startBtn){startBtn.classList.remove('paused'); const ico=startBtn.querySelector('i.feather'), txt=startBtn.querySelector('.btn-text'); if(st==='initial'){if(txt)txt.textContent="Iniciar"; if(ico)ico.setAttribute('data-feather','play');}else if(st==='running'){if(txt)txt.textContent="Pausar"; if(ico)ico.setAttribute('data-feather','pause');}else if(st==='paused'){if(txt)txt.textContent="Reanudar"; if(ico)ico.setAttribute('data-feather','play-circle'); startBtn.classList.add('paused');}else if(st==='finished'){if(txt)txt.textContent="Nuevo"; if(ico)ico.setAttribute('data-feather','refresh-cw');} if(ico && typeof feather!=='undefined')feather.replace();} if(finishBtn)finishBtn.classList.toggle('hidden',!(st==='running'||st==='paused')||rePrep); if(restartEjBtn){const show=st==='running'&&curPhase==='ejercicio'&&!rePrep&&!paused; restartEjBtn.classList.toggle('hidden',!show);} if(st==='finished'){curPhase='finalizado';rePrep=false;} if(progIndEl){const showInd=(cfg&&cfg.numEjercicios>1)||(cfg&&cfg.numSeries>1);let hide= !showInd; if(isFs&&(st==='initial'||st==='finished'))hide=true; progIndEl.classList.toggle('hidden',hide);} 
            [showExplBtn, manageNamesBtn, saveRoutineBtn, loadRoutineBtn].forEach(btn => { if(btn) btn.classList.toggle('hidden-during-run', st==='running'||st==='paused'||isFs); });
            updUIDisp(); 
        }
        function phaseTick() { if (paused && !rePrep) return; if (rePrep) { if (phaseSecs <= RE_PREP_TIME && phaseSecs >= 1 && phaseSecs <= 3) playBeep(beepMidBuf); } else if (curPhase === 'ejercicio' && running) { if (cfg.tiempoEjercicio >= 20 && phaseSecs === Math.ceil(cfg.tiempoEjercicio / 2) && phaseSecs > 5) playBeep(beepMidBuf); if (phaseSecs <= 5 && phaseSecs >= 1) playBeep(beepMidBuf); } phaseSecs--; updUIDisp(); if (phaseSecs < 0) { if (rePrep) { rePrep = false; playBeep(beepStartBuf); startPhase('ejercicio', cfg.tiempoEjercicio); } else { if (running) { if (curPhase === 'ejercicio') { updProgCircles('exercise', curEj, true); if (curEj === cfg.numEjercicios) updProgCircles('series', curSer, true); } playBeep(beepEndBuf); } nextPhase(); } } }
        function totalTick() { if (paused || !running) return; totalSecs++; if (cronoTotalEl) cronoTotalEl.textContent = fmtTotalTime(totalSecs); }
        function nextPhase() { clearInterval(phaseTimer); phaseTimer = null; let name = '', dur = 0; if (curPhase === 'preparacion') { name = 'ejercicio'; dur = cfg.tiempoEjercicio; } else if (curPhase === 'ejercicio') { if (cfg.numEjercicios > 1 && curEj < cfg.numEjercicios) { name = 'descanso_ejercicio'; dur = cfg.descansoEjercicio; } else { if (curSer < cfg.numSeries) { name = 'descanso_serie'; dur = cfg.descansoSerie; } else { finishWorkout(true); return; } } } else if (curPhase === 'descanso_ejercicio') { curEj++; name = 'ejercicio'; dur = cfg.tiempoEjercicio; } else if (curPhase === 'descanso_serie') { curSer++; curEj = 1; name = 'ejercicio'; dur = cfg.tiempoEjercicio; } else { console.error("Unknown phase:", curPhase); finishWorkout(false); return; } startPhase(name, dur); }
        function startPhase(name, dur) { curPhase = name; rePrep = false; phaseSecs = dur; if (name === 'ejercicio') { updProgCircles('exercise', curEj); updProgCircles('series', curSer); } else if (name === 'preparacion') { if (cfg && cfg.numEjercicios) updProgCircles('exercise', curEj); if (cfg && cfg.numSeries) updProgCircles('series', curSer); } setUI(running ? (paused ? 'paused' : 'running') : 'initial'); if (running && !paused && name === 'ejercicio' && !rePrep) playBeep(beepStartBuf); if (phaseTimer) clearInterval(phaseTimer); if (dur <= 0 && running && !paused && name !== 'finalizado') { setTimeout(nextPhase, 50); return; } if (running && !paused && name !== 'finalizado') phaseTimer = setInterval(phaseTick, 1000); }
        async function restartCurEj() { if (!running || curPhase !== 'ejercicio' || rePrep) return; await initAudio(); clearInterval(phaseTimer); phaseTimer = null; paused = false; rePrep = true; phaseSecs = RE_PREP_TIME; playBeep(beepMidBuf); setUI('running'); phaseTimer = setInterval(phaseTick, 1000); }
        async function startWorkout() { if (running && !paused) return; await initAudio(); cfg = { numSeries: parseInt(numSerSel.value), numEjercicios: parseInt(numEjSel.value), tiempoEjercicio: parseInt(tEjSel.value), descansoEjercicio: parseInt(dEjSel.value), descansoSerie: parseInt(dSerSel.value), exerciseNames: [] }; if (ejNamesContEl && cfg.numEjercicios > 0) { const nInps = ejNamesContEl.querySelectorAll('input[type="text"]'); nInps.forEach((inp, i) => { cfg.exerciseNames[i] = inp.value.trim() || `Ejercicio ${i+1}`; }); } for (let i = cfg.exerciseNames.length; i < cfg.numEjercicios; i++) cfg.exerciseNames[i] = `Ejercicio ${i+1}`; if (cfg.exerciseNames && cfg.exerciseNames.length > 0) { for (const name of cfg.exerciseNames) { if (name.startsWith('Ejercicio ') || predefinedExercises[name]) continue; await addEjNameToGlobal(name); } } curSer = 1; curEj = 1; totalSecs = 0; paused = false; running = true; rePrep = false; if (ejProgEl) genProgCircles(ejProgEl, cfg.numEjercicios); if (serProgEl) genProgCircles(serProgEl, cfg.numSeries); startPhase('preparacion', PREP_TIME); if (totalTimer) clearInterval(totalTimer); totalTimer = setInterval(totalTick, 1000); }
        function pauseWorkout() { if (!running || paused || rePrep) return; paused = true; setUI('paused'); }
        function resumeWorkout() { if (!running || !paused || rePrep) return; if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume().then(() => { paused = false; setUI('running'); }).catch(e => console.error("Resume AC err:", e)); else { paused = false; setUI('running'); } }
        function finishWorkout(completed = true) { clearInterval(phaseTimer); clearInterval(totalTimer); phaseTimer = null; totalTimer = null; running = false; paused = false; rePrep = false; if (completed) { if (cfg.numEjercicios) updProgCircles('exercise', cfg.numEjercicios, true); if (cfg.numSeries) updProgCircles('series', cfg.numSeries, true); setUI('finished'); } else { totalSecs = 0; phaseSecs = 0; curPhase = ''; if (cfg) cfg.exerciseNames = []; if (curEjNameDispEl) { curEjNameDispEl.textContent = ''; curEjNameDispEl.classList.add('hidden'); } if (ejProgEl) ejProgEl.innerHTML = ''; if (serProgEl) serProgEl.innerHTML = ''; setUI('initial'); calcEstTime(); popEjNameInputs(); } }
        allSels.forEach(s => { if (s) s.onchange = calcEstTime; });
        if (numEjSel) numEjSel.onchange = () => { calcEstTime(); popEjNameInputs(); };
        if (startBtn) startBtn.onclick = () => { if (rePrep) return; if (!audioCtx || audioCtx.state === 'suspended') initAudio().then(() => { if (!running) startWorkout(); else if (paused) resumeWorkout(); else pauseWorkout(); }); else { if (!running) startWorkout(); else if (paused) resumeWorkout(); else pauseWorkout(); } };
        if (finishBtn) finishBtn.onclick = () => { if (rePrep) return; finishWorkout(false); };
        if (restartEjBtn) restartEjBtn.onclick = () => { if (paused && curPhase === 'ejercicio' && !rePrep) { paused = false; restartCurEj(); } else if (!paused && curPhase === 'ejercicio' && !rePrep) restartCurEj(); };
        if (fsBtn) { const ico = fsBtn.querySelector('i.feather'); const isFSE = () => !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement); const togBFS = () => { if(!isFSE()){if(document.documentElement.requestFullscreen)document.documentElement.requestFullscreen().catch(e=>{console.warn(`FS Err: ${e.message}`)}) ;else if(document.documentElement.webkitRequestFullscreen)document.documentElement.webkitRequestFullscreen();else if(document.documentElement.msRequestFullscreen)document.documentElement.msRequestFullscreen()}else{if(document.exitFullscreen)document.exitFullscreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.msExitFullscreen)document.msExitFullscreen()}}; fsBtn.onclick = togBFS; const hFSC = () => { const isFS = isFSE(); bodyEl.classList.toggle('full-screen-mode', isFS); if(ico)ico.setAttribute('data-feather',isFS?'minimize':'maximize'); fsBtn.title=isFS?"Salir Pantalla Completa":"Modo Pantalla Completa"; if(footerEl)footerEl.style.display=isFS?'none':'flex'; if(typeof feather!=='undefined')feather.replace(); let cs; if(!running&&!paused&&curPhase==='')cs='initial';else if(curPhase==='finalizado')cs='finished';else if(paused)cs='paused';else cs='running'; setUI(cs);}; ['fullscreenchange','webkitfullscreenchange','mozfullscreenchange','MSFullscreenChange'].forEach(ev=>document.addEventListener(ev,hFSC));}
        const thIco = themeBtn ? themeBtn.querySelector('i.feather') : null; if (themeBtn) themeBtn.onclick = () => { const newTh = bodyEl.classList.contains('dark-theme') ? 'light' : 'dark'; localStorage.setItem('theme', newTh); applyTh(newTh); }; function applyTh(th) { bodyEl.classList.toggle('dark-theme', th === 'dark'); if (thIco) thIco.setAttribute('data-feather', th === 'dark' ? 'sun' : 'moon'); if (themeBtn) themeBtn.title = `Cambiar a Tema ${th === 'dark' ? 'Claro' : 'Oscuro'}`; if (typeof feather !== 'undefined') feather.replace(); updPhaseColors(); updUIDisp(); }
        if(uploadLogoBtn)uploadLogoBtn.onclick=()=>logoUploadIn.click(); if(logoUploadIn)logoUploadIn.onchange=handleLogoUpload; if(remLogoBtn)remLogoBtn.onclick=remLogo;
        async function getCurCfgObj(forRoutineSave = false){
            const currentConfig = {
                numEjercicios: parseInt(numEjSel.value), numSeries: parseInt(numSerSel.value),
                tiempoEjercicio: parseInt(tEjSel.value), descansoEjercicio: parseInt(dEjSel.value),
                descansoSerie: parseInt(dSerSel.value)
            };
            const exerciseNames = [];
            const nInps = ejNamesContEl.querySelectorAll('input[type="text"]');
            nInps.forEach((inp, i) => { exerciseNames[i] = inp.value.trim() || `Ejercicio ${i + 1}`; });
            for (let i = exerciseNames.length; i < currentConfig.numEjercicios; i++) exerciseNames[i] = `Ejercicio ${i + 1}`;

            if (forRoutineSave) {
                return { config: currentConfig, exerciseNames: exerciseNames };
            } else {
                return { ...currentConfig, exerciseNames: exerciseNames, theme: localStorage.getItem('theme') || 'light', allExerciseNames: Array.from(allEjNamesSet), userLogoBase64: (logoEl.src && logoEl.src !== '#' && !logoEl.classList.contains('hidden')) ? logoEl.src : null };
            }
        }
        if(exportBtn)exportBtn.onclick=async()=>{const s=await getCurCfgObj(false),j=JSON.stringify(s,null,2),b=new Blob([j],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='chrono_hiit_settings.json';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);if(typeof feather!=='undefined')feather.replace()};
        if(importBtn)importBtn.onclick=()=>{importIn.click();if(typeof feather!=='undefined')feather.replace()};
        if(importIn)importIn.onchange=async e=>{const f=e.target.files[0];if(f){const r=new FileReader();r.onload=async ev=>{try{const s=JSON.parse(ev.target.result);await applyImpCfg(s);alert('Conf. importada con éxito. La página se recargará.'); window.location.reload();}catch(err){console.error('Err import conf:',err);alert('Err import.')}};r.readAsText(f);e.target.value=null}};
        async function applyImpCfg(s){if(!s)return;if(s.numEjercicios!==undefined)numEjSel.value=s.numEjercicios;if(s.numSeries!==undefined)numSerSel.value=s.numSeries;if(s.tiempoEjercicio!==undefined)tEjSel.value=s.tiempoEjercicio;if(s.descansoEjercicio!==undefined)dEjSel.value=s.descansoEjercicio;if(s.descansoSerie!==undefined)dSerSel.value=s.descansoSerie;if(s.theme){localStorage.setItem('theme',s.theme);}if(s.allExerciseNames&&Array.isArray(s.allExerciseNames)){allEjNamesSet=new Set(s.allExerciseNames);await dbAction(USER_SETTINGS_STORE, 'readwrite', 'put_kv', EJ_NAMES_K, Array.from(allEjNamesSet))}cfg.exerciseNames=s.exerciseNames||[];if(s.userLogoBase64){try{await dbAction(USER_SETTINGS_STORE, 'readwrite', 'put_kv',LOGO_K,s.userLogoBase64);}catch(e){console.error('Err save imported logo:',e)}}else if(s.userLogoBase64===null){try{await dbAction(USER_SETTINGS_STORE, 'readwrite', 'delete',LOGO_K);}catch(e){console.error('Err rem logo from import:',e)}}}
        
        function popExplGrid(){
            if(!explGridEl||!numEjSel)return; explGridEl.innerHTML='';
            const numEj=parseInt(numEjSel.value)||0,ejNameInps=ejNamesContEl.querySelectorAll('input[type="text"]');
            for(let i=0;i<numEj;i++){
                const itmD=document.createElement('div');itmD.className='explanation-item';
                const numS=document.createElement('span');numS.className='explanation-item-number';numS.textContent=i+1;
                const nameS=document.createElement('span');nameS.className='explanation-item-name';
                let curEjName=`Ejercicio ${i+1}`;
                if(ejNameInps[i]&&ejNameInps[i].value.trim()){curEjName=ejNameInps[i].value.trim()}else if(cfg&&cfg.exerciseNames&&cfg.exerciseNames[i]){curEjName=cfg.exerciseNames[i]}
                nameS.textContent=curEjName;
                const imgCont=document.createElement('div');imgCont.className='explanation-item-image-container';
                const imgEl=document.createElement('img');imgEl.className='explanation-item-image';
                if(predefinedExercises[curEjName]&&predefinedExercises[curEjName].image){imgEl.src=predefinedExercises[curEjName].image;imgEl.alt=curEjName}else{imgEl.alt="Sin imagen"}
                imgCont.appendChild(imgEl);
                itmD.append(numS,nameS,imgCont);
                explGridEl.appendChild(itmD)
            }
        }

        if(showExplBtn && explScreenEl && closeExplBtn && toggleExplFSBtn){
            showExplBtn.onclick = () => {
                popExplGrid();
                explScreenEl.classList.remove('hidden', 'modal-fullscreen-active');
                const icon = toggleExplFSBtn.querySelector('i.feather');
                if(icon) icon.setAttribute('data-feather', 'maximize-2');
                toggleExplFSBtn.title = "Maximizar Vista";
                bodyEl.style.overflow = 'hidden';
                if(typeof feather !== 'undefined') feather.replace();
            };
            const closeExplModal = () => {
                explScreenEl.classList.add('hidden');
                explScreenEl.classList.remove('modal-fullscreen-active'); 
                const icon = toggleExplFSBtn.querySelector('i.feather');
                if(icon) icon.setAttribute('data-feather', 'maximize-2'); 
                toggleExplFSBtn.title = "Maximizar Vista";
                bodyEl.style.overflow = '';
                if(typeof feather !== 'undefined') feather.replace();
            };
            closeExplBtn.onclick = closeExplModal;
            toggleExplFSBtn.onclick = () => {
                explScreenEl.classList.toggle('modal-fullscreen-active');
                const isModalFS = explScreenEl.classList.contains('modal-fullscreen-active');
                const icon = toggleExplFSBtn.querySelector('i.feather');
                if(icon) icon.setAttribute('data-feather', isModalFS ? 'minimize-2' : 'maximize-2');
                toggleExplFSBtn.title = isModalFS ? "Restaurar Vista" : "Maximizar Vista";
                if(typeof feather !== 'undefined') feather.replace();
            };
            window.addEventListener('keydown',e=>{if(e.key==='Escape'&&!explScreenEl.classList.contains('hidden')) closeExplModal(); });
            explScreenEl.onclick=e=>{if(e.target===explScreenEl) closeExplModal(); };
        }

        function populateManageNamesModal() {
            if (!manageNamesListEl || !noNamesMsgEl) return;
            manageNamesListEl.innerHTML = '';
            const sortedNames = Array.from(allEjNamesSet).sort((a, b) => a.localeCompare(b));
            noNamesMsgEl.classList.toggle('hidden', sortedNames.length > 0);
            sortedNames.forEach(name => {
                const li = document.createElement('li');
                const nameSpan = document.createElement('span'); nameSpan.className = 'managed-name-text'; nameSpan.textContent = name;
                const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-name-btn'; deleteBtn.innerHTML = '<i data-feather="trash-2"></i>'; deleteBtn.title = `Eliminar "${name}"`;
                deleteBtn.onclick = async () => {
                    if (confirm(`¿Seguro que quieres eliminar el ejercicio "${name}" de tus nombres guardados?`)) {
                        if (await removeEjNameFromGlobal(name)) {
                            li.remove(); popEjNameInputs();
                            if (manageNamesListEl.children.length === 0) noNamesMsgEl.classList.remove('hidden');
                        } else alert(`Error al eliminar "${name}".`);
                    }
                };
                li.append(nameSpan, deleteBtn); manageNamesListEl.appendChild(li);
            });
            if (typeof feather !== 'undefined') feather.replace();
        }
        if (manageNamesBtn && manageNamesScreenEl && closeManageNamesBtn) {
            manageNamesBtn.onclick = () => { populateManageNamesModal(); manageNamesScreenEl.classList.remove('hidden'); bodyEl.style.overflow = 'hidden'; if (typeof feather !== 'undefined') feather.replace(); };
            const closeManageModal = () => { manageNamesScreenEl.classList.add('hidden'); bodyEl.style.overflow = ''; popEjNameInputs(); };
            closeManageNamesBtn.onclick = closeManageModal;
            window.addEventListener('keydown', e => { if (e.key === 'Escape' && !manageNamesScreenEl.classList.contains('hidden')) closeManageModal(); });
            manageNamesScreenEl.onclick = e => { if (e.target === manageNamesScreenEl) closeManageModal(); };
        }

        async function saveCurrentRoutine() {
            const routineName = prompt("Introduce un nombre para esta rutina:", `Rutina ${new Date().toLocaleDateString()}`);
            if (!routineName || routineName.trim() === "") { alert("Nombre de rutina inválido."); return; }
            const routineConfig = await getCurCfgObj(true);
            const routineToSave = { nombreRutina: routineName.trim(), config: routineConfig.config, exerciseNames: routineConfig.exerciseNames };
            try { await dbAction(SAVED_ROUTINES_STORE, 'readwrite', 'put', routineToSave); alert(`Rutina "${routineToSave.nombreRutina}" guardada.`); } 
            catch (err) { console.error("Error guardando rutina:", err); if (err.name === 'ConstraintError') { alert("Error: Ya existe una rutina con ese nombre."); } else { alert("Error al guardar la rutina."); } }
        }

        async function populateLoadRoutineModal() {
            if (!loadRoutineListEl || !noRoutinesMsgEl) return;
            loadRoutineListEl.innerHTML = '';
            try {
                const routines = await dbAction(SAVED_ROUTINES_STORE, 'readonly', 'getAll') || [];
                noRoutinesMsgEl.classList.toggle('hidden', routines.length > 0);
                if (routines.length > 0) {
                    routines.sort((a,b) => a.nombreRutina.localeCompare(b.nombreRutina)).forEach(r => {
                        const li = document.createElement('li');
                        const nameSpan = document.createElement('span'); nameSpan.className = 'routine-name-text'; nameSpan.textContent = r.nombreRutina;
                        const actionsDiv = document.createElement('div'); actionsDiv.className = 'routine-actions';
                        const loadBtn = document.createElement('button'); loadBtn.className = 'routine-action-btn'; loadBtn.innerHTML = '<i data-feather="download-cloud"></i> Cargar';
                        loadBtn.onclick = () => {
                            numEjSel.value = r.config.numEjercicios; numSerSel.value = r.config.numSeries; tEjSel.value = r.config.tiempoEjercicio; dEjSel.value = r.config.descansoEjercicio; dSerSel.value = r.config.descansoSerie;
                            cfg.exerciseNames = r.exerciseNames || [];
                            allSels.forEach(sel => sel.dispatchEvent(new Event('change'))); popEjNameInputs(); calcEstTime();
                            if (running) finishWorkout(false); else setUI('initial');
                            loadRoutineScreenEl.classList.add('hidden'); bodyEl.style.overflow = ''; alert(`Rutina "${r.nombreRutina}" cargada.`);
                        };
                        const deleteBtn = document.createElement('button'); deleteBtn.className = 'routine-action-btn'; deleteBtn.innerHTML = '<i data-feather="trash-2"></i> Eliminar';
                        deleteBtn.onclick = async () => {
                            if (confirm(`¿Seguro que quieres eliminar la rutina "${r.nombreRutina}"?`)) {
                                try { await dbAction(SAVED_ROUTINES_STORE, 'readwrite', 'delete', r.nombreRutina); populateLoadRoutineModal(); } 
                                catch (err) { console.error("Error eliminando rutina:", err); alert("Error al eliminar rutina."); }
                            }
                        };
                        actionsDiv.append(loadBtn, deleteBtn); li.append(nameSpan, actionsDiv); loadRoutineListEl.appendChild(li);
                    });
                }
            } catch (err) { console.error("Error cargando rutinas guardadas:", err); noRoutinesMsgEl.classList.remove('hidden'); }
            if (typeof feather !== 'undefined') feather.replace();
        }

        if (saveRoutineBtn) saveRoutineBtn.onclick = saveCurrentRoutine;
        if (loadRoutineBtn && loadRoutineScreenEl && closeLoadRoutineBtn) {
            loadRoutineBtn.onclick = () => { populateLoadRoutineModal(); loadRoutineScreenEl.classList.remove('hidden'); bodyEl.style.overflow = 'hidden'; if (typeof feather !== 'undefined') feather.replace();};
            const closeLoadModal = () => { loadRoutineScreenEl.classList.add('hidden'); bodyEl.style.overflow = '';};
            closeLoadRoutineBtn.onclick = closeLoadModal;
            window.addEventListener('keydown', e => { if (e.key === 'Escape' && !loadRoutineScreenEl.classList.contains('hidden')) closeLoadModal(); });
            loadRoutineScreenEl.onclick = e => { if (e.target === loadRoutineScreenEl) closeLoadModal(); };
        }

        // --- Initial Setup ---
        try {
            await openDB();
            await loadAllEjNames(); 
            await loadLogo();
            calcEstTime();
            const savedTh = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
            applyTh(savedTh); 
            setUI('initial'); 
            popEjNameInputs();
            if (typeof feather !== 'undefined') feather.replace();
        } catch (err) {
            console.error("IDB init o configuración inicial falló:", err); 
            alert("Advertencia: El almacenamiento local o la configuración inicial falló. Algunas características como guardar el logo o los nombres de ejercicios podrían no estar disponibles o no persistir.");
            // Fallback si es necesario para la UI básica, asumiendo que predefinedExercises ya tiene el fallback
            calcEstTime();
            const savedTh = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
            applyTh(savedTh); 
            setUI('initial'); 
            popEjNameInputs();
            if (typeof feather !== 'undefined') feather.replace();
        }
    });
</script>
Use code with caution.
</body>
</html>
