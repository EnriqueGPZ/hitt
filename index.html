<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrono HIIT - Cronómetro de Intervalos Avanzado</title>
    <meta name="description" content="Chrono HIIT: Cronómetro personalizable para HIIT/Tabata. Guarda ejercicios, exporta/importa configuraciones y rutinas. Incluye monitor de ritmo cardíaco, gráfica en tiempo real, zonas cardíacas personalizadas por edad, guardado de sesiones e historial.">
    <meta name="keywords" content="chrono hiit, cronometro, temporizador, tabata, hiit, ejercicio, fitness, rutina, workout, online, gratis, guardar, exportar, importar, rutinas, bluetooth, heart rate, ritmo cardiaco, BLE, grafica, chart, COOSPO, COROS, Decathlon, Fitbit, Garmin, Huawei, Magene, Polar, Scosche, Sigma, Suunto, Wahoo, Xiaomi, historial sesiones, resumen ejercicio, zonas cardiacas personalizadas, edad, fcmáx">
    <link rel="canonical" href="https://www.hiit.es">
    <link rel="apple-touch-icon" sizes="57x57" href="icons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="icons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="icons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="icons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="icons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="icons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="icons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="icons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="icons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="icons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="icons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="icons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff">
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700;900&family=Roboto+Condensed:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@latest/dist/chartjs-plugin-annotation.min.js"></script>

    <script type="application/ld+json">{"@context":"https://schema.org","@type":"WebPage","name":"Chrono HIIT - Cronómetro de Intervalos Avanzado","description":"Herramienta online gratuita para configurar y seguir entrenamientos por intervalos, incluyendo rutinas Tabata. Personaliza tus tiempos, nombres de ejercicios, y gestiona tus configuraciones. Incluye monitor de ritmo cardíaco (BLE) con gráfica en tiempo real, análisis de zonas cardíacas personalizadas por edad, guardado de resúmenes de sesión e historial de entrenamientos.","url":"https://www.hiit.es","keywords":"chrono hiit, cronómetro entrenamiento, temporizador intervalos, tabata, HIIT, ejercicio, fitness, rutina, workout, guardar ejercicios, exportar configuracion, resetear nombres, guardar rutinas, cargar rutinas, bluetooth, heart rate, ritmo cardiaco, BLE, grafica, chart, zonas cardiacas, COOSPO, COROS, Decathlon, Fitbit, Garmin, Huawei, Magene, Polar, Scosche, Sigma, Suunto, Wahoo, Xiaomi, historial sesiones, resumen ejercicio, zonas cardiacas personalizadas, edad, fcmáx","mainEntity":{"@type":"SoftwareApplication","name":"Chrono HIIT","applicationCategory":"HealthApplication","operatingSystem":"Web","browserRequirements":"Requires HTML5, CSS3, JavaScript, IndexedDB support.","featureList":["Temporizador de preparación","Configuración de tiempo de ejercicio","Configuración de tiempo de descanso entre ejercicios","Configuración de tiempo de descanso entre series","Configuración de número de ejercicios por serie","Configuración de número de series","Nombres de ejercicios personalizables con autocompletado y ejercicios predefinidos con imágenes","Almacenamiento de lista global de ejercicios","Gestión individual de nombres de ejercicios guardados","Cálculo de tiempo total estimado","Alertas sonoras de cambio de fase","Soporte para rutinas tipo Tabata y HIIT","Reinicio de ejercicio actual con preparación","Modo pantalla completa para visualización en grande","Indicadores visuales de progreso","Tema Claro/Oscuro con persistencia","Exportar configuración a JSON","Importar configuración desde JSON","Gestión de logo personalizado","Vista de explicación de ejercicios con imágenes predefinidas y opción de maximizar", "Guardar rutinas personalizadas", "Cargar rutinas guardadas", "Conexión Bluetooth para monitor de ritmo cardíaco (BLE)", "Gráfica de ritmo cardíaco en tiempo real", "Cálculo de tiempo en zonas cardíacas personalizadas por edad", "Resumen de sesión de ejercicio con gráficas", "Guardado de historial de sesiones", "Visualización de historial de sesiones"],"offers":{"@type":"Offer","price":"0","priceCurrency":"USD"}},"breadcrumb":{"@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Herramientas de Fitness","item":"https://www.hiit.es"},{"@type":"ListItem","position":2,"name":"Chrono HIIT"}]}}</script>
    <style>
        :root {
            --font-display: 'Oswald', sans-serif; --font-body: 'Roboto Condensed', sans-serif;

            --color-bg-l: #A0A0A0;
            --color-surf-l: #A8A8A8;
            --color-prim-acc-l: #333333;
            --color-txt-prim-l: #121212;
            --color-txt-sec-l: #555555;
            --color-hl-l: #000000;
            --txt-phase-bg-l: #121212;
            --txt-phase-end-bg-l: #121212;
            --btn-head-brd-l: #333333;
            --btn-head-clr-l: #121212;
            --sel-brd-l: #333333;
            --prog-circ-brd-l: #333333;
            --prog-circ-comp-bg-l: #121212;
            --prog-circ-act-brd-l: #000000;
            --chart-grid-color-l: rgba(0,0,0,0.1);
            --chart-tick-color-l: #555555;
            --chart-line-color-l: #FF6347; 
            --chart-point-color-l: #E55039; 
            --chart-annotation-line-l: #333333;
            --chart-annotation-box-bg-l: rgba(220, 220, 220, 0.3); /* Light gray semi-transparent */


            --color-bg-d: #2D2D2D;
            --color-surf-d: #3C3C3C;
            --chart-grid-color-d: rgba(255,255,255,0.1);
            --chart-tick-color-d: #B0B0B0;
            --chart-line-color-d: #FFA07A; 
            --chart-point-color-d: #FF7F50; 
            --chart-annotation-line-d: #E0E0E0;
            --chart-annotation-box-bg-d: rgba(80, 80, 80, 0.3); /* Dark gray semi-transparent */


            --color-bg: var(--color-bg-l); --color-surf: var(--color-surf-l);
            --color-prim-acc: var(--color-prim-acc-l); --color-txt-prim: var(--color-txt-prim-l);
            --color-txt-sec: var(--color-txt-sec-l); --color-hl: var(--color-hl-l);
            --txt-phase-bg: var(--txt-phase-bg-l); --txt-phase-end-bg: var(--txt-phase-end-bg-l);
            --btn-head-brd: var(--btn-head-brd-l); --btn-head-clr: var(--btn-head-clr-l);
            --sel-brd: var(--sel-brd-l); --prog-circ-brd: var(--prog-circ-brd-l);
            --prog-circ-comp-bg: var(--prog-circ-comp-bg-l); --prog-circ-act-brd: var(--prog-circ-act-brd-l);
            --chart-grid-color: var(--chart-grid-color-l);
            --chart-tick-color: var(--chart-tick-color-l);
            --chart-line-color: var(--chart-line-color-l);
            --chart-point-color: var(--chart-point-color-l);
            --chart-annotation-line: var(--chart-annotation-line-l);
            --chart-annotation-box-bg: var(--chart-annotation-box-bg-l);


            --box-shdw-subtle: none; 
            --phase-paused-overlay: rgba(28,28,43,0.85);
            --btn-head-hover-bg: rgba(0,0,0,0.05);
            --sel-bg: transparent;
            --sel-dis-bg: transparent;
            --sel-dis-clr: rgba(0,0,0,0.4);
            --est-time-bg: transparent;
            --phase-prep: #00a8ff; --phase-ex: #2ed573; --phase-rest: #ffa502; --phase-end: #575fcf;
            --brd-rad-main: 10px; --brd-rad-sm: 6px; --logo-h-fs: 50px;
        }
        body.dark-theme {
            --color-bg: var(--color-bg-d);
            --color-surf: var(--color-surf-d);
            --color-prim-acc: #E0E0E0;
            --color-txt-prim: #F5F5F5;
            --color-txt-sec: #B0B0B0;
            --color-hl: #FFFFFF;
            --txt-phase-bg: #F5F5F5;
            --txt-phase-end-bg: #F5F5F5;
            --btn-head-brd: #E0E0E0;
            --btn-head-clr: #F5F5F5;
            --sel-brd: #E0E0E0;
            --prog-circ-brd: #E0E0E0;
            --prog-circ-comp-bg: #F5F5F5;
            --prog-circ-act-brd: #FFFFFF;
            --box-shdw-subtle: none; 
            --phase-paused-overlay: rgba(0,0,0,0.85);
            --btn-head-hover-bg: rgba(255,255,255,0.1);
            --sel-dis-clr: rgba(255,255,255,0.5);
            --chart-grid-color: var(--chart-grid-color-d);
            --chart-tick-color: var(--chart-tick-color-d);
            --chart-line-color: var(--chart-line-color-d);
            --chart-point-color: var(--chart-point-color-d);
            --chart-annotation-line: var(--chart-annotation-line-d);
            --chart-annotation-box-bg: var(--chart-annotation-box-bg-d);
        }
        html, body { height:100%; margin:0; }
        body { font-family:var(--font-body); display:flex; flex-direction:column; align-items:center; justify-content:flex-start; min-height:100%; background-color:var(--color-bg); color:var(--color-txt-prim); padding:20px; box-sizing:border-box; text-align:center; transition:background-color .4s ease-in-out, padding .3s ease-in-out, color .3s ease; position:relative; }
        .top-bar-container { display:flex; justify-content:space-between; align-items:center; width:100%; margin-bottom:15px; padding:0; position:relative; }
        body.logo-visible .top-bar-container { margin-bottom:30px; }
        body.full-screen-mode .top-bar-container { margin-bottom:0; }
        .app-header { position:relative; z-index:1000; display:flex; justify-content:flex-end; align-items:center; width:auto; padding:0; transition:all .3s ease-in-out; }
        body.full-screen-mode .app-header { position:fixed; top:15px; right:15px; z-index:1002; }
        #toggleFullScreenBtn, #toggleThemeBtn { background:transparent; border:1px solid var(--btn-head-brd); color:var(--btn-head-clr); padding:8px; border-radius:var(--brd-rad-sm); cursor:pointer; line-height:0; min-width:auto; transition:opacity .3s ease, transform .3s ease, background-color .2s ease, color .2s ease, border-color .2s ease; }
        #toggleFullScreenBtn i.feather, #toggleThemeBtn i.feather { width:1.2em; height:1.2em; stroke:currentColor !important; }
        #toggleFullScreenBtn:hover, #toggleThemeBtn:hover { background-color:var(--btn-head-hover-bg); }
        .page-main-title { font-family:var(--font-display); font-weight:700; color:var(--color-txt-prim); font-size:2.2em; letter-spacing:normal; line-height:1.1; margin:0; text-align:left; flex-grow:1; transition:color .4s ease-in-out, font-size .3s ease; }

        #userLogo { max-width:150px; max-height:80px; object-fit:contain; margin-bottom:20px; transition:all .3s ease-in-out; background-color:transparent; padding:0; border-radius:var(--brd-rad-sm); }

        .container {
            background-color:transparent;
            padding:30px 25px; border-radius:var(--brd-rad-main);
            box-shadow:none; 
            width:100%; max-width:480px;
            margin-bottom: 20px;
            transition:all .3s ease-in-out; z-index:1; position:relative; margin-top:0;
            display: flex; flex-direction: column; align-items: center;
        }

        .configuracion-section, .controls-section, .action-buttons-section, .estimated-time-section, .progress-indicators, #timerDisplaySection, #activeExerciseInfo {
            width: 100%;
            box-shadow: none; 
        }

        .configuracion-section, .estimated-time-section { margin-bottom:25px; }
        .progress-indicators { margin-bottom: 20px; }
        #timerDisplaySection { margin-bottom:25px; padding:20px 15px; border-radius:var(--brd-rad-main); margin-top:0; transition:background-color .4s ease-in-out, width .3s ease-in-out, padding .3s ease-in-out; position:relative; overflow:hidden; }
        #activeExerciseInfo { margin-bottom: 25px; }
        .controls-section { margin-bottom: 0; }

        .config-item { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; padding-bottom:12px; border-bottom:1px solid var(--color-prim-acc); transition:border-color .3s ease; }
        .config-item:last-child { border-bottom:none; margin-bottom:0; }
        .config-item label { font-weight:400; margin-right:15px; flex-basis:60%; text-align:left; color:var(--color-txt-sec); font-size:1em; word-break:break-word; transition:color .3s ease; }
        
        .config-item select,
        .config-item.user-profile-item input[type="number"],
        .config-item.user-profile-item select {
            font-family:var(--font-body);
            padding:8px 10px; 
            border-radius:var(--brd-rad-sm);
            border:1px solid var(--sel-brd);
            background-color:var(--sel-bg); 
            color:var(--color-txt-prim);
            flex-basis:35%;
            font-size:1em; /* Default font size for config items */
            transition:border-color .2s ease, background-color .3s ease, color .3s ease;
        }
         .config-item.user-profile-item input[type="number"],
         .config-item.user-profile-item select {
            font-size:0.9em; /* Slightly smaller for profile fields if needed */
         }

        .config-item select,
        .config-item.user-profile-item select { 
            appearance: none; 
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20256%20256%22%20fill%3D%22%23333%22%3E%3Cpath%20d%3D%22M215.39%2C92.61l-80%2C80a8%2C8%2C0%2C0%2C1-11.32%2C0l-80-80A8%2C8%2C0%2C1%2C1%2C55.39%2C81.39L128%2C154.06l72.61-72.67a8%2C8%2C0%2C0%2C1%2C11.32%2C11.32Z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px 16px;
            padding-right: 30px; 
        }
        body.dark-theme .config-item select,
        body.dark-theme .config-item.user-profile-item select {
             background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20256%20256%22%20fill%3D%22%23E0E0E0%22%3E%3Cpath%20d%3D%22M215.39%2C92.61l-80%2C80a8%2C8%2C0%2C0%2C1-11.32%2C0l-80-80A8%2C8%2C0%2C1%2C1%2C55.39%2C81.39L128%2C154.06l72.61-72.67a8%2C8%2C0%2C0%2C1%2C11.32%2C11.32Z%22%2F%3E%3C%2Fsvg%3E');
        }

        .config-item select:focus,
        .config-item.user-profile-item input[type="number"]:focus,
        .config-item.user-profile-item select:focus {
            border-color:var(--color-hl);
            outline:none;
            border-width: 2px;
            padding: 7px 9px; 
        }
        .config-item select:focus, 
        .config-item.user-profile-item select:focus {
            padding-right: 29px; 
        }

        .config-item select:disabled { background-color:var(--sel-dis-bg); color:var(--sel-dis-clr); opacity:.7; cursor:not-allowed; border-color:var(--color-prim-acc); background-image: none; }
        .config-item select option { background-color:color-mix(in srgb, var(--color-bg-l) 80%, #fff); color:var(--color-txt-prim-l); }
        body.dark-theme .config-item select option { background-color:color-mix(in srgb, var(--color-surf-d) 80%, #000); color: var(--color-txt-prim); }

        hr.config-divider {
            width: 100%;
            border: none;
            border-top: 1px solid var(--color-prim-acc);
            margin-top: 10px;
            margin-bottom: 20px;
        }

        .exercise-names-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
            padding-top: 0; 
        }
        .exercise-name-item { display:flex; align-items:center; gap:10px; position:relative; }
        .exercise-name-item label { font-size:.9em; color:var(--color-txt-sec); min-width:80px; text-align:right; flex-basis:auto; margin-right:5px; }
        .exercise-name-item input[type="text"] {
            flex-grow:1;
            padding:8px 10px;
            border-radius:var(--brd-rad-sm);
            border:1px solid var(--sel-brd);
            background-color:var(--sel-bg);
            color:var(--color-txt-prim);
            font-family:var(--font-body);
            font-size:.9em;
        }
        .exercise-name-item input[type="text"]:focus {
            border-color:var(--color-hl);
            outline:none;
            border-width: 2px;
            padding: 7px 9px;
        }
        .exercise-name-item input[type="text"]:disabled { background-color:var(--sel-dis-bg); color:var(--sel-dis-clr); opacity:.7; cursor:not-allowed; }
        
        .exercise-name-item input[type="text"]::placeholder { 
            color: var(--color-txt-sec);
            opacity: 1; 
        }
        .exercise-name-item input[type="text"]:-ms-input-placeholder { 
            color: var(--color-txt-sec);
        }
        .exercise-name-item input[type="text"]::-ms-input-placeholder { 
            color: var(--color-txt-sec);
        }

        .exercise-suggestions-dropdown { position: absolute; background-color: var(--color-surf); border: 1px solid var(--sel-brd); border-top: none; border-radius: 0 0 var(--brd-rad-sm) var(--brd-rad-sm); max-height: 150px; overflow-y: auto; z-index: 1050; box-shadow: var(--box-shdw-subtle); box-sizing: border-box; }
        .exercise-suggestions-dropdown div { padding: 8px 10px; cursor: pointer; font-size: 0.9em; color: var(--color-txt-prim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .exercise-suggestions-dropdown div:hover, .exercise-suggestions-dropdown div.suggestion-active { background-color: color-mix(in srgb, var(--color-hl) 20%, transparent); }


        .estimated-time-section { padding:12px 18px; background-color:var(--est-time-bg); border-radius:var(--brd-rad-sm); font-size:.95em; color:var(--color-txt-sec); margin-top:10px; transition:background-color .3s ease, color .3s ease; }
        .estimated-time-section p { margin:0; font-weight:400; }
        #estimatedTimeDisplay { font-weight:700; color:var(--color-txt-prim); transition:color .3s ease; }
        .progress-indicators { display:flex; flex-direction:column; gap:15px; align-items:center; transition:gap .3s ease, margin-bottom .3s ease, margin-top .3s ease; }
        .progress-section { display:flex; flex-direction:column; align-items:center; gap:8px; }
        .progress-label { font-size:.9em; color:var(--color-txt-sec); font-weight:700; text-transform:uppercase; letter-spacing:.5px; transition:font-size .3s ease, color .3s ease; }
        .progress-circles { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; transition:gap .3s ease; }
        .progress-circle { width:20px; height:20px; border-radius:50%; border:2px solid var(--prog-circ-brd); background-color:transparent; transition:all .3s ease; }
        .progress-circle.active { border-color:var(--prog-circ-act-brd); }
        .progress-circle.completed { background-color:var(--prog-circ-comp-bg); border-color:var(--prog-circ-comp-bg); }

        .controls-section { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; transition:width .3s ease-in-out, gap .3s ease-in-out; }
        .controls-section button { font-family:var(--font-display); font-weight:700; padding:10px 12px; font-size:.9em; background-color:transparent; border:2px solid var(--color-txt-prim); color:var(--color-txt-prim); border-radius:var(--brd-rad-sm); cursor:pointer; transition:background-color .2s ease, color .2s ease, border-color .2s ease, transform .1s ease, box-shadow .2s ease; min-width:auto; letter-spacing:.5px; text-transform:uppercase; display:inline-flex; align-items:center; justify-content:center; gap:6px; }
        .controls-section button i.feather { width:1em; height:1em; stroke-width:2.5; stroke:currentColor; transition:width .3s ease-in-out, height .3s ease-in-out; }
        .controls-section button .btn-text { display:inline-block; }
        .controls-section button:hover { transform:translateY(-1px); box-shadow:0 2px 5px color-mix(in srgb, var(--color-txt-prim) 8%, transparent); }
        .controls-section button:active { transform:translateY(0px) scale(.98); box-shadow:0 1px 3px color-mix(in srgb, var(--color-txt-prim) 5%, transparent); }
        .controls-section #startPauseResumeBtn.paused { border-color:var(--color-txt-prim); color:var(--color-txt-prim); background-color:transparent; }

        .action-buttons-section {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            width: 100%;
            margin-top: 25px;
            margin-bottom: 0;
        }
        .action-buttons-section .action-btn {
            font-family: var(--font-body); font-weight: 400; padding: 8px 10px; font-size: .75em;
            background-color: transparent; border: 1px solid var(--color-txt-sec);
            color: var(--color-txt-sec); border-radius: var(--brd-rad-sm); cursor: pointer;
            transition: background-color .2s ease, color .2s ease, border-color .2s ease, transform .1s ease;
            display: inline-flex; align-items: center; justify-content: center; gap: 5px;
            min-width: unset;
            flex: 1 1 0;
            text-align: center;
        }
        .action-buttons-section .action-btn i.feather { width: .8em; height: .8em; stroke-width: 2; stroke: currentColor; }
        .action-buttons-section .action-btn:hover { background-color: var(--btn-head-hover-bg); color: var(--color-txt-prim); border-color: var(--color-txt-prim); }
        .action-buttons-section .action-btn:active { transform: scale(.97); }

        #heartRateDisplayArea {
            margin-top: 15px;
            margin-bottom: 10px;
            padding: 8px 12px;
            font-size: 0.9em; 
            color: var(--color-txt-sec);
            background-color: var(--sel-bg);
            border: 1px solid var(--sel-brd); 
            border-radius: var(--brd-rad-sm);
            text-align: center;
            width: auto;
            max-width: 250px;
            display: inline-block;
            transition: font-size 0.3s ease, padding 0.3s ease, background-color 0.3s ease; 
        }
        #heartRateDisplayArea.connected {
            color: var(--color-txt-prim); 
        }
        #heartRateDisplayArea.workout-active { 
            font-size: 1.2em; 
            padding: 10px 15px;
             background-color: color-mix(in srgb, var(--color-surf) 50%, transparent);
        }
        #hrValue {
            font-weight: 700;
            color: var(--color-txt-prim); 
            margin-left: 5px;
        }
        body.full-screen-mode #heartRateDisplayArea {
            position: fixed;
            bottom: 10px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 1003; 
            background-color: color-mix(in srgb, var(--color-surf) 80%, transparent);
            padding: 5px 10px;
            font-size: clamp(.8em, 1.8vh, 1.1em); 
        }
        body.full-screen-mode #heartRateDisplayArea.workout-active { 
            font-size: clamp(1.2em, 3vh, 1.8em); 
            padding: 8px 12px;
        }
        
        #hrChartContainer {
            width: 100%;
            max-width: 460px; 
            height: 150px;    
            margin-top: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--sel-brd);
            border-radius: var(--brd-rad-sm);
            padding: 5px;
            box-sizing: border-box;
            position: relative; 
            background-color: var(--sel-bg); 
        }
        body.full-screen-mode #hrChartContainer {
             display: none !important; 
        }

        .active-exercise-info { display: none; justify-content: space-around; gap: 2vw; width: 100%; max-width: 700px; margin-top: 1.5vh; margin-bottom: 1.5vh; }
        .exercise-info-card { background-color: transparent; padding: 1vh 0.5vw; border-radius: var(--brd-rad-sm); flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center; min-width: 140px; max-width: 300px; }
        .exercise-info-card h3 { font-family: var(--font-body); font-size: clamp(0.9em, 2vh, 1.3em); font-weight: 700; color: var(--color-txt-prim); margin-top: 0; margin-bottom: 0.8vh; text-transform: uppercase; transition: color .3s ease; text-shadow: 0 0 4px rgba(0,0,0,0.25); }
        .exercise-info-card .exercise-image-container { width: 100%; height: clamp(70px, 12vh, 150px); display: flex; align-items: center; justify-content: center; margin-bottom: 0.8vh; background-color: transparent; border-radius: var(--brd-rad-sm); overflow: hidden;  }
        .exercise-info-card img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .exercise-info-card p { font-family: var(--font-body); font-size: clamp(1em, 2.2vh, 1.6em); font-weight: 700; color: var(--color-txt-prim); margin: 0; word-break: break-word; transition: color .3s ease; text-shadow: 0 0 4px rgba(0,0,0,0.25); line-height: 1.2; }

        .timer-display-section.bg-preparacion { background-color:var(--phase-prep); } .timer-display-section.bg-ejercicio { background-color:var(--phase-ex); } .timer-display-section.bg-descanso { background-color:var(--phase-rest); } .timer-display-section.bg-finalizado { background-color:var(--phase-end); }
        .timer-display-section.paused-overlay::before { content:""; position:absolute; top:0; left:0; right:0; bottom:0; background-color:var(--phase-paused-overlay); z-index:1; }
        #estadoActual, #cronometroActual, #cronometroTotalLabel, #cronometroTotal, .current-exercise-name { position:relative; z-index:2; transition:font-size .3s ease-in-out, margin-bottom .3s ease-in-out, color .3s ease; }

        #estadoActual:not(body.full-screen-mode #estadoActual) { font-family:var(--font-body); font-size:1.5em; font-weight:700; margin-bottom:8px; min-height:1.5em; text-transform:uppercase; letter-spacing:.5px; color:var(--color-txt-prim); }
        .current-exercise-name:not(body.full-screen-mode #currentExerciseNameDisplay) { font-family:var(--font-body); font-size:1.1em; font-weight:400; color:var(--color-txt-prim); margin-bottom:5px; min-height:1.2em; text-transform:capitalize; transition:color .3s ease, font-size .3s ease; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:block; width:100%; }

        #cronometroActual { font-family:var(--font-display); font-weight:900; font-size:clamp(5em, 28vw, 12em); margin:0 0 10px 0; line-height:1; color:var(--color-txt-prim); }
        #cronometroTotalLabel:not(body.full-screen-mode #cronometroTotalLabel) { font-family:var(--font-body); font-size:.9em; text-transform:uppercase; letter-spacing:1px; font-weight:400; margin-top:10px; color:var(--color-txt-sec); }
        #cronometroTotal:not(body.full-screen-mode #cronometroTotal) { font-family:var(--font-display); font-weight:700; font-size:1.4em; color:var(--color-txt-sec); }
        #timerDisplaySection:not([class*="bg-"]):not(body.full-screen-mode #timerDisplaySection) #estadoActual,
        #timerDisplaySection:not([class*="bg-"]):not(body.full-screen-mode #timerDisplaySection) #cronometroActual { color:var(--color-txt-prim); }
        #timerDisplaySection:not([class*="bg-"]):not(body.full-screen-mode #timerDisplaySection) #cronometroTotalLabel,
        #timerDisplaySection:not([class*="bg-"]):not(body.full-screen-mode #timerDisplaySection) #cronometroTotal { color:var(--color-txt-sec); }
        .hidden { display:none !important; }

        body.full-screen-mode { padding:0; overflow:hidden; display:flex; flex-direction:column; }
        body.full-screen-mode .page-main-title { display:none; }
        body.full-screen-mode #configuracionSection,
        body.full-screen-mode #estimatedTimeSection,
        body.full-screen-mode #exerciseNamesContainer,
        body.full-screen-mode .action-buttons-section { display:none !important; }

        body.full-screen-mode .container {
            max-width:100%; width:100%; height:100%; margin:0; border-radius:0; border:none;
            padding: 1vh 2vw;
            box-sizing:border-box;
            display:flex; flex-direction:column;
            justify-content: flex-start;
            align-items:center;
            box-shadow:none; flex-grow:1;
            margin-bottom: 0;
            padding-bottom: calc(2.5vh + 20px); 
        }
        body.full-screen-mode #userLogo {
            position:fixed; top:1vh; left:1vw;
            max-width:80px; max-height: var(--logo-h-fs);
            width:auto; height:auto; margin:0; z-index:1001;
            background-color:transparent; padding:0; box-shadow:none; border:none;
        }
        body.full-screen-mode.logo-visible .container {
            padding-top: calc(var(--logo-h-fs) + 2vh);
        }
         body.full-screen-mode:not(.logo-visible) .container {
            padding-top: 3vh;
        }

        body.full-screen-mode .progress-indicators {
            width: 80%; max-width: 500px;
            gap: 1vh;
            margin-top: 2vh;
            margin-bottom: 2vh;
        }
        body.full-screen-mode .progress-label { font-size:clamp(.7em, 1.6vh, 1em); }
        body.full-screen-mode .progress-circle { width:clamp(10px, 1.8vh, 22px); height:clamp(10px, 1.8vh, 22px); }
        body.full-screen-mode .progress-circles { gap:clamp(5px, 0.8vh, 10px); }

        body.full-screen-mode #timerDisplaySection {
            width:95%; max-width:1200px;
            display:flex; flex-direction:column;
            justify-content:center; align-items:center;
            padding:0.5vw; flex-grow: 1; flex-shrink: 1;
            min-height: 180px; margin-top:1vh; margin-bottom:1vh;
        }
        body.full-screen-mode #currentExerciseNameDisplay { display: none !important; }
        body.full-screen-mode #estadoActual { font-size:clamp(1.6em, 4.5vh, 3em); margin-bottom:0.8vh; min-height:auto; }
        body.full-screen-mode #cronometroActual {
            font-family:var(--font-display); font-weight:900;
            font-size:clamp(5.5em, 24vh, 15em);
            line-height:.85; margin-bottom:1.2vh;
        }
        body.full-screen-mode #cronometroTotalLabel { font-size:clamp(0.9em, 2vh, 1.6em); }
        body.full-screen-mode #cronometroTotal { font-size:clamp(1.3em, 3vh, 2.2em); }

        body.full-screen-mode .active-exercise-info.js-visible-by-state {
             display: flex !important;
             margin-top: 1vh; margin-bottom: 1.5vh;
        }

        body.full-screen-mode .controls-section {
            width:90%; max-width:600px;
            margin-top:1vh; margin-bottom:1vh;
            gap:10px; flex-shrink: 0;
        }
        body.full-screen-mode .controls-section button { padding:1.2vh 1.8vw; font-size:clamp(.8em, 2vh, 1.2em); gap:.8vw; flex-grow:1; }

        .app-footer {
            margin-top: auto; width: 100%;
            padding: 15px 20px;
            background-color: transparent;
            border-top: 1px solid var(--color-prim-acc);
            color: var(--color-txt-sec); font-size: .85em;
            display: flex; flex-direction: column; align-items: center;
            gap: 5px;
            transition: all .3s ease-in-out;
            position: relative; 
        }
        body.full-screen-mode .app-footer { 
            display: none; 
        }

        .app-footer .creator-info {
            margin: 0; text-align: center; width: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            gap: 3px;
        }
        .app-footer .creator-info .footer-brand-name { font-family: var(--font-display); font-size: 1em; font-weight: 700; color: var(--color-txt-prim); letter-spacing: 0.5px; margin: 0; }
        .app-footer .creator-info .footer-author-name { font-size: 0.85em; color: var(--color-txt-sec); margin: 0; }
        .app-footer .creator-info .footer-author-name .seo-name { font-weight: 700; color: var(--color-txt-prim); }

        .app-footer {
            position: relative; 
        }
        .footer-actions {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px; 
        }
        .footer-action-btn { 
            background: transparent;
            border: none;
            color: var(--color-txt-sec);
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            line-height: 0;
            transition: color .2s ease, background-color .2s ease;
        }
        .footer-action-btn:hover {
            color: var(--color-txt-prim);
            background-color: var(--btn-head-hover-bg);
        }
        .footer-action-btn i.feather {
            width: 1.3em;
            height: 1.3em;
            stroke: currentColor;
        }
        body.full-screen-mode .app-footer .footer-actions { 
            display: none;
        }
        
        .help-modal-body {
            line-height: 1.6;
            font-size: 0.95em;
            padding: 0 5px;
        }
        .help-modal-body h4 {
            font-family: var(--font-display);
            font-weight: 700;
            color: var(--color-hl);
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.15em;
            border-bottom: 1px solid var(--color-prim-acc);
            padding-bottom: 8px;
        }
        .help-modal-body ul {
            list-style-position: outside;
            padding-left: 20px;
            margin-top: 5px;
            margin-bottom: 15px;
        }
        .help-modal-body li {
            margin-bottom: 8px;
        }
        .help-modal-body p {
            margin-bottom: 15px;
        }
        .help-modal-body strong {
            font-weight: 700;
            color: var(--color-txt-prim);
        }
        .help-modal-body .brand-list {
            font-size: 0.9em;
            column-count: 2; 
            column-gap: 20px;
            margin-top: 5px;
            margin-bottom: 10px;
        }
        .help-modal-body .brand-list li {
            margin-bottom: 3px;
        }
        #hrZoneHelpInfo ul {
            padding-left: 15px; 
        }
        #hrZoneHelpInfo li {
            font-size: 0.9em;
            margin-bottom: 4px;
        }

        @media (max-width: 480px) {
            .help-modal-body .brand-list {
                column-count: 1;
            }
        }

        .modal-screen { position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,.7); display:flex; align-items:center; justify-content:center; z-index:2000; padding:20px; box-sizing:border-box; opacity:0; visibility:hidden; transition:opacity .3s ease, visibility 0s linear .3s; }
        .modal-screen:not(.hidden) { opacity:1; visibility:visible; transition:opacity .3s ease; }
        .modal-content { background-color:var(--color-surf); color:var(--color-txt-prim); padding:25px; border-radius:var(--brd-rad-main); box-shadow:var(--box-shdw-subtle); width:100%; max-width:600px; max-height:90vh; overflow-y:auto; display:flex; flex-direction:column; transition: max-width 0.3s ease, max-height 0.3s ease, padding 0.3s ease, width 0.3s ease, height 0.3s ease; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid var(--color-prim-acc); padding-bottom:15px; }
        .modal-header h2 { font-family:var(--font-display); margin:0; font-size:1.8em; flex-grow: 1; }
        .modal-header-buttons { display:flex; gap: 10px; align-items: center; }
        .modal-fs-btn, .modal-close-btn { background:transparent; border:none; color:var(--color-txt-prim); cursor:pointer; padding:5px; line-height:0; }
        .modal-fs-btn i.feather, .modal-close-btn i.feather { width:1.3em; height:1.3em; }
        #explanationScreen.modal-fullscreen-active .modal-content { max-width:100vw; max-height:100vh; width:100vw; height:100vh; border-radius:0; padding:20px; box-sizing: border-box; display:flex; flex-direction:column; }
        #explanationScreen.modal-fullscreen-active .modal-header { position: sticky; top: 0; z-index: 10; background-color: var(--color-surf); margin-bottom: 15px; }
        #explanationScreen.modal-fullscreen-active .explanation-grid { grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:30px; align-content: flex-start; flex-grow: 1; overflow-y: auto; padding-top: 5px; }
        #explanationScreen.modal-fullscreen-active .explanation-item { min-height:300px; padding:20px; justify-content:flex-start; }
        #explanationScreen.modal-fullscreen-active .explanation-item-number { font-size:3.0em; margin-bottom:15px; }
        #explanationScreen.modal-fullscreen-active .explanation-item-name { font-size:1.8em; margin-bottom:10px; }
        #explanationScreen.modal-fullscreen-active .explanation-item-description { font-size:1em; margin-bottom:15px; max-height: 100px; }
        #explanationScreen.modal-fullscreen-active .explanation-item-image-container { height:200px; margin-bottom: 15px; }
        
        .explanation-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:15px; flex-grow:1; }
        .explanation-item { background-color:var(--color-bg); color:var(--color-txt-prim); padding:15px; border-radius:var(--brd-rad-sm); border:1px solid var(--color-prim-acc); display:flex; flex-direction:column; align-items:center; text-align:center; min-height:220px; }
        .explanation-item-number { font-family:var(--font-display); font-size:2em; font-weight:700; color:var(--color-hl); margin-bottom:8px; }
        .explanation-item-name { font-family:var(--font-body); font-size:1.1em; font-weight:700; word-break:break-word; margin-bottom:5px; }
        .explanation-item-description {
            font-size: 0.85em;
            color: var(--color-txt-sec);
            line-height: 1.3;
            margin-top: 0;
            margin-bottom: 10px; 
            text-align: center; 
            max-height: 4.0em; 
            overflow-y: auto; 
            word-break: break-word;
            width: 100%; 
        }
        .explanation-item-image-container { width:100%; height:100px; display:flex; align-items:center; justify-content:center; margin-bottom:8px; background-color:transparent; border-radius: var(--brd-rad-sm); overflow: hidden; margin-top: auto; }
        .explanation-item-image { max-width:100%; max-height:100%; object-fit:contain; }

        #manageNamesList, #loadRoutineList, #historyList { list-style:none; padding:0; margin:0; flex-grow:1; overflow-y:auto; }
        #manageNamesList li, #loadRoutineList li, #historyList li { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--color-prim-acc); }
        #manageNamesList li:last-child, #loadRoutineList li:last-child, #historyList li:last-child { border-bottom:none; }
        #manageNamesList .managed-name-text, #loadRoutineList .routine-name-text { flex-grow:1; text-align:left; word-break:break-all; margin-right: 10px; }
        #manageNamesList .delete-name-btn, #loadRoutineList .routine-action-btn { background:transparent; border:1px solid var(--color-txt-sec); color:var(--color-txt-sec); border-radius:var(--brd-rad-sm); padding:5px 8px; cursor:pointer; margin-left:5px; font-size:0.8em;}
        #manageNamesList .delete-name-btn:hover, #loadRoutineList .routine-action-btn:hover { border-color:var(--phase-end); color:var(--phase-end); }
        #manageNamesList .delete-name-btn i.feather, #loadRoutineList .routine-action-btn i.feather { width:1em; height:1em; vertical-align: middle; margin-right: 3px;}
        #loadRoutineList .routine-actions { display: flex; gap: 5px; flex-shrink: 0; }
        .no-items-message { margin-top: 20px; color: var(--color-txt-sec); text-align: center;}

        #historyList li { padding: 12px 5px; gap: 10px; }
        #historyList .history-item-info { flex-grow: 1; text-align: left; font-size: 0.9em; }
        #historyList .history-item-info .session-date { font-weight: 700; color: var(--color-txt-prim); display: block; margin-bottom: 3px; }
        #historyList .history-item-info .session-details { font-size: 0.85em; color: var(--color-txt-sec); }
        #historyList .history-item-actions { display: flex; gap: 8px; flex-shrink: 0; }
        #historyList .history-action-btn { background: transparent; border: 1px solid var(--color-txt-sec); color: var(--color-txt-sec); border-radius: var(--brd-rad-sm); padding: 6px 10px; cursor: pointer; font-size: 0.75em; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 4px; }
        #historyList .history-action-btn:hover { border-color: var(--color-hl); color: var(--color-hl); background-color: var(--btn-head-hover-bg); }
        #historyList .history-action-btn i.feather { width: 0.9em; height: 0.9em; }


        #exerciseGuideList {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 10px 5px 5px 5px; 
        }

        #exerciseGuideList .explanation-item {}
        #exerciseGuideList .explanation-item-image-container {
            margin-top: 0; 
            margin-bottom: 10px; 
        }
        #exerciseGuideList .explanation-item-name {}
        #exerciseGuideList .explanation-item-description {
            margin-bottom: 0; 
        }

        /* Styles for Workout Summary Modal */
        .workout-summary-body {
            display: flex;
            flex-direction: column;
            gap: 15px;
            line-height: 1.5;
            font-size: 0.9em;
            padding: 0 5px; 
        }
        .summary-stats-top {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--color-prim-acc);
            margin-bottom: 10px;
        }
        .summary-stats-top p {
            margin: 0;
            font-size: 1em;
        }
        .summary-stats-top strong {
            color: var(--color-txt-prim);
        }

        .summary-hr-chart-container,
        .summary-pie-chart-container {
            width: 100%;
            height: 200px;
            margin-bottom: 15px;
            border: 1px solid var(--sel-brd);
            border-radius: var(--brd-rad-sm);
            padding: 10px;
            box-sizing: border-box;
            background-color: var(--sel-bg);
        }
        .summary-pie-chart-container {
            height: 250px; 
        }
        .workout-summary-body h3 {
            font-family: var(--font-display);
            font-weight: 700;
            color: var(--color-hl);
            margin-top: 10px;
            margin-bottom: 8px;
            font-size: 1.1em;
            border-bottom: 1px solid var(--color-prim-acc);
            padding-bottom: 5px;
        }
        .summary-zone-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .summary-zone-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 5px;
            border-radius: var(--brd-rad-sm);
            background-color: color-mix(in srgb, var(--color-bg) 50%, transparent);
        }
        .zone-color-indicator {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .zone-name {
            flex-grow: 1;
            font-weight: 500;
            color: var(--color-txt-prim);
        }
        .zone-time, .zone-percentage {
            font-weight: 700;
            color: var(--color-txt-sec);
            min-width: 70px; 
            text-align: right;
        }
        .zone-percentage {
            min-width: 60px;
            font-weight: normal;
        }


        @media (min-width: 769px) {
            #explanationScreen:not(.modal-fullscreen-active) .explanation-grid { grid-template-columns: repeat(3, 1fr); gap: 20px; }
            #explanationScreen:not(.modal-fullscreen-active) .modal-content { max-width: 900px; }
             .explanation-item { min-height:250px; } 
             .explanation-item-image-container { height:120px; }
             .explanation-item-description { max-height: 4.5em; }

            #exerciseGuideScreen .modal-content,
            #historyScreen .modal-content { /* Apply to history modal too */
                max-width: 900px; 
            }
            #exerciseGuideList {
                 grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
                 gap: 20px;
            }
            #workoutSummaryScreen .modal-content {
                 max-width: 700px; 
            }
        }
        @media (max-width:768px) {
            .modal-content { padding:20px; max-height:85vh; max-width: 90%;}
            #explanationScreen .modal-header-buttons #toggleExplanationFSBtn { display: none !important; }
            #explanationScreen.modal-fullscreen-active .modal-content { max-width: 100vw; max-height: 100vh; }
            #explanationScreen.modal-fullscreen-active .explanation-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
            #explanationScreen.modal-fullscreen-active .explanation-item { min-height:250px; padding:15px; }
            #explanationScreen.modal-fullscreen-active .explanation-item-number { font-size:2.5em; }
            #explanationScreen.modal-fullscreen-active .explanation-item-name { font-size:1.5em; }
            #explanationScreen.modal-fullscreen-active .explanation-item-description { font-size:0.9em; max-height: 5em; }
            #explanationScreen.modal-fullscreen-active .explanation-item-image-container { height:150px; }
            .modal-header h2 { font-size:1.5em; }
            .explanation-grid { grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px; }
            .explanation-item-number { font-size:1.8em; }
            .explanation-item-name { font-size:1em; margin-bottom: 5px; }
            #hrChartContainer { height: 120px; }
        }
        @media (max-width:600px) {
            .summary-hr-chart-container { height: 180px; }
            .summary-pie-chart-container { height: 220px; }
            .summary-zone-item { font-size: 0.9em; }
            .zone-name { flex-basis: 40%; } 
            .zone-time { min-width: 65px; }
            .zone-percentage { min-width: 55px; }
        }
        @media (max-width:480px) {
            body:not(.full-screen-mode) .controls-section button { padding:10px 12px; font-size:.85em; }
            #manageNamesList li, #loadRoutineList li, #historyList li { flex-direction: column; align-items: flex-start; gap: 8px;}
            #manageNamesList .delete-name-btn, 
            #loadRoutineList .routine-actions,
            #historyList .history-item-actions { margin-left:0; width: 100%; margin-top: 8px;}
            #loadRoutineList .routine-action-btn,
            #historyList .history-action-btn { flex-grow: 1; text-align: center; justify-content: center;}

            #explanationScreen.modal-fullscreen-active .explanation-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            #explanationScreen.modal-fullscreen-active .explanation-item { min-height:220px; }
            #explanationScreen.modal-fullscreen-active .explanation-item-description { font-size:0.85em; max-height: 4em; }
            #explanationScreen.modal-fullscreen-active .explanation-item-image-container { height:120px; }
            #explanationScreen.modal-fullscreen-active .explanation-item-name { font-size:1.2em; }

            body.full-screen-mode .active-exercise-info { gap: 2vw; flex-direction: column; max-width: 90%; margin-top:1vh; margin-bottom:1vh;}
            body.full-screen-mode .active-exercise-info .exercise-info-card { min-width: 0; max-width:100%; }
            body.full-screen-mode .active-exercise-info .exercise-info-card h3 { font-size: clamp(0.8em, 1.8vh, 1.1em); }
            body.full-screen-mode .active-exercise-info .exercise-info-card .exercise-image-container { height: clamp(60px, 10vh, 120px); }
            body.full-screen-mode .active-exercise-info .exercise-info-card p { font-size: clamp(0.9em, 2vh, 1.4em); }
            body.full-screen-mode #estadoActual { font-size:clamp(1.5em, 4vh, 2.5em); }
            body.full-screen-mode #cronometroActual { font-size:clamp(4em, 20vh, 10em); font-weight: 900; }

            #exerciseGuideList {
                 grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
            #heartRateDisplayArea { max-width: 90%; font-size: 0.8em; padding: 6px 10px;}
            #heartRateDisplayArea.workout-active { font-size: 1em; padding: 8px 12px; } 
            #hrChartContainer { height: 100px; max-width: 95%; } 
        }
        @media (max-width:420px) {
            body:not(.full-screen-mode) .container { padding:25px 20px; }
            body:not(.full-screen-mode) .controls-section button { padding:12px 18px; font-size:.95em; min-width:120px; gap:6px; }
            body:not(.full-screen-mode) .controls-section button i.feather { width:1em; height:1em; }
            #cronometroActual:not(body.full-screen-mode #cronometroActual) { font-size:clamp(4.5em, 30vw, 11em); font-weight: 900; }
            #estadoActual:not(body.full-screen-mode #estadoActual) { font-size:1.3em; }
            .current-exercise-name:not(body.full-screen-mode #currentExerciseNameDisplay) { font-size:1em; }
        }
        @media (max-width:380px) {
            body:not(.full-screen-mode) .config-item { flex-direction:column; align-items:flex-start; }
            body:not(.full-screen-mode) .config-item label { margin-bottom:8px; flex-basis:auto; width:100%; margin-right:0; }
            body:not(.full-screen-mode) .config-item select,
            body:not(.full-screen-mode) .config-item.user-profile-item input[type="number"],
            body:not(.full-screen-mode) .config-item.user-profile-item select { width:100%; flex-basis:auto; }

            body:not(.full-screen-mode) .exercise-name-item { flex-direction:column; align-items:flex-start; }
            body:not(.full-screen-mode) .exercise-name-item label { text-align:left; margin-bottom:5px; }
            body:not(.full-screen-mode) .exercise-name-item input[type="text"] { width:100%; }
            body:not(.full-screen-mode) .controls-section { flex-direction:column; align-items:stretch; gap:8px; }
            body:not(.full-screen-mode) .controls-section button { width:100%; }
            body:not(.full-screen-mode) .page-main-title { font-size:1.6em; }
            .action-buttons-section .action-btn {
                flex-basis: calc(50% - 4px);
            }
            .explanation-item { min-height:200px; }
            .explanation-item-image-container { height:80px; }
            .summary-zone-item { flex-wrap: wrap; } 
            .zone-name { flex-basis: 100%; margin-bottom: 3px; }
            .zone-time, .zone-percentage { flex-basis: 45%; text-align: left; }

        }
        @media (max-width:360px) {
            body:not(.full-screen-mode) .container { padding:20px 15px; }
            #cronometroActual:not(body.full-screen-mode #cronometroActual) { font-size:clamp(4em, 32vw, 10em); font-weight: 900; }
            #estadoActual:not(body.full-screen-mode #estadoActual) { font-size:1.2em; }
            .current-exercise-name:not(body.full-screen-mode #currentExerciseNameDisplay) { font-size:.9em; }
            body:not(.full-screen-mode) .page-main-title { font-size:1.5em; }
        }

        @media (orientation:landscape) and (max-height:550px) and (min-width:568px) {
            body.full-screen-mode .container { padding: 0.5vh 1vw; justify-content: space-around; gap: 0.2vh; padding-bottom: calc(2vh + 15px); }
            body.full-screen-mode.logo-visible .container { padding-top: calc(var(--logo-h-fs, 40px) + 0.5vh); }
            body.full-screen-mode #userLogo { max-width:70px !important; --logo-h-fs:35px !important; top:0.5vh !important; left:0.5vw !important; }
            body.full-screen-mode .progress-indicators { flex-direction:row; justify-content:center; align-items:center; gap:10px; margin-bottom:0.3vh !important; margin-top: 0.8vh !important; width: 95%; max-width: none; }
            body.full-screen-mode .progress-section { gap:4px; }
            body.full-screen-mode .progress-label { font-size:clamp(.5em, 1.3vh, .8em) !important; }
            body.full-screen-mode .progress-circle { width:clamp(8px, 1.5vh, 13px) !important; height:clamp(8px, 1.5vh, 13px) !important; }
            body.full-screen-mode #timerDisplaySection { padding:0.3vh 0.3vw !important; margin-bottom:0.3vh !important; min-height: auto; flex-grow:1; }
            body.full-screen-mode #estadoActual { font-size:clamp(1.1em, 2.5vh, 1.7em) !important; margin-bottom:.2vh !important; }
            body.full-screen-mode #cronometroActual { font-size:clamp(3.5em, 16vh, 8em) !important; line-height:.8 !important; margin-bottom:0.3vh !important; font-weight: 900; }
            body.full-screen-mode #cronometroTotalLabel { font-size:clamp(.5em, 1.4vh, .8em) !important; margin-top:0 !important; }
            body.full-screen-mode #cronometroTotal { font-size:clamp(.8em, 2vh, 1.2em) !important; }
            body.full-screen-mode .active-exercise-info { gap: 1vw; margin-top: 0.3vh; margin-bottom: 0.3vh; flex-direction: row; max-width: 550px; }
            body.full-screen-mode .active-exercise-info .exercise-info-card { padding: 0.3vh; }
            body.full-screen-mode .active-exercise-info .exercise-info-card h3 { font-size: clamp(0.6em, 1.4vh, .9em); margin-bottom: 0.2vh;}
            body.full-screen-mode .active-exercise-info .exercise-info-card .exercise-image-container { height: clamp(40px, 7vh, 80px); margin-bottom: 0.2vh;}
            body.full-screen-mode .active-exercise-info .exercise-info-card p { font-size: clamp(0.7em, 1.6vh, 1.1em); }
            body.full-screen-mode .controls-section { width:90%; max-width:450px; margin-top:0.3vh !important; margin-bottom:0.3vh !important; gap:5px; }
            body.full-screen-mode .controls-section button { font-size:clamp(.7em, 1.6vh, 1em) !important; padding:0.6vh 1vw !important; }

            body:not(.full-screen-mode) .top-bar-container { display:flex; justify-content:space-between; align-items:center; }
            body:not(.full-screen-mode).logo-visible .top-bar-container { margin-bottom:20px; }
            body:not(.full-screen-mode) .page-main-title { font-size:1.8em; margin-bottom:0; }
            body:not(.full-screen-mode) .container { max-width:90vw; padding-left:15px; padding-right:15px; margin-top:0; }
            body.full-screen-mode #heartRateDisplayArea {
                bottom: 5px;
                padding: 3px 8px;
                font-size: clamp(.6em, 1.5vh, .9em);
            }
            body.full-screen-mode #heartRateDisplayArea.workout-active { 
                font-size: clamp(1em, 2.5vh, 1.5em); 
            }
        }
    </style>
</head>
<body>
    <div class="top-bar-container">
        <h1 class="page-main-title">Chrono HIIT</h1>
        <div class="app-header">
            <div class="header-actions">
                <button id="toggleThemeBtn" title="Cambiar Tema"><i data-feather="moon"></i></button>
                <button id="toggleFullScreenBtn" title="Modo Pantalla Completa"><i data-feather="maximize"></i></button>
            </div>
        </div>
    </div>
    <img id="userLogo" src="#" alt="Logo" class="hidden">
    <div class="container">
        <div id="configuracionSection" class="configuracion-section">
            <div class="config-item user-profile-item">
                <label for="userAge">Edad (años):</label>
                <input type="number" id="userAge" min="10" max="120" step="1" placeholder="Ej: 30">
            </div>
            <div class="config-item user-profile-item">
                <label for="userWeight">Peso (kg, opcional):</label>
                <input type="number" id="userWeight" min="20" max="300" step="0.1" placeholder="Ej: 70.5">
            </div>
            <div class="config-item user-profile-item">
                <label for="userGender">Género (opcional):</label>
                <select id="userGender">
                    <option value="">Prefiero no decirlo</option>
                    <option value="male">Masculino</option>
                    <option value="female">Femenino</option>
                    <option value="other">Otro</option>
                </select>
            </div>
            <hr class="config-divider">

            <div class="config-item"><label for="numEjercicios">Ejercicios / Serie:</label><select id="numEjercicios"></select></div>
            <div id="exerciseNamesContainer" class="exercise-names-section hidden"></div>
            <div class="config-item"><label for="numSeries">Series Totales:</label><select id="numSeries"></select></div>
            <div class="config-item"><label for="tiempoEjercicio">T. Ejercicio (s):</label><select id="tiempoEjercicio"></select></div>
            <div class="config-item"><label for="descansoEjercicio">T. Desc. Ej. (s):</label><select id="descansoEjercicio"></select></div>
            <div class="config-item"><label for="descansoSerie">T. Desc. Serie (s):</label><select id="descansoSerie"></select></div>
        </div>
        <div id="estimatedTimeSection" class="estimated-time-section"><p>Duración Estimada: <span id="estimatedTimeDisplay">00:00:00</span></p></div>

        <div class="progress-indicators">
           <div class="progress-section"><span class="progress-label">Ejercicio Actual:</span><div id="exerciseProgress" class="progress-circles"></div></div>
           <div class="progress-section"><span class="progress-label">Serie Actual:</span><div id="seriesProgress" class="progress-circles"></div></div>
        </div>

        <div id="timerDisplaySection" class="timer-display-section hidden">
            <div id="estadoActual">Preparado</div>
            <div id="currentExerciseNameDisplay" class="current-exercise-name hidden"></div>
            <div id="cronometroActual">00:00</div>
            <div id="cronometroTotalLabel">Tiempo Total Acumulado</div><div id="cronometroTotal">00:00:00</div>
        </div>

        <div id="activeExerciseInfo" class="active-exercise-info">
            <div class="exercise-info-card current-exercise-card">
                <h3 id="currentExerciseCardTitle">Ejercicio Actual</h3>
                <div class="exercise-image-container">
                    <img id="currentExerciseImage" src="images/generic.webp" alt="Ejercicio actual">
                </div>
                <p id="currentExerciseCardName">Nombre del Ejercicio</p>
            </div>
            <div class="exercise-info-card next-exercise-card">
                <h3>Siguiente Ejercicio</h3>
                 <div class="exercise-image-container">
                    <img id="nextExerciseImage" src="images/generic.webp" alt="Siguiente ejercicio">
                </div>
                <p id="nextExerciseCardName">Nombre del Siguiente Ejercicio</p>
            </div>
        </div>

         <div class="controls-section button-group">
            <button id="startPauseResumeBtn"><i data-feather="play"></i><span class="btn-text">Iniciar</span></button>
            <button id="restartExerciseBtn" class="hidden"><i data-feather="rewind"></i><span class="btn-text">Reiniciar Ej.</span></button>
            <button id="finishBtn" class="hidden"><i data-feather="x-circle"></i><span class="btn-text">Finalizar</span></button>
        </div>

        <div class="action-buttons-section">
            <input type="file" id="logoUploadInput" accept="image/png, image/jpeg" class="hidden">
            <button id="uploadLogoBtn" class="action-btn" title="Subir Logo"><i data-feather="upload"></i><span class="btn-text">Subir Logo</span></button>
            <button id="removeLogoBtn" class="action-btn hidden" title="Quitar Logo"><i data-feather="trash-2"></i><span class="btn-text">Quitar Logo</span></button>
            <button id="exportSettingsBtn" class="action-btn" title="Exportar Configuración"><i data-feather="download"></i><span class="btn-text">Exportar</span></button>
            <input type="file" id="importSettingsInput" accept=".json" class="hidden">
            <button id="importSettingsBtn" class="action-btn" title="Importar Configuración"><i data-feather="upload-cloud"></i><span class="btn-text">Importar</span></button>
            <button id="saveRoutineBtn" class="action-btn" title="Guardar Rutina Actual"><i data-feather="save"></i><span class="btn-text">Guardar Rutina</span></button>
            <button id="loadRoutineBtn" class="action-btn" title="Cargar Rutina Guardada"><i data-feather="folder"></i><span class="btn-text">Cargar Rutinas</span></button>
            <button id="manageNamesBtn" class="action-btn" title="Gestionar Nombres Guardados"><i data-feather="edit-3"></i><span class="btn-text">Nombres</span></button>
            <button id="showExplanationBtn" class="action-btn" title="Mostrar Explicación de Ejercicios"><i data-feather="layout"></i><span class="btn-text">Ver Ej.</span></button>
            <button id="connectHrDeviceBtn" class="action-btn" title="Conectar Pulsera Cardíaca"><i data-feather="bluetooth"></i><span class="btn-text">Pulsera</span></button>
        </div>

        <div id="heartRateDisplayArea" class="hidden">
            Ritmo Cardíaco: <span id="hrValue">-</span> bpm
        </div>
        
        <div id="hrChartContainer" class="hidden">
            <canvas id="hrChart"></canvas>
        </div>

    </div>

    <footer class="app-footer">
        <div class="creator-info">
            <p class="footer-brand-name">HIIT.ES</p>
            <p class="footer-author-name">Creado por <span class="seo-name">Enrique Gil</span></p>
        </div>
        <div class="footer-actions">
            <button id="openHistoryBtn" class="footer-action-btn" title="Historial de Sesiones">
                <i data-feather="activity"></i>
            </button>
            <button id="openExerciseGuideBtn" class="footer-action-btn" title="Guía de Ejercicios Disponibles">
                <i data-feather="book-open"></i>
            </button>
            <button id="openHelpModalBtn" class="footer-action-btn" title="Ayuda e Información del Programa">
                <i data-feather="help-circle"></i>
            </button>
        </div>
    </footer>

    <div id="explanationScreen" class="modal-screen hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Vista de Ejercicios</h2>
                <div class="modal-header-buttons">
                    <button id="toggleExplanationFSBtn" class="modal-fs-btn" title="Maximizar Vista"><i data-feather="maximize-2"></i></button>
                    <button id="closeExplanationBtn" class="modal-close-btn" title="Cerrar"><i data-feather="x"></i></button>
                </div>
            </div>
            <div id="explanationGrid" class="explanation-grid"></div>
        </div>
    </div>

    <div id="manageNamesScreen" class="modal-screen hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Gestionar Nombres Guardados</h2>
                 <div class="modal-header-buttons">
                    <button id="closeManageNamesBtn" class="modal-close-btn" title="Cerrar"><i data-feather="x"></i></button>
                </div>
            </div>
            <ul id="manageNamesList"></ul>
            <p id="noNamesMessage" class="no-items-message hidden">No hay nombres de ejercicios guardados.</p>
        </div>
    </div>

    <div id="loadRoutineScreen" class="modal-screen hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cargar Rutina Guardada</h2>
                <div class="modal-header-buttons">
                    <button id="closeLoadRoutineBtn" class="modal-close-btn" title="Cerrar"><i data-feather="x"></i></button>
                </div>
            </div>
            <ul id="loadRoutineList"></ul>
            <p id="noRoutinesMessage" class="no-items-message hidden">No hay rutinas guardadas.</p>
        </div>
    </div>

    <div id="helpModalScreen" class="modal-screen hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ayuda Chrono HIIT</h2>
                <div class="modal-header-buttons">
                    <button id="closeHelpModalBtn" class="modal-close-btn" title="Cerrar">
                        <i data-feather="x"></i>
                    </button>
                </div>
            </div>
            <div class="help-modal-body">
                <p><strong>Bienvenido a Chrono HIIT</strong><br>
                Un cronómetro de intervalos avanzado para tus entrenamientos. Estas son sus funciones principales:</p>

                <h4>Configuración Principal:</h4>
                <ul>
                    <li><strong>Edad, Peso, Género:</strong> Introduce tus datos para personalizar el cálculo de zonas cardíacas (la edad es el principal factor usado actualmente).</li>
                    <li><strong>Ejercicios / Serie:</strong> Define cuántos ejercicios diferentes componen una serie.</li>
                    <li><strong>Series Totales:</strong> Establece el número total de series para tu rutina.</li>
                    <li><strong>T. Ejercicio (s):</strong> Duración en segundos de cada fase de ejercicio.</li>
                    <li><strong>T. Desc. Ej. (s):</strong> Duración del descanso entre ejercicios dentro de una misma serie.</li>
                    <li><strong>T. Desc. Serie (s):</strong> Duración del descanso al finalizar una serie completa.</li>
                </ul>

                <h4>Nombres de Ejercicios:</h4>
                <p>Puedes asignar nombres personalizados a tus ejercicios. El sistema ofrece sugerencias de ejercicios predefinidos (con imágenes) o nombres que hayas usado antes. Estos nombres se mostrarán durante el entrenamiento.</p>

                <h4>Controles del Cronómetro:</h4>
                <ul>
                    <li><strong>Iniciar/Pausar/Reanudar:</strong> Controla el flujo del entrenamiento.</li>
                    <li><strong>Reiniciar Ej.:</strong> (Aparece durante un ejercicio) Vuelve a empezar el ejercicio actual con una breve preparación.</li>
                    <li><strong>Finalizar:</strong> Detiene el entrenamiento y resetea la configuración. Si hay datos de ritmo cardíaco, se mostrará un resumen de la sesión.</li>
                </ul>

                <h4>Funciones Adicionales:</h4>
                <ul>
                    <li><strong>Tema (Sol/Luna):</strong> Cambia entre tema claro y oscuro.</li>
                    <li><strong>Pantalla Completa:</strong> Visualización sin distracciones durante el ejercicio.</li>
                    <li><strong>Subir/Quitar Logo:</strong> Personaliza la interfaz con tu propio logo (se guarda localmente).</li>
                    <li><strong>Exportar/Importar:</strong> Guarda tu configuración actual (tiempos, nombres, tema, logo) en un archivo JSON, o carga una configuración previamente guardada.</li>
                    <li><strong>Guardar/Cargar Rutina:</strong> Guarda la configuración actual como una rutina con nombre para acceder rápidamente a ella más tarde.</li>
                    <li><strong>Nombres:</strong> Gestiona la lista de nombres de ejercicios personalizados que has guardado.</li>
                    <li><strong>Ver Ej.:</strong> Muestra una vista con imágenes y descripciones (si están disponibles) de los ejercicios configurados para la rutina actual.</li>
                    <li><strong>Pulsera (Bluetooth):</strong> Conecta una pulsera de ritmo cardíaco compatible para ver tus pulsaciones y una gráfica en tiempo real. Al finalizar, se mostrará un resumen con el tiempo en cada zona cardíaca (personalizadas si has introducido tu edad) y se guardará la sesión (si hay datos).</li>
                    <li><strong>Historial (Icono de actividad):</strong> Accede a un listado de tus sesiones de entrenamiento guardadas para revisar tu progreso.</li>
                </ul>
                <div id="hrZoneHelpInfo">
                    <!-- Esta sección se poblará dinámicamente con la info de zonas -->
                </div>
                <h4>Conexión de Pulsera Cardíaca (Bluetooth):</h4>
                <ul>
                    <li><strong>Compatibilidad:</strong> Esta función permite conectar pulseras o monitores de ritmo cardíaco que utilicen <strong>Bluetooth Low Energy (BLE)</strong> y expongan el servicio estándar de "Ritmo Cardíaco" (Heart Rate Service).</li>
                    <li><strong>Marcas y Modelos Comprobados/Sugeridos:</strong>
                        <ul class="brand-list">
                            <li>COOSPO (HW6, HW807, HW9)</li>
                            <li>COROS (Pace 3, Heart Rate Monitor)</li>
                            <li>Decathlon (Kalenji HRB 500, Kiprun GPS 500)</li>
                            <li>Fitbit (Charge 6)</li>
                            <li>Garmin (Vivosmart 5, Fenix 7, HRM-Dual)</li>
                            <li>Huawei (Band 8)</li>
                            <li>Magene (H303)</li>
                            <li>Polar (H10, Verity Sense, Vantage V3)</li>
                            <li>Scosche (Rhythm+ 2.0)</li>
                            <li>Sigma (R1 Duo)</li>
                            <li>Suunto (Smart Sensor, Vertical)</li>
                            <li>Wahoo (TICKR FIT, TICKR X, ELEMNT RIVAL)</li>
                            <li>Xiaomi (Smart Band 8)</li>
                            <li>Y otros modelos BLE compatibles...</li>
                        </ul>
                    </li>
                    <li><strong>Importante:</strong> Antes de adquirir un nuevo dispositivo, o si ya dispones de uno, te recomendamos consultar sus instrucciones o ficha técnica para comprobar que dispone de conectividad BLE y, sobre todo, aprender cómo activar correctamente el modo de transmisión por Bluetooth, ya que en muchos casos no está habilitado de forma predeterminada.</li>
                    <li><strong>Navegador:</strong> La API Web Bluetooth es necesaria. Funciona mejor en Chrome (escritorio y Android), Edge y Opera. No está disponible en iOS (iPhone/iPad) ni Firefox por defecto. Asegúrate de que tu web se sirva por HTTPS (o localhost para desarrollo).</li>
                    <li><strong>Proceso:</strong>
                        <ol>
                            <li>Asegúrate de que el Bluetooth de tu ordenador/móvil esté activado y tu pulsera visible/emparejable.</li>
                            <li>Haz clic en el botón "Pulsera" (<i data-feather="bluetooth" style="width:1em; height:1em; vertical-align:middle;"></i>) en la sección de acciones.</li>
                            <li>El navegador mostrará un diálogo para seleccionar tu dispositivo. Elige tu pulsera y conéctate.</li>
                            <li>Una vez conectada, el área de "Ritmo Cardíaco" mostrará tus pulsaciones por minuto (BPM) y aparecerá una gráfica debajo mostrando la evolución. El botón "Pulsera" cambiará para permitir la desconexión.</li>
                        </ol>
                    </li>
                    <li><strong>Visualización:</strong> El ritmo cardíaco se mostrará de forma más prominente durante el entrenamiento activo. La gráfica muestra los últimos minutos de datos, con el punto más reciente destacado.</li>
                </ul>


                <h4>Durante el Entrenamiento:</h4>
                <ul>
                    <li><strong>Indicadores de Progreso:</strong> Círculos visuales te muestran el ejercicio y la serie actual.</li>
                    <li><strong>Pantalla de Tiempo:</strong> Muestra la fase actual (Preparación, Ejercicio, Descanso), el tiempo restante de la fase y el tiempo total acumulado.</li>
                    <li><strong>Información de Ejercicio (Pantalla Completa):</strong> En modo pantalla completa, verás el ejercicio actual y el siguiente, junto con sus imágenes si están disponibles.</li>
                    <li><strong>Alertas Sonoras:</strong> Sonidos te avisarán de los cambios de fase y puntos intermedios.</li>
                    <li><strong>Ritmo Cardíaco:</strong> Si una pulsera está conectada, se mostrarán tus pulsaciones por minuto (BPM) y una gráfica de tu ritmo cardíaco. Al finalizar el entrenamiento, si se recogieron datos de HR, se mostrará un modal con el resumen de la sesión (incluyendo tiempo en zonas cardíacas y gráficas) y la sesión se guardará para consulta futura.</li>
                </ul>
                 <p>¡Disfruta de tus entrenamientos con Chrono HIIT!</p>
            </div>
        </div>
    </div>

    <div id="exerciseGuideScreen" class="modal-screen hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Guía de Ejercicios</h2>
                <div class="modal-header-buttons">
                    <button id="closeExerciseGuideBtn" class="modal-close-btn" title="Cerrar">
                        <i data-feather="x"></i>
                    </button>
                </div>
            </div>
            <div id="exerciseGuideList" class="exercise-guide-list">
            </div>
            <p id="noPredefinedExercisesMessage" class="no-items-message hidden">
                No hay ejercicios predefinidos cargados.
            </p>
        </div>
    </div>

    <div id="workoutSummaryScreen" class="modal-screen hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Resumen del Ejercicio</h2>
                <div class="modal-header-buttons">
                    <button id="closeWorkoutSummaryBtn" class="modal-close-btn" title="Cerrar"><i data-feather="x"></i></button>
                </div>
            </div>
            <div class="workout-summary-body">
                <div class="summary-stats-top">
                    <p><strong>Tiempo Total:</strong> <span id="summaryTotalTime">00:00:00</span></p>
                    <p><strong>Máx. BPM:</strong> <span id="summaryMaxHr">-</span></p>
                </div>
                <div id="summaryHrChartContainerParent" class="summary-hr-chart-container">
                    <canvas id="summaryHrChartCanvas"></canvas>
                </div>
                <h3>Tiempo en Zonas Cardíacas:</h3>
                <div id="summaryZoneStatsContainer" class="summary-zone-stats">
                    <!-- Zone stats will be populated here -->
                </div>
                <div id="summaryZonePieChartContainerParent" class="summary-pie-chart-container">
                    <canvas id="summaryZonePieChartCanvas"></canvas>
                </div>
                <p id="noSummaryDataMessage" class="no-items-message hidden">No hay datos de ritmo cardíaco para mostrar en el resumen.</p>
            </div>
        </div>
    </div>

    <div id="historyScreen" class="modal-screen hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Historial de Sesiones</h2>
                <div class="modal-header-buttons">
                    <button id="closeHistoryBtn" class="modal-close-btn" title="Cerrar"><i data-feather="x"></i></button>
                </div>
            </div>
            <ul id="historyList"></ul>
            <p id="noHistoryMessage" class="no-items-message hidden">No hay sesiones guardadas en el historial.</p>
        </div>
    </div>


    <script>
        // Chart.register(ChartAnnotation); // No es necesario registrar explícitamente si se carga después de Chart.js

        let predefinedExercises = {};
        const DEFAULT_APP_LOGO_PATH = 'icons/android-icon-192x192.png';

        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            if (lines.length < 2) return {};
            const headers = lines[0].split(',').map(header => header.trim());
            const data = {};
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === "") continue;
                const values = [];
                let currentLine = lines[i];
                let inQuotes = false;
                let currentValue = '';
                let charIndex = 0;
                while(charIndex < currentLine.length) {
                    let char = currentLine[charIndex];
                    if (char === '"') {
                        if (inQuotes && charIndex + 1 < currentLine.length && currentLine[charIndex + 1] === '"') {
                            currentValue += '"'; charIndex++;
                        } else { inQuotes = !inQuotes; }
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentValue); currentValue = '';
                    } else { currentValue += char; }
                    charIndex++;
                }
                values.push(currentValue);
                if (values.length === headers.length) {
                    const entry = {};
                    let exerciseNameKey = "";
                    headers.forEach((header, index) => {
                        let value = values[index].trim();
                        if (value.startsWith('"') && value.endsWith('"')) {
                            if (!value.startsWith('""') && !value.endsWith('""') || value.length === 2) {
                               value = value.substring(1, value.length - 1);
                            }
                        }
                        if (header === "NombreEjercicio") exerciseNameKey = value;
                        else if (header === "URLImagen") entry.image = value;
                        else if (header === "Descripcion") entry.description = value;
                    });
                    if (exerciseNameKey && typeof entry.image !== 'undefined' && typeof entry.description !== 'undefined') {
                        data[exerciseNameKey] = entry;
                    } else { console.warn("Línea de CSV omitida (datos incompletos/malformados):", lines[i], entry, exerciseNameKey); }
                } else { console.warn("Línea de CSV omitida (campos incorrectos):", lines[i]); }
            }
            return data;
        }

        async function loadPredefinedExercisesFromCSV() {
            try {
                const response = await fetch('predefined_exercises.csv?v=' + new Date().getTime());
                if (!response.ok) throw new Error(`Error CSV: ${response.status} ${response.statusText}`);
                const csvText = await response.text();
                predefinedExercises = parseCSV(csvText);
                console.log("Ejercicios CSV cargados:", Object.keys(predefinedExercises).length);
                if (Object.keys(predefinedExercises).length === 0 && csvText.trim() !== "") {
                    console.error("CSV con contenido pero parseo 0 ejercicios.");
                }
            } catch (error) {
                console.error("Fallo carga CSV ejercicios:", error);
                predefinedExercises = {
                     "Flexiones (Fallback)": { image: "images/flexiones_suelo.webp", description: "Pecho, hombros, tríceps." },
                     "Sentadillas (Fallback)": { image: "images/sentadillas_saco.webp", description: "Piernas." }
                };
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const getEl = id => document.getElementById(id);
            const qS = sel => document.querySelector(sel);

            await loadPredefinedExercisesFromCSV();

            const userAgeInput = getEl('userAge');
            const userWeightInput = getEl('userWeight');
            const userGenderSelect = getEl('userGender');

            const numEjSel = getEl('numEjercicios'), numSerSel = getEl('numSeries'), tEjSel = getEl('tiempoEjercicio'), dEjSel = getEl('descansoEjercicio'), dSerSel = getEl('descansoSerie');
            const allSels = [numEjSel, numSerSel, tEjSel, dEjSel, dSerSel];
            const startBtn = getEl('startPauseResumeBtn'), finishBtn = getEl('finishBtn'), restartEjBtn = getEl('restartExerciseBtn'), fsBtn = getEl('toggleFullScreenBtn'), themeBtn = getEl('toggleThemeBtn'), cfgSec = getEl('configuracionSection'), estTimeEl = getEl('estimatedTimeSection'), estTimeDispEl = getEl('estimatedTimeDisplay'), timerDispSec = getEl('timerDisplaySection'), estadoEl = getEl('estadoActual'), cronoActEl = getEl('cronometroActual'), cronoTotalEl = getEl('cronometroTotal'), ejProgEl = getEl('exerciseProgress'), serProgEl = getEl('seriesProgress'), bodyEl = document.body, contEl = qS('.container'), ejNamesContEl = getEl('exerciseNamesContainer'), curEjNameDispEl = getEl('currentExerciseNameDisplay'), logoEl = getEl('userLogo'), logoUploadIn = getEl('logoUploadInput'), uploadLogoBtn = getEl('uploadLogoBtn'), remLogoBtn = getEl('removeLogoBtn'), exportBtn = getEl('exportSettingsBtn'), importIn = getEl('importSettingsInput'), importBtn = getEl('importSettingsBtn'), progIndEl = qS('.progress-indicators');
            const showExplBtn = getEl('showExplanationBtn'), explScreenEl = getEl('explanationScreen'), closeExplBtn = getEl('closeExplanationBtn'), explGridEl = getEl('explanationGrid'), toggleExplFSBtn = getEl('toggleExplanationFSBtn');
            const manageNamesBtn = getEl('manageNamesBtn'), manageNamesScreenEl = getEl('manageNamesScreen'), closeManageNamesBtn = getEl('closeManageNamesBtn'), manageNamesListEl = getEl('manageNamesList'), noNamesMsgEl = getEl('noNamesMessage');
            const saveRoutineBtn = getEl('saveRoutineBtn'), loadRoutineBtn = getEl('loadRoutineBtn'), loadRoutineScreenEl = getEl('loadRoutineScreen'), closeLoadRoutineBtn = getEl('closeLoadRoutineBtn'), loadRoutineListEl = getEl('loadRoutineList'), noRoutinesMsgEl = getEl('noRoutinesMessage');
            const activeExerciseInfoEl = getEl('activeExerciseInfo'), currentExerciseImageEl = getEl('currentExerciseImage'), currentExerciseCardNameEl = getEl('currentExerciseCardName'), currentExerciseCardTitleEl = getEl('currentExerciseCardTitle'), nextExerciseImageEl = getEl('nextExerciseImage'), nextExerciseCardNameEl = getEl('nextExerciseCardName'), nextExerciseCardEl = activeExerciseInfoEl ? activeExerciseInfoEl.querySelector('.next-exercise-card') : null;
            const actionButtonsSection = qS('.action-buttons-section');
            
            const openHelpModalBtn = getEl('openHelpModalBtn'), 
                  helpModalScreenEl = getEl('helpModalScreen'), 
                  closeHelpModalBtn = getEl('closeHelpModalBtn');

            const openExerciseGuideBtn = getEl('openExerciseGuideBtn'),
                  exerciseGuideScreenEl = getEl('exerciseGuideScreen'),
                  closeExerciseGuideBtn = getEl('closeExerciseGuideBtn'),
                  exerciseGuideListEl = getEl('exerciseGuideList'),
                  noPredefinedExercisesMessageEl = getEl('noPredefinedExercisesMessage');

            const connectHrDeviceBtn = getEl('connectHrDeviceBtn');
            const heartRateDisplayAreaEl = getEl('heartRateDisplayArea');
            const hrValueEl = getEl('hrValue');
            const hrChartContainerEl = getEl('hrChartContainer');
            const hrChartCanvasEl = getEl('hrChart');

            const workoutSummaryScreenEl = getEl('workoutSummaryScreen');
            const closeWorkoutSummaryBtn = getEl('closeWorkoutSummaryBtn');
            const summaryTotalTimeEl = getEl('summaryTotalTime');
            const summaryMaxHrEl = getEl('summaryMaxHr');
            const summaryHrChartCanvasEl = getEl('summaryHrChartCanvas');
            const summaryHrChartContainerParentEl = getEl('summaryHrChartContainerParent');
            const summaryZoneStatsContainerEl = getEl('summaryZoneStatsContainer');
            const summaryZonePieChartCanvasEl = getEl('summaryZonePieChartCanvas');
            const summaryZonePieChartContainerParentEl = getEl('summaryZonePieChartContainerParent');
            const noSummaryDataMessageEl = getEl('noSummaryDataMessage');
            let summaryHrChartInstance = null;
            let summaryZonePieChartInstance = null;

            const openHistoryBtn = getEl('openHistoryBtn');
            const historyScreenEl = getEl('historyScreen');
            const closeHistoryBtn = getEl('closeHistoryBtn');
            const historyListEl = getEl('historyList');
            const noHistoryMessageEl = getEl('noHistoryMessage');


            let rootSt = getComputedStyle(document.documentElement), phaseColors = {};
            function updPhaseColors() { 
                rootSt = getComputedStyle(document.documentElement); 
                phaseColors = { 
                    preparacion: rootSt.getPropertyValue('--phase-prep').trim(), 
                    ejercicio: rootSt.getPropertyValue('--phase-ex').trim(), 
                    descanso: rootSt.getPropertyValue('--phase-rest').trim(), 
                    descanso_ejercicio: rootSt.getPropertyValue('--phase-rest').trim(), 
                    descanso_serie: rootSt.getPropertyValue('--phase-rest').trim(), 
                    finalizado: rootSt.getPropertyValue('--phase-end').trim() 
                };
                if (hrChartInstance) {
                    const newGridColor = rootSt.getPropertyValue('--chart-grid-color').trim();
                    const newTickColor = rootSt.getPropertyValue('--chart-tick-color').trim();
                    const newLineColor = rootSt.getPropertyValue('--chart-line-color').trim();
                    const newPointColor = rootSt.getPropertyValue('--chart-point-color').trim();
                    const newAnnotationBoxBg = rootSt.getPropertyValue('--chart-annotation-box-bg').trim();

                    hrChartInstance.options.scales.x.grid.color = newGridColor;
                    hrChartInstance.options.scales.y.grid.color = newGridColor;
                    hrChartInstance.options.scales.x.ticks.color = newTickColor;
                    hrChartInstance.options.scales.y.ticks.color = newTickColor;
                    hrChartInstance.data.datasets[0].borderColor = newLineColor;
                    hrChartInstance.data.datasets[0].pointBackgroundColor = newPointColor;
                    hrChartInstance.data.datasets[0].pointBorderColor = newPointColor; 

                    if (hrChartInstance.options.plugins.annotation && hrChartInstance.options.plugins.annotation.annotations.nowBox) {
                        hrChartInstance.options.plugins.annotation.annotations.nowBox.backgroundColor = newAnnotationBoxBg;
                    }
                    hrChartInstance.update('none'); 
                }
                if (summaryHrChartInstance) {
                    summaryHrChartInstance.options.scales.x.ticks.color = rootSt.getPropertyValue('--chart-tick-color').trim();
                    summaryHrChartInstance.options.scales.y.ticks.color = rootSt.getPropertyValue('--chart-tick-color').trim();
                    summaryHrChartInstance.options.scales.x.grid.color = rootSt.getPropertyValue('--chart-grid-color').trim();
                    summaryHrChartInstance.options.scales.y.grid.color = rootSt.getPropertyValue('--chart-grid-color').trim();
                    summaryHrChartInstance.data.datasets[0].borderColor = rootSt.getPropertyValue('--chart-line-color').trim();
                    summaryHrChartInstance.data.datasets[0].backgroundColor = rootSt.getPropertyValue('--chart-line-color').trim().replace(')', ', 0.3)').replace('rgb', 'rgba');
                    summaryHrChartInstance.update('none');
                }
                if (summaryZonePieChartInstance) {
                    summaryZonePieChartInstance.options.plugins.legend.labels.color = rootSt.getPropertyValue('--color-txt-prim').trim();
                    summaryZonePieChartInstance.data.datasets[0].borderColor = rootSt.getPropertyValue('--color-surf').trim();
                    summaryZonePieChartInstance.update('none');
                }
            }

            let audioCtx, beepStartBuf, beepEndBuf, beepMidBuf;
            const FREQ_START = 660, DUR_START = 0.15, FREQ_END = 440, DUR_END = 0.20, FREQ_MID = 880, DUR_MID = 0.08, BEEP_VOL = 1.0;
            let phaseTimer = null, totalTimer = null, totalSecs = 0, phaseSecs = 0;
            let cfg = { exerciseNames: [] }, curSer = 1, curEj = 1;
            let curPhase = '', running = false, paused = false, rePrep = false;
            const PREP_TIME = 5, RE_PREP_TIME = 5;
            
            const DB_NAME = 'ChronoHIIT_DB', DB_VER = 3; 
            const USER_SETTINGS_STORE = 'userSettings', 
                  SAVED_ROUTINES_STORE = 'savedRoutines',
                  WORKOUT_SESSIONS_STORE = 'workoutSessions';
            let db, allEjNamesSet = new Set();
            let suggestionsDropdown = null, activeSuggestionInput = null, blurTimeout = null;

            let hrDevice = null;
            let hrCharacteristic = null;
            let hrServer = null;
            let hrChartInstance = null;
            let fullHrHistory = { labels: [], data: [] }; 
            const MAX_CHART_POINTS_DISPLAY = 60; 
            const CHART_X_AXIS_LABELS = ["-60s", "-45s", "-30s", "-15s", "Ahora"]; 

            const defaultHrZones = { 
                limit:     { min: 145, max: Infinity, color: '#F44336', label: 'Límite (>144bpm)', time: 0, id:'limit' },
                anaerobic: { min: 128, max: 144,    color: '#FF9800', label: 'Anaeróbico (128-144bpm)', time: 0, id:'anaerobic' },
                aerobic:   { min: 112, max: 127,    color: '#8BC34A', label: 'Aeróbico (112-127bpm)', time: 0, id:'aerobic' },
                fatBurning:{ min: 96,  max: 111,    color: '#2196F3', label: 'Quema Grasa (96-111bpm)', time: 0, id:'fatBurning' },
                warmup:    { min: 0,   max: 95,     color: '#03A9F4', label: 'Calentamiento (<96bpm)', time: 0, id:'warmup' }
            };
            let hrZones = JSON.parse(JSON.stringify(defaultHrZones)); 
            let currentUserFcm = null;


            const openDB = () => new Promise((res, rej) => { 
                const req = indexedDB.open(DB_NAME, DB_VER); 
                req.onupgradeneeded = e => { 
                    const d = e.target.result; 
                    if (!d.objectStoreNames.contains(USER_SETTINGS_STORE)) d.createObjectStore(USER_SETTINGS_STORE); 
                    if (!d.objectStoreNames.contains(SAVED_ROUTINES_STORE)) d.createObjectStore(SAVED_ROUTINES_STORE, { keyPath: 'nombreRutina' }); 
                    if (!d.objectStoreNames.contains(WORKOUT_SESSIONS_STORE)) {
                        d.createObjectStore(WORKOUT_SESSIONS_STORE, { keyPath: 'id', autoIncrement: true });
                    }
                }; 
                req.onsuccess = e => { db = e.target.result; res(db); }; 
                req.onerror = e => { console.error('IDB err:', e.target.errorCode); rej('IDB err.'); }; 
            });
            const dbAction = async (storeName, mode, action, keyOrData, dataOnlyForPutKv) => { if (!db) await openDB(); return new Promise((res, rej) => { const tx = db.transaction([storeName], mode); const store = tx.objectStore(storeName); let req; if (action === 'put' && (storeName === SAVED_ROUTINES_STORE || storeName === WORKOUT_SESSIONS_STORE) ) req = store.put(keyOrData); else if (action === 'put_kv' && storeName === USER_SETTINGS_STORE) req = store.put(dataOnlyForPutKv, keyOrData); else if (action === 'get') req = store.get(keyOrData); else if (action === 'delete') req = store.delete(keyOrData); else if (action === 'getAll') req = store.getAll(); else return rej('Invalid DB action'); req.onsuccess = e => res(action === 'get' || action === 'getAll' ? e.target.result : true); req.onerror = e => { console.error(`DB ${action} err on ${storeName}:`, e); rej(e); }; }); };
            async function loadAllEjNames() { try { const names = await dbAction(USER_SETTINGS_STORE, 'readonly', 'get', EJ_NAMES_K); allEjNamesSet = (names && Array.isArray(names)) ? new Set(names) : new Set(); } catch (err) { console.error("Err load all ej names:", err); allEjNamesSet = new Set(); } }
            async function addEjNameToGlobal(name) { if (name && !allEjNamesSet.has(name) && !predefinedExercises[name]) { allEjNamesSet.add(name); try { await dbAction(USER_SETTINGS_STORE, 'readwrite', 'put_kv', EJ_NAMES_K, Array.from(allEjNamesSet)); } catch (err) { console.error("Err save global ej name list:", err); } } }
            async function removeEjNameFromGlobal(name) { if (name && allEjNamesSet.has(name)) { allEjNamesSet.delete(name); try { await dbAction(USER_SETTINGS_STORE, 'readwrite', 'put_kv', EJ_NAMES_K, Array.from(allEjNamesSet)); return true; } catch (err) { console.error("Err removing ej name from global list:", err); return false;} } return false; }

            async function loadLogo() {
                try {
                    const storedUserLogo = await dbAction(USER_SETTINGS_STORE, 'readonly', 'get', LOGO_K);
                    if (storedUserLogo) {
                        logoEl.src = storedUserLogo;
                        logoEl.alt = "Logo de usuario";
                        remLogoBtn.classList.remove('hidden');
                        uploadLogoBtn.classList.add('hidden');
                    } else {
                        logoEl.src = DEFAULT_APP_LOGO_PATH;
                        logoEl.alt = "Logo Chrono HIIT";
                        remLogoBtn.classList.add('hidden');
                        uploadLogoBtn.classList.remove('hidden');
                    }
                    logoEl.classList.remove('hidden');
                    logoEl.style.display = 'block';
                    bodyEl.classList.add('logo-visible');
                    if (typeof feather !== 'undefined') feather.replace();
                } catch (err) {
                    console.error('Err load logo:', err);
                    logoEl.src = DEFAULT_APP_LOGO_PATH;
                    logoEl.alt = "Logo Chrono HIIT";
                    logoEl.classList.remove('hidden');
                    logoEl.style.display = 'block';
                    remLogoBtn.classList.add('hidden');
                    uploadLogoBtn.classList.remove('hidden');
                    bodyEl.classList.add('logo-visible');
                    if (typeof feather !== 'undefined') feather.replace();
                }
            }
            function handleLogoUpload(e) { const f = e.target.files[0]; if (f && f.type.startsWith('image/')) { const r = new FileReader(); r.onload = async ev => { try { await dbAction(USER_SETTINGS_STORE, 'readwrite', 'put_kv',LOGO_K, ev.target.result); loadLogo(); } catch (err) { console.error('Err save logo:', err); alert('Err save logo.'); } }; r.readAsDataURL(f); } else if (f) alert('Use PNG/JPG.'); }
            async function remLogo() { try { await dbAction(USER_SETTINGS_STORE, 'readwrite', 'delete',LOGO_K); loadLogo(); } catch (err) { console.error('Err rem logo:', err); alert('Error al quitar el logo.'); } }

            function calculateUserHrZones(age) {
                if (!age || age < 10 || age > 120) {
                    hrZones = JSON.parse(JSON.stringify(defaultHrZones));
                    currentUserFcm = null;
                    console.log("Edad no válida o no proporcionada, usando zonas HR por defecto.");
                    updateHrZoneLabels();
                    return;
                }
                currentUserFcm = 220 - age;
                console.log(`FC Máxima calculada para edad ${age}: ${currentUserFcm} bpm`);

                hrZones.warmup.min = Math.round(currentUserFcm * 0.50);
                hrZones.warmup.max = Math.round(currentUserFcm * 0.60) - 1;
                hrZones.fatBurning.min = Math.round(currentUserFcm * 0.60);
                hrZones.fatBurning.max = Math.round(currentUserFcm * 0.70) - 1;
                hrZones.aerobic.min = Math.round(currentUserFcm * 0.70);
                hrZones.aerobic.max = Math.round(currentUserFcm * 0.80) - 1;
                hrZones.anaerobic.min = Math.round(currentUserFcm * 0.80);
                hrZones.anaerobic.max = Math.round(currentUserFcm * 0.90) - 1;
                hrZones.limit.min = Math.round(currentUserFcm * 0.90);
                hrZones.limit.max = Infinity;

                updateHrZoneLabels();
                console.log("Zonas HR actualizadas:", hrZones);
            }

            function updateHrZoneLabels() {
                hrZones.warmup.label = `Calentamiento (${hrZones.warmup.min}-${hrZones.warmup.max}bpm)`; // Zona 1
                hrZones.fatBurning.label = `Quema Grasa (${hrZones.fatBurning.min}-${hrZones.fatBurning.max}bpm)`; // Zona 2
                hrZones.aerobic.label = `Aeróbico (${hrZones.aerobic.min}-${hrZones.aerobic.max}bpm)`; // Zona 3
                hrZones.anaerobic.label = `Anaeróbico (${hrZones.anaerobic.min}-${hrZones.anaerobic.max}bpm)`; // Zona 4
                hrZones.limit.label = `Límite (>${hrZones.limit.min -1 < 0 ? 0 : hrZones.limit.min}bpm)`; // Zona 5
            }

            function saveUserProfile() {
                if (userAgeInput) localStorage.setItem('userAge', userAgeInput.value);
                if (userWeightInput) localStorage.setItem('userWeight', userWeightInput.value);
                if (userGenderSelect) localStorage.setItem('userGender', userGenderSelect.value);
                console.log("Perfil de usuario guardado.");
                const age = userAgeInput.value ? parseInt(userAgeInput.value) : null;
                calculateUserHrZones(age);
            }

            function loadUserProfile() {
                const savedAge = localStorage.getItem('userAge');
                const savedWeight = localStorage.getItem('userWeight');
                const savedGender = localStorage.getItem('userGender');

                if (userAgeInput && savedAge) {
                    userAgeInput.value = savedAge;
                    calculateUserHrZones(parseInt(savedAge));
                } else {
                    calculateUserHrZones(null); 
                }
                if (userWeightInput && savedWeight) userWeightInput.value = savedWeight;
                if (userGenderSelect && savedGender) userGenderSelect.value = savedGender;
                console.log("Perfil de usuario cargado.");
            }

            if (userAgeInput) userAgeInput.addEventListener('change', saveUserProfile);
            if (userWeightInput) userWeightInput.addEventListener('change', saveUserProfile);
            if (userGenderSelect) userGenderSelect.addEventListener('change', saveUserProfile);


            function getOrCreateSuggestionsDropdown() { if (!suggestionsDropdown) { suggestionsDropdown = document.createElement('div'); suggestionsDropdown.id = 'exerciseSuggestionsDropdown'; suggestionsDropdown.className = 'exercise-suggestions-dropdown hidden'; document.body.appendChild(suggestionsDropdown); document.addEventListener('click', function(event) { if (activeSuggestionInput && suggestionsDropdown && !suggestionsDropdown.classList.contains('hidden')) { const isClickInsideInput = activeSuggestionInput.contains(event.target); const isClickInsideDropdown = suggestionsDropdown.contains(event.target); if (!isClickInsideInput && !isClickInsideDropdown) { hideSuggestions(); } } }); } return suggestionsDropdown; }
            function hideSuggestions() { const dropdown = getOrCreateSuggestionsDropdown(); dropdown.classList.add('hidden'); activeSuggestionInput = null; }
            function populateAndFilterSuggestions(inputElement, filterText = "") { const dropdown = getOrCreateSuggestionsDropdown(); dropdown.innerHTML = ''; const combinedNames = new Set([...Object.keys(predefinedExercises), ...Array.from(allEjNamesSet)]); const sortedNames = Array.from(combinedNames).sort((a, b) => a.localeCompare(b)); const lowerFilterText = filterText.toLowerCase(); const filtered = sortedNames.filter(name => name.toLowerCase().includes(lowerFilterText)); if (filtered.length === 0 && !filterText) { hideSuggestions(); return; } if (filtered.length === 0 && filterText) { const noResultItem = document.createElement('div'); noResultItem.textContent = 'No hay sugerencias'; noResultItem.style.fontStyle = 'italic'; noResultItem.style.pointerEvents = 'none'; dropdown.appendChild(noResultItem); } else { filtered.forEach(name => { const item = document.createElement('div'); item.textContent = name; item.addEventListener('mousedown', (e) => { e.preventDefault(); inputElement.value = name; inputElement.dispatchEvent(new Event('blur', { bubbles: true, cancelable: true })); hideSuggestions(); }); dropdown.appendChild(item); }); } const inputRect = inputElement.getBoundingClientRect(); dropdown.style.left = `${inputRect.left + window.scrollX}px`; dropdown.style.top = `${inputRect.bottom + window.scrollY}px`; dropdown.style.width = `${inputRect.width}px`; if ((filtered.length > 0) || (filtered.length === 0 && filterText)) { dropdown.classList.remove('hidden'); } else { hideSuggestions(); } }
            function popEjNameInputs() { if (!ejNamesContEl || !numEjSel) return; const numEj = parseInt(numEjSel.value) || 0; ejNamesContEl.innerHTML = ''; const oldDlEl = getEl('ej-names-sugg'); if (oldDlEl) oldDlEl.remove(); if (numEj === 0 || numEjSel.disabled) { ejNamesContEl.classList.add('hidden'); if(suggestionsDropdown) hideSuggestions(); return; } ejNamesContEl.classList.remove('hidden'); for (let i = 0; i < numEj; i++) { const itmDiv = document.createElement('div'); itmDiv.className = 'exercise-name-item'; const lbl = document.createElement('label'); lbl.htmlFor = `ejName${i+1}`; lbl.textContent = `Ejercicio ${i+1}:`; const inp = document.createElement('input'); inp.type = 'text'; inp.id = `ejName${i+1}`; inp.placeholder = `Nombre Ej. ${i+1}`; inp.dataset.index = i; inp.disabled = numEjSel.disabled; inp.autocomplete = "off"; inp.addEventListener('focus', (ev) => { activeSuggestionInput = ev.target; clearTimeout(blurTimeout); populateAndFilterSuggestions(ev.target, ev.target.value); }); inp.addEventListener('input', (ev) => { populateAndFilterSuggestions(ev.target, ev.target.value); }); inp.addEventListener('blur', async (ev) => { blurTimeout = setTimeout(() => { if (activeSuggestionInput === ev.target) { hideSuggestions(); }}, 150); const name = ev.target.value.trim(); if (name && !name.startsWith('Ejercicio ') && !predefinedExercises[name]) { await addEjNameToGlobal(name); } }); inp.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') { hideSuggestions(); ev.target.blur(); }}); if (cfg && cfg.exerciseNames && cfg.exerciseNames[i]) inp.value = cfg.exerciseNames[i]; itmDiv.append(lbl, inp); ejNamesContEl.appendChild(itmDiv); } }
            function genProgCircles(cont, count) { if (!cont) return; cont.innerHTML = ''; for (let i = 0; i < count; i++) { const circ = document.createElement('div'); circ.className = 'progress-circle'; circ.dataset.index = i; cont.appendChild(circ); } }
            function updProgCircles(type, count, completed = false) { const cont = type === 'exercise' ? ejProgEl : serProgEl; if (!cont) return; const circs = cont.querySelectorAll('.progress-circle'); circs.forEach((c, idx) => { c.classList.remove('completed', 'active'); if (idx < count - 1) c.classList.add('completed'); else if (idx === count - 1) { if (completed) c.classList.add('completed'); else if ((running || rePrep) && curPhase !== 'finalizado' && curPhase !== 'preparacion') { if (type === 'exercise' && (curPhase === 'ejercicio' || rePrep)) c.classList.add('active'); else if (type === 'series' && (curPhase === 'ejercicio' || rePrep || curPhase.startsWith('descanso_'))) c.classList.add('active'); } } }); if (curPhase === 'finalizado' && !running) circs.forEach(c => { c.classList.remove('active'); c.classList.add('completed'); }); }
            const createBeep = (freq, dur, vol = BEEP_VOL) => { if (!audioCtx) return null; const sr = audioCtx.sampleRate, nFrames = dur * sr, buf = audioCtx.createBuffer(1, nFrames, sr), data = buf.getChannelData(0); for (let i = 0; i < nFrames; i++) data[i] = Math.sin(2 * Math.PI * freq * i / sr) * vol; return buf; };
            async function initAudio() { if (!audioCtx && (window.AudioContext || window.webkitAudioContext)) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') await audioCtx.resume(); } if (audioCtx && !beepStartBuf) { beepStartBuf = createBeep(FREQ_START, DUR_START); beepEndBuf = createBeep(FREQ_END, DUR_END); beepMidBuf = createBeep(FREQ_MID, DUR_MID); } }
            const playBeep = buf => { if (!audioCtx || !buf || audioCtx.state === 'suspended') return; try { const src = audioCtx.createBufferSource(); src.buffer = buf; src.connect(audioCtx.destination); src.start(); } catch (e) { console.error("Beep err:", e); } };
            function popSel(sel, s, e, stp, def) { if (!sel) return; sel.innerHTML = ''; for (let i = s; i <= e; i += stp) { const opt = document.createElement('option'); opt.value = i; opt.textContent = i; if (i === def) opt.selected = true; sel.appendChild(opt); } }
            const fmtTime = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
            const fmtTotalTime = s => `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
            function calcEstTime() { if (allSels.some(s => !s)) return; const c = { numS: parseInt(numSerSel.value), numE: parseInt(numEjSel.value), tE: parseInt(tEjSel.value), dE: parseInt(dEjSel.value), dS: parseInt(dSerSel.value) }; let total = PREP_TIME; if (c.numS <= 0 || c.numE <= 0) { if (estTimeDispEl) estTimeDispEl.textContent = fmtTotalTime(PREP_TIME); return; } let tSet = (c.numE * c.tE) + (c.numE > 1 ? (c.numE - 1) * c.dE : 0); total += tSet * c.numS + (c.numS > 1 ? (c.numS - 1) * c.dS : 0); if (estTimeDispEl) estTimeDispEl.textContent = fmtTotalTime(total); }

            function updUIDisp() {
                if (cronoActEl) cronoActEl.textContent = fmtTime(phaseSecs);
                if (cronoTotalEl) cronoTotalEl.textContent = fmtTotalTime(totalSecs);
                if (curEjNameDispEl) { curEjNameDispEl.textContent = ''; curEjNameDispEl.classList.add('hidden'); }
                if (estadoEl) estadoEl.className = '';
                if (timerDispSec) { const cls = Array.from(timerDispSec.classList); timerDispSec.classList.remove(...cls.filter(c => c.startsWith('bg-') || c === 'paused-overlay')); }
                const phClsPfx = 'phase-';
                bodyEl.classList.remove(...Array.from(bodyEl.classList).filter(c => c.startsWith(phClsPfx) && c !== 'dark-theme'), 'active-timer-bg');
                contEl.classList.remove(...Array.from(contEl.classList).filter(c => c.startsWith(phClsPfx)), 'active-timer-bg');
                let txt = '', serInfo = (cfg.numSeries > 1) ? ` (Serie ${curSer}/${cfg.numSeries})` : '', timerBgCls = '', stTxtCls = '', curPhStyle = '', bodyPhClr = '', curEjNameForOriginalDisplay = '';
                const isFullScreen = bodyEl.classList.contains('full-screen-mode');

                if (rePrep) {
                    txt = "¡Ajusta Posición!"; timerBgCls = 'bg-preparacion'; stTxtCls = 'preparacion-text'; curPhStyle = 'preparacion';
                    curEjNameForOriginalDisplay = (cfg.exerciseNames && cfg.exerciseNames[curEj-1]) ? cfg.exerciseNames[curEj-1] : (cfg.numEjercicios > 0 ? `Ejercicio ${curEj}` : '');
                } else if (running && curPhase && curPhase !== 'finalizado') {
                    curPhStyle = curPhase;
                    switch (curPhase) {
                        case 'preparacion': txt = "Prepárate"; timerBgCls = 'bg-preparacion'; stTxtCls = 'preparacion-text'; curEjNameForOriginalDisplay = (cfg.exerciseNames && cfg.exerciseNames[0]) ? `Siguiente: ${cfg.exerciseNames[0]}` : (cfg.numEjercicios > 0 ? `Siguiente: Ejercicio 1` : ''); break;
                        case 'ejercicio': txt = `Ejercicio ${curEj}${serInfo}`; timerBgCls = 'bg-ejercicio'; stTxtCls = 'ejercicio-text'; curEjNameForOriginalDisplay = (cfg.exerciseNames && cfg.exerciseNames[curEj-1]) ? cfg.exerciseNames[curEj-1] : (cfg.numEjercicios > 0 ? `Ejercicio ${curEj}` : ''); break;
                        case 'descanso_ejercicio': txt = `Descanso Ej.${serInfo}`; timerBgCls = 'bg-descanso'; stTxtCls = 'descanso-text'; curEjNameForOriginalDisplay = (cfg.exerciseNames && cfg.exerciseNames[curEj]) ? `Siguiente: ${cfg.exerciseNames[curEj]}` : (cfg.numEjercicios > 0 && curEj < cfg.numEjercicios ? `Siguiente: Ejercicio ${curEj+1}` : ''); break;
                        case 'descanso_serie': txt = "Descanso Serie"; timerBgCls = 'bg-descanso'; stTxtCls = 'descanso-text'; curEjNameForOriginalDisplay = (cfg.exerciseNames && cfg.exerciseNames[0]) ? `Siguiente: ${cfg.exerciseNames[0]}` : (cfg.numEjercicios > 0 ? `Siguiente: Ejercicio 1` : ''); break;
                    }
                } else if (curPhase === 'finalizado') {
                    txt = "¡Finalizado!"; timerBgCls = 'bg-finalizado'; stTxtCls = 'finalizado-text'; curPhStyle = 'finalizado'; curEjNameForOriginalDisplay = "¡Buen trabajo!";
                } else { txt = "Listo"; }

                let shouldShowActiveInfoForState = false;
                if (activeExerciseInfoEl && currentExerciseImageEl && currentExerciseCardNameEl && nextExerciseImageEl && nextExerciseCardNameEl && nextExerciseCardEl && currentExerciseCardTitleEl) {
                    let currentExNameToDisplayFS = "", nextExNameToDisplayFS = "", currentCardTitleTextFS = "Ejercicio Actual";
                    if (running && !paused && (curPhase === 'ejercicio' || curPhase === 'descanso_ejercicio' || rePrep || curPhase === 'preparacion')) {
                        shouldShowActiveInfoForState = true;
                        if (curPhase === 'preparacion') {
                            currentExNameToDisplayFS = (cfg.exerciseNames && cfg.exerciseNames[0]) ? cfg.exerciseNames[0] : (cfg.numEjercicios > 0 ? `Ejercicio 1` : '');
                            currentCardTitleTextFS = "Comienza con:";
                            if (cfg.numEjercicios > 1) nextExNameToDisplayFS = (cfg.exerciseNames && cfg.exerciseNames[1]) ? cfg.exerciseNames[1] : `Ejercicio 2`;
                            else nextExNameToDisplayFS = "";
                        } else {
                            currentExNameToDisplayFS = (cfg.exerciseNames && cfg.exerciseNames[curEj - 1]) ? cfg.exerciseNames[curEj - 1] : `Ejercicio ${curEj}`;
                            if (curPhase === 'ejercicio' || rePrep) currentCardTitleTextFS = "Ejercicio Actual";
                            else if (curPhase === 'descanso_ejercicio') currentCardTitleTextFS = "Descansando de:";
                        }
                        currentExerciseImageEl.src = predefinedExercises[currentExNameToDisplayFS]?.image || 'images/generic.webp';
                        currentExerciseImageEl.alt = currentExNameToDisplayFS;
                        currentExerciseCardNameEl.textContent = currentExNameToDisplayFS;
                        currentExerciseCardTitleEl.textContent = currentCardTitleTextFS;
                        if (curPhase === 'preparacion') { /* nextExNameToDisplayFS ya está definido */ }
                        else if (rePrep) nextExNameToDisplayFS = "";
                        else if (curPhase === 'ejercicio') {
                            if (curEj < cfg.numEjercicios) nextExNameToDisplayFS = (cfg.exerciseNames && cfg.exerciseNames[curEj]) ? cfg.exerciseNames[curEj] : `Ejercicio ${curEj + 1}`;
                            else if (curSer < cfg.numSeries) nextExNameToDisplayFS = (cfg.exerciseNames && cfg.exerciseNames[0]) ? cfg.exerciseNames[0] : `Ejercicio 1 (Sig. Serie)`;
                            else nextExNameToDisplayFS = "¡Último!";
                        } else if (curPhase === 'descanso_ejercicio') {
                            if (curEj < cfg.numEjercicios) nextExNameToDisplayFS = (cfg.exerciseNames && cfg.exerciseNames[curEj]) ? cfg.exerciseNames[curEj] : `Ejercicio ${curEj + 1}`;
                            else if (curSer < cfg.numSeries) nextExNameToDisplayFS = (cfg.exerciseNames && cfg.exerciseNames[0]) ? cfg.exerciseNames[0] : `Ejercicio 1 (Sig. Serie)`;
                            else nextExNameToDisplayFS = "";
                        }
                        if (nextExNameToDisplayFS) {
                            nextExerciseImageEl.src = predefinedExercises[nextExNameToDisplayFS]?.image || 'images/generic.webp';
                            nextExerciseImageEl.alt = nextExNameToDisplayFS;
                            nextExerciseCardNameEl.textContent = nextExNameToDisplayFS;
                            nextExerciseCardEl.classList.remove('hidden');
                        } else { nextExerciseCardEl.classList.add('hidden'); }
                    }
                    activeExerciseInfoEl.classList.toggle('js-visible-by-state', shouldShowActiveInfoForState);
                }

                if (curPhStyle && phaseColors[curPhStyle]) { bodyPhClr = phaseColors[curPhStyle]; bodyEl.classList.add(`phase-${curPhStyle}`); contEl.classList.add(`phase-${curPhStyle}`); if (running || rePrep) { bodyEl.classList.add('active-timer-bg'); contEl.classList.add('active-timer-bg'); } }
                bodyEl.style.backgroundColor = (isFullScreen && (running || rePrep || curPhase === 'finalizado')) || (!isFullScreen && (running || rePrep || curPhase === 'finalizado')) ? (bodyPhClr || '') : '';
                if (estadoEl) { estadoEl.textContent = txt; if (stTxtCls) estadoEl.classList.add(stTxtCls); }
                if (curEjNameDispEl) { if (!isFullScreen && curEjNameForOriginalDisplay) { curEjNameDispEl.textContent = curEjNameForOriginalDisplay; curEjNameDispEl.classList.remove('hidden'); } else { curEjNameDispEl.classList.add('hidden'); } }
                if (timerDispSec && timerBgCls) timerDispSec.classList.add(timerBgCls);
                else if (timerDispSec) timerDispSec.classList.remove(...Array.from(timerDispSec.classList).filter(c => c.startsWith('bg-')));
                if (paused && running && timerDispSec && !rePrep) timerDispSec.classList.add('paused-overlay');
            }

            function setUI(st) {
                const enCfg = (st === 'initial' || st === 'finished'), isFs = bodyEl.classList.contains('full-screen-mode');
                allSels.forEach(s => { if(s) s.disabled = !enCfg; });
                if (userAgeInput) userAgeInput.disabled = !enCfg;
                if (userWeightInput) userWeightInput.disabled = !enCfg;
                if (userGenderSelect) userGenderSelect.disabled = !enCfg;

                if(cfgSec) cfgSec.classList.toggle('hidden', isFs || !enCfg);
                if(estTimeEl) estTimeEl.classList.toggle('hidden', isFs || !enCfg);
                if(ejNamesContEl){ const nInps=ejNamesContEl.querySelectorAll('input[type="text"]'); nInps.forEach(i=>i.disabled=!enCfg); const nEj = numEjSel ? parseInt(numEjSel.value) : 0; ejNamesContEl.classList.toggle('hidden', isFs || !enCfg || nEj === 0); if(enCfg) popEjNameInputs(); }
                logoEl.style.display = logoEl.classList.contains('hidden') ? 'none' : 'block';
                
                const isWorkoutActive = (st === 'running' || st === 'paused' || rePrep);

                if(timerDispSec){ 
                    timerDispSec.classList.toggle('hidden', st==='initial' && !isFs); 
                    if(st==='initial'){ 
                        timerDispSec.classList.remove(...Array.from(timerDispSec.classList).filter(c=>c.startsWith('bg-')||c==='paused-overlay')); 
                        if(estadoEl){estadoEl.className=''; estadoEl.textContent="Listo";} 
                        if(cronoActEl) cronoActEl.textContent="00:00"; 
                        if(cronoTotalEl) cronoTotalEl.textContent="00:00:00"; 
                        if(curEjNameDispEl){curEjNameDispEl.textContent=''; curEjNameDispEl.classList.add('hidden');} 
                        curPhase=''; rePrep=false; 
                        if(ejProgEl)ejProgEl.innerHTML=''; 
                        if(serProgEl)serProgEl.innerHTML=''; 
                        if(activeExerciseInfoEl) activeExerciseInfoEl.classList.remove('js-visible-by-state'); 
                    } 
                }
                
                if(startBtn){
                    startBtn.classList.remove('paused');
                    let iconName = 'play';
                    let buttonText = "Iniciar";

                    if(st==='initial'){ /* default values are correct */ } 
                    else if(st==='running'){ iconName = 'pause'; buttonText = "Pausar"; } 
                    else if(st==='paused'){ iconName = 'play-circle'; buttonText = "Reanudar"; startBtn.classList.add('paused'); } 
                    else if(st==='finished'){ iconName = 'refresh-cw'; buttonText = "Nuevo"; }
                    
                    startBtn.innerHTML = `<i data-feather="${iconName}"></i><span class="btn-text">${buttonText}</span>`;
                }

                if(finishBtn)finishBtn.classList.toggle('hidden',!(st==='running'||st==='paused')||rePrep);
                if(restartEjBtn){ const show=st==='running'&&curPhase==='ejercicio'&&!rePrep&&!paused; restartEjBtn.classList.toggle('hidden',!show); }
                if(st==='finished'){curPhase='finalizado';rePrep=false;}
                if(progIndEl){ const showInd=(cfg&&cfg.numEjercicios>1)||(cfg&&cfg.numSeries>1); let hide= !showInd; if(isFs&&(st==='initial'||st==='finished'))hide=true; progIndEl.classList.toggle('hidden',hide); }
                if(actionButtonsSection) actionButtonsSection.classList.toggle('hidden', isFs || isWorkoutActive);
                
                if (connectHrDeviceBtn) connectHrDeviceBtn.classList.toggle('hidden', isFs || isWorkoutActive);
                if (heartRateDisplayAreaEl) {
                    const hrConnected = hrDevice && hrDevice.gatt.connected;
                    const shouldShowHrArea = hrConnected || (!isFs && !isWorkoutActive);
                    heartRateDisplayAreaEl.classList.toggle('hidden', !shouldShowHrArea);
                    heartRateDisplayAreaEl.classList.toggle('workout-active', hrConnected && isWorkoutActive && curPhase !== 'finalizado'); 
                    if (isFs && !hrConnected) {
                        heartRateDisplayAreaEl.classList.add('hidden'); 
                    }
                }
                if (hrChartContainerEl) {
                    const hrConnected = hrDevice && hrDevice.gatt.connected;
                    const shouldShowChart = hrConnected && !isFs && !(st === 'finished') && !(st === 'initial' && !isWorkoutActive) ;
                    hrChartContainerEl.classList.toggle('hidden', !shouldShowChart);
                }


                if(typeof feather!=='undefined') feather.replace(); 
                updUIDisp();
            }
            function phaseTick() { if (paused && !rePrep) return; if (rePrep) { if (phaseSecs <= RE_PREP_TIME && phaseSecs >= 1 && phaseSecs <= 3) playBeep(beepMidBuf); } else if (curPhase === 'ejercicio' && running) { if (cfg.tiempoEjercicio >= 20 && phaseSecs === Math.ceil(cfg.tiempoEjercicio / 2) && phaseSecs > 5) playBeep(beepMidBuf); if (phaseSecs <= 5 && phaseSecs >= 1) playBeep(beepMidBuf); } phaseSecs--; updUIDisp(); if (phaseSecs < 0) { if (rePrep) { rePrep = false; playBeep(beepStartBuf); startPhase('ejercicio', cfg.tiempoEjercicio); } else { if (running) { if (curPhase === 'ejercicio') { updProgCircles('exercise', curEj, true); if (curEj === cfg.numEjercicios) updProgCircles('series', curSer, true); } playBeep(beepEndBuf); } nextPhase(); } } }
            function totalTick() { if (paused || !running) return; totalSecs++; if (cronoTotalEl) cronoTotalEl.textContent = fmtTotalTime(totalSecs); }
            function nextPhase() { clearInterval(phaseTimer); phaseTimer = null; let name = '', dur = 0; if (curPhase === 'preparacion') { name = 'ejercicio'; dur = cfg.tiempoEjercicio; } else if (curPhase === 'ejercicio') { if (cfg.numEjercicios > 1 && curEj < cfg.numEjercicios) { name = 'descanso_ejercicio'; dur = cfg.descansoEjercicio; } else { if (curSer < cfg.numSeries) { name = 'descanso_serie'; dur = cfg.descansoSerie; } else { finishWorkout(true); return; } } } else if (curPhase === 'descanso_ejercicio') { curEj++; name = 'ejercicio'; dur = cfg.tiempoEjercicio; } else if (curPhase === 'descanso_serie') { curSer++; curEj = 1; name = 'ejercicio'; dur = cfg.tiempoEjercicio; } else { finishWorkout(false); return; } startPhase(name, dur); }
            function startPhase(name, dur) { curPhase = name; rePrep = false; phaseSecs = dur; if (name === 'ejercicio') { updProgCircles('exercise', curEj); updProgCircles('series', curSer); } else if (name === 'preparacion') { if (cfg && cfg.numEjercicios) updProgCircles('exercise', curEj); if (cfg && cfg.numSeries) updProgCircles('series', curSer); } setUI(running ? (paused ? 'paused' : 'running') : 'initial'); if (running && !paused && name === 'ejercicio' && !rePrep) playBeep(beepStartBuf); if (phaseTimer) clearInterval(phaseTimer); if (dur <= 0 && running && !paused && name !== 'finalizado') { setTimeout(nextPhase, 50); return; } if (running && !paused && name !== 'finalizado') phaseTimer = setInterval(phaseTick, 1000); }
            async function restartCurEj() { if (!running || curPhase !== 'ejercicio' || rePrep) return; await initAudio(); clearInterval(phaseTimer); phaseTimer = null; paused = false; rePrep = true; phaseSecs = RE_PREP_TIME; playBeep(beepMidBuf); setUI('running'); phaseTimer = setInterval(phaseTick, 1000); }
            
            function resetZoneTimes() {
                for (const zoneKey in hrZones) {
                    hrZones[zoneKey].time = 0;
                }
                currentSessionMaxHr = 0;
                lastHrTimestamp = 0;
            }

            async function startWorkout() { 
                if (running && !paused) return; 
                await initAudio(); 
                cfg = { numSeries: parseInt(numSerSel.value), numEjercicios: parseInt(numEjSel.value), tiempoEjercicio: parseInt(tEjSel.value), descansoEjercicio: parseInt(dEjSel.value), descansoSerie: parseInt(dSerSel.value), exerciseNames: [] }; 
                if (ejNamesContEl && cfg.numEjercicios > 0) { const nInps = ejNamesContEl.querySelectorAll('input[type="text"]'); nInps.forEach((inp, i) => { cfg.exerciseNames[i] = inp.value.trim() || `Ejercicio ${i+1}`; }); } for (let i = cfg.exerciseNames.length; i < cfg.numEjercicios; i++) cfg.exerciseNames[i] = `Ejercicio ${i+1}`; 
                if (cfg.exerciseNames && cfg.exerciseNames.length > 0) { for (const name of cfg.exerciseNames) { if (name.startsWith('Ejercicio ') || predefinedExercises[name]) continue; await addEjNameToGlobal(name); } } 
                curSer = 1; curEj = 1; totalSecs = 0; paused = false; running = true; rePrep = false; 
                if (ejProgEl) genProgCircles(ejProgEl, cfg.numEjercicios); if (serProgEl) genProgCircles(serProgEl, cfg.numSeries); 
                
                fullHrHistory.labels = []; 
                fullHrHistory.data = [];
                resetZoneTimes(); 

                if (hrChartInstance) { 
                    hrChartInstance.data.labels = [...CHART_X_AXIS_LABELS];
                    hrChartInstance.data.datasets[0].data = Array(CHART_X_AXIS_LABELS.length).fill(null);
                    hrChartInstance.update('none');
                }

                startPhase('preparacion', PREP_TIME); 
                if (totalTimer) clearInterval(totalTimer); 
                totalTimer = setInterval(totalTick, 1000); 
            }
            function pauseWorkout() { if (!running || paused || rePrep) return; paused = true; setUI('paused'); }
            function resumeWorkout() { if (!running || !paused || rePrep) return; if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume().then(() => { paused = false; setUI('running'); }).catch(e => console.error("Resume AC err:", e)); else { paused = false; setUI('running'); } }
            
            async function saveWorkoutSession() {
                if (fullHrHistory.data.length === 0 && totalSecs === 0) {
                    console.log("No hay datos significativos para guardar la sesión.");
                    return;
                }
                const sessionData = {
                    timestamp: Date.now(),
                    totalDurationSeconds: totalSecs,
                    maxHr: currentSessionMaxHr,
                    hrDataPoints: [...fullHrHistory.data], 
                    hrTimeLabels: [...fullHrHistory.labels], 
                    zones: JSON.parse(JSON.stringify(hrZones)), 
                    config: JSON.parse(JSON.stringify(cfg)) 
                };
                try {
                    await dbAction(WORKOUT_SESSIONS_STORE, 'readwrite', 'put', sessionData); 
                    console.log("Sesión de entrenamiento guardada:", sessionData);
                } catch (err) {
                    console.error("Error guardando la sesión de entrenamiento:", err);
                }
            }

            async function showWorkoutSummaryModal() {
                if (!workoutSummaryScreenEl || !summaryTotalTimeEl || !summaryMaxHrEl || 
                    !summaryHrChartCanvasEl || !summaryZoneStatsContainerEl || !summaryZonePieChartCanvasEl ||
                    !summaryHrChartContainerParentEl || !summaryZonePieChartContainerParentEl || !noSummaryDataMessageEl) {
                    console.error("Summary modal elements not found.");
                    return;
                }
                
                const hasHrData = fullHrHistory.data.length > 0;
                noSummaryDataMessageEl.classList.toggle('hidden', hasHrData);

                summaryTotalTimeEl.textContent = fmtTotalTime(totalSecs);
                summaryMaxHrEl.textContent = currentSessionMaxHr > 0 ? currentSessionMaxHr : '-';

                summaryZoneStatsContainerEl.innerHTML = ''; 
                const zoneDataForPie = [];
                const zoneLabelsForPie = [];
                const zoneColorsForPie = [];
                const zoneOrder = ['limit', 'anaerobic', 'aerobic', 'fatBurning', 'warmup'];

                for (const zoneId of zoneOrder) {
                    const zone = hrZones[zoneId];
                    if (zone) {
                        const percentage = totalSecs > 0 ? (zone.time / totalSecs) * 100 : 0;
                        const currentZonePercentage = parseFloat(percentage.toFixed(1));

                        const zoneItemEl = document.createElement('div');
                        zoneItemEl.className = 'summary-zone-item';
                        zoneItemEl.innerHTML = `
                            <span class="zone-color-indicator" style="background-color: ${zone.color};"></span>
                            <span class="zone-name">${zone.label}</span>
                            <span class="zone-time">${fmtTotalTime(Math.round(zone.time))}</span>
                            <span class="zone-percentage">(${currentZonePercentage}%)</span>
                        `;
                        summaryZoneStatsContainerEl.appendChild(zoneItemEl);
                        zoneDataForPie.push(currentZonePercentage); 
                        zoneLabelsForPie.push(zone.label.substring(0, zone.label.indexOf('(') > -1 ? zone.label.indexOf('(') : zone.label.length).trim());
                        zoneColorsForPie.push(zone.color);
                    }
                }
                
                summaryHrChartContainerParentEl.classList.toggle('hidden', !hasHrData);
                if (summaryHrChartInstance) summaryHrChartInstance.destroy();
                if (hasHrData) {
                    const minHr = Math.max(0, Math.min(...fullHrHistory.data) - 10);
                    const maxHr = Math.max(60, Math.max(...fullHrHistory.data) + 10);

                    summaryHrChartInstance = new Chart(summaryHrChartCanvasEl, {
                        type: 'line',
                        data: {
                            labels: fullHrHistory.labels.map((_, i) => i + 1), 
                            datasets: [{
                                label: 'BPM',
                                data: fullHrHistory.data,
                                borderColor: rootSt.getPropertyValue('--chart-line-color').trim(),
                                backgroundColor: rootSt.getPropertyValue('--chart-line-color').trim().replace(')', ', 0.3)').replace('rgb', 'rgba'),
                                fill: true, tension: 0.1, pointRadius: 0, borderWidth: 1.5
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false, animation: { duration: 0 },
                            scales: {
                                x: { 
                                    ticks: { autoSkip: true, maxTicksLimit: 10, color: rootSt.getPropertyValue('--chart-tick-color').trim() },
                                    grid: { color: rootSt.getPropertyValue('--chart-grid-color').trim() },
                                    title: { display: true, text: 'Muestras de Ritmo Cardíaco', color: rootSt.getPropertyValue('--chart-tick-color').trim() }
                                },
                                y: { 
                                    min: minHr, max: maxHr,
                                    ticks: { color: rootSt.getPropertyValue('--chart-tick-color').trim() },
                                    grid: { color: rootSt.getPropertyValue('--chart-grid-color').trim() },
                                    title: { display: true, text: 'BPM', color: rootSt.getPropertyValue('--chart-tick-color').trim() }
                                }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                }
                
                summaryZonePieChartContainerParentEl.classList.toggle('hidden', !hasHrData && zoneDataForPie.every(p => p === 0));
                if (summaryZonePieChartInstance) summaryZonePieChartInstance.destroy();
                const nonZeroPercentages = zoneDataForPie.some(p => p > 0);
                if (hasHrData || nonZeroPercentages) {
                     summaryZonePieChartInstance = new Chart(summaryZonePieChartCanvasEl, {
                        type: 'doughnut',
                        data: {
                            labels: zoneLabelsForPie,
                            datasets: [{
                                label: 'Tiempo en Zona', data: zoneDataForPie,
                                backgroundColor: zoneColorsForPie,
                                borderColor: rootSt.getPropertyValue('--color-surf').trim(), borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    position: 'bottom', 
                                    labels: { color: rootSt.getPropertyValue('--color-txt-prim').trim(), boxWidth: 15, padding: 10, font: {size: 10} }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) label += ': ';
                                            if (context.parsed !== null) label += context.parsed.toFixed(1) + '%';
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                     summaryZonePieChartContainerParentEl.classList.add('hidden');
                }

                workoutSummaryScreenEl.classList.remove('hidden');
                bodyEl.style.overflow = 'hidden';
                if (typeof feather !== 'undefined') feather.replace();

                if (fullHrHistory.data.length > 0) { 
                    await saveWorkoutSession();
                }
            }

            async function displayHistoricalSessionSummary(sessionData) {
                if (!workoutSummaryScreenEl || !summaryTotalTimeEl || !summaryMaxHrEl ||
                    !summaryHrChartCanvasEl || !summaryZoneStatsContainerEl || !summaryZonePieChartCanvasEl ||
                    !summaryHrChartContainerParentEl || !summaryZonePieChartContainerParentEl || !noSummaryDataMessageEl) {
                    console.error("Summary modal elements not found for historical display.");
                    return;
                }
                const hasHrData = sessionData.hrDataPoints && sessionData.hrDataPoints.length > 0;
                noSummaryDataMessageEl.classList.toggle('hidden', !hasHrData);
                summaryTotalTimeEl.textContent = fmtTotalTime(sessionData.totalDurationSeconds);
                summaryMaxHrEl.textContent = sessionData.maxHr > 0 ? sessionData.maxHr : '-';
                summaryZoneStatsContainerEl.innerHTML = '';
                const zoneDataForPie = [];
                const zoneLabelsForPie = [];
                const zoneColorsForPie = [];
                const zoneOrder = ['limit', 'anaerobic', 'aerobic', 'fatBurning', 'warmup'];
                const sessionZones = sessionData.zones || defaultHrZones;

                for (const zoneId of zoneOrder) {
                    const zone = sessionZones[zoneId];
                    if (zone) {
                        const percentage = sessionData.totalDurationSeconds > 0 ? (zone.time / sessionData.totalDurationSeconds) * 100 : 0;
                        const currentZonePercentage = parseFloat(percentage.toFixed(1));
                        const zoneItemEl = document.createElement('div');
                        zoneItemEl.className = 'summary-zone-item';
                        zoneItemEl.innerHTML = `
                            <span class="zone-color-indicator" style="background-color: ${zone.color};"></span>
                            <span class="zone-name">${zone.label}</span>
                            <span class="zone-time">${fmtTotalTime(Math.round(zone.time))}</span>
                            <span class="zone-percentage">(${currentZonePercentage}%)</span>`;
                        summaryZoneStatsContainerEl.appendChild(zoneItemEl);
                        zoneDataForPie.push(currentZonePercentage);
                        zoneLabelsForPie.push(zone.label.substring(0, zone.label.indexOf('(') > -1 ? zone.label.indexOf('(') : zone.label.length).trim());
                        zoneColorsForPie.push(zone.color);
                    }
                }
                summaryHrChartContainerParentEl.classList.toggle('hidden', !hasHrData);
                if (summaryHrChartInstance) summaryHrChartInstance.destroy();
                if (hasHrData) {
                    const minHr = Math.max(0, Math.min(...sessionData.hrDataPoints) - 10);
                    const maxHr = Math.max(60, Math.max(...sessionData.hrDataPoints) + 10);
                    summaryHrChartInstance = new Chart(summaryHrChartCanvasEl, {
                        type: 'line',
                        data: {
                            labels: sessionData.hrTimeLabels.map((_, i) => i + 1),
                            datasets: [{
                                label: 'BPM', data: sessionData.hrDataPoints,
                                borderColor: rootSt.getPropertyValue('--chart-line-color').trim(),
                                backgroundColor: rootSt.getPropertyValue('--chart-line-color').trim().replace(')', ', 0.3)').replace('rgb', 'rgba'),
                                fill: true, tension: 0.1, pointRadius: 0, borderWidth: 1.5
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, animation: { duration: 0 },
                            scales: {
                                x: { ticks: { autoSkip: true, maxTicksLimit: 10, color: rootSt.getPropertyValue('--chart-tick-color').trim() }, grid: { color: rootSt.getPropertyValue('--chart-grid-color').trim() }, title: { display: true, text: 'Muestras de Ritmo Cardíaco', color: rootSt.getPropertyValue('--chart-tick-color').trim() }},
                                y: { min: minHr, max: maxHr, ticks: { color: rootSt.getPropertyValue('--chart-tick-color').trim() }, grid: { color: rootSt.getPropertyValue('--chart-grid-color').trim() }, title: { display: true, text: 'BPM', color: rootSt.getPropertyValue('--chart-tick-color').trim() }}
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                }
                summaryZonePieChartContainerParentEl.classList.toggle('hidden', !hasHrData && zoneDataForPie.every(p => p === 0));
                if (summaryZonePieChartInstance) summaryZonePieChartInstance.destroy();
                const nonZeroPercentages = zoneDataForPie.some(p => p > 0);
                if (hasHrData || nonZeroPercentages) {
                     summaryZonePieChartInstance = new Chart(summaryZonePieChartCanvasEl, {
                        type: 'doughnut',
                        data: {
                            labels: zoneLabelsForPie,
                            datasets: [{
                                label: 'Tiempo en Zona', data: zoneDataForPie,
                                backgroundColor: zoneColorsForPie,
                                borderColor: rootSt.getPropertyValue('--color-surf').trim(), borderWidth: 1
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom', labels: { color: rootSt.getPropertyValue('--color-txt-prim').trim(), boxWidth: 15, padding: 10, font: {size: 10} }},
                                tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) label += ': '; if (context.parsed !== null) label += context.parsed.toFixed(1) + '%'; return label;}}}
                            }
                        }
                    });
                } else {
                     summaryZonePieChartContainerParentEl.classList.add('hidden');
                }
                workoutSummaryScreenEl.classList.remove('hidden');
                bodyEl.style.overflow = 'hidden';
                if (typeof feather !== 'undefined') feather.replace();
            }

            async function populateHistoryModal() {
                if (!historyListEl || !noHistoryMessageEl) return;
                historyListEl.innerHTML = '';
                try {
                    const sessions = await dbAction(WORKOUT_SESSIONS_STORE, 'readonly', 'getAll') || [];
                    sessions.sort((a, b) => b.timestamp - a.timestamp); 
                    noHistoryMessageEl.classList.toggle('hidden', sessions.length > 0);
                    if (sessions.length > 0) {
                        sessions.forEach(session => {
                            const li = document.createElement('li');
                            const sessionDate = new Date(session.timestamp);
                            const formattedDate = `${sessionDate.toLocaleDateString()} ${sessionDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                            const infoDiv = document.createElement('div');
                            infoDiv.className = 'history-item-info';
                            infoDiv.innerHTML = `
                                <span class="session-date">${formattedDate}</span>
                                <span class="session-details">
                                    Duración: ${fmtTotalTime(session.totalDurationSeconds)}
                                    ${session.maxHr > 0 ? ` / Máx BPM: ${session.maxHr}` : ''}
                                    ${session.config && session.config.numEjercicios ? ` / ${session.config.numEjercicios} Ejs, ${session.config.numSeries} Sers` : ''}
                                </span>`;
                            const actionsDiv = document.createElement('div');
                            actionsDiv.className = 'history-item-actions';
                            const viewBtn = document.createElement('button');
                            viewBtn.className = 'history-action-btn';
                            viewBtn.innerHTML = '<i data-feather="eye"></i> Ver';
                            viewBtn.title = "Ver Detalles de la Sesión";
                            viewBtn.onclick = () => {
                                historyScreenEl.classList.add('hidden'); 
                                displayHistoricalSessionSummary(session); 
                            };
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'history-action-btn';
                            deleteBtn.innerHTML = '<i data-feather="trash-2"></i> Eliminar';
                            deleteBtn.title = "Eliminar esta Sesión";
                            deleteBtn.onclick = async () => {
                                if (confirm(`¿Seguro que quieres eliminar la sesión del ${formattedDate}?`)) {
                                    try {
                                        await dbAction(WORKOUT_SESSIONS_STORE, 'readwrite', 'delete', session.id);
                                        populateHistoryModal(); 
                                    } catch (err) {
                                        console.error("Error eliminando sesión:", err);
                                        alert("Error al eliminar la sesión.");
                                    }
                                }
                            };
                            actionsDiv.append(viewBtn, deleteBtn);
                            li.append(infoDiv, actionsDiv);
                            historyListEl.appendChild(li);
                        });
                    }
                } catch (err) {
                    console.error("Error cargando historial de sesiones:", err);
                    noHistoryMessageEl.classList.remove('hidden');
                }
                if (typeof feather !== 'undefined') feather.replace();
            }

            if (openHistoryBtn && historyScreenEl && closeHistoryBtn) {
                openHistoryBtn.onclick = () => {
                    populateHistoryModal();
                    historyScreenEl.classList.remove('hidden');
                    bodyEl.style.overflow = 'hidden';
                };
                const closeHistoryModal = () => {
                    historyScreenEl.classList.add('hidden');
                    bodyEl.style.overflow = '';
                };
                closeHistoryBtn.onclick = closeHistoryModal;
                window.addEventListener('keydown', e => {
                    if (e.key === 'Escape' && !historyScreenEl.classList.contains('hidden')) {
                        closeHistoryModal();
                    }
                });
                historyScreenEl.onclick = e => {
                    if (e.target === historyScreenEl) {
                        closeHistoryModal();
                    }
                };
            }


            function finishWorkout(completed = true) { 
                clearInterval(phaseTimer); clearInterval(totalTimer); phaseTimer = null; totalTimer = null; 
                running = false; paused = false; rePrep = false; 
                if(activeExerciseInfoEl) activeExerciseInfoEl.classList.remove('js-visible-by-state'); 
                if (completed) { 
                    if (cfg.numEjercicios) updProgCircles('exercise', cfg.numEjercicios, true); 
                    if (cfg.numSeries) updProgCircles('series', cfg.numSeries, true); 
                    phaseSecs = 0; 
                    setUI('finished'); 
                    if (fullHrHistory.data.length > 0) { 
                        showWorkoutSummaryModal();
                    }
                } else { 
                    totalSecs = 0; phaseSecs = 0; curPhase = ''; 
                    if (cfg) cfg.exerciseNames = []; 
                    if (curEjNameDispEl) { curEjNameDispEl.textContent = ''; curEjNameDispEl.classList.add('hidden'); } 
                    if (ejProgEl) ejProgEl.innerHTML = ''; 
                    if (serProgEl) serProgEl.innerHTML = ''; 
                    setUI('initial'); calcEstTime(); popEjNameInputs(); 
                    
                    fullHrHistory.labels = [];
                    fullHrHistory.data = [];
                    resetZoneTimes(); 
                    if (hrChartInstance) { 
                        hrChartInstance.data.labels = [...CHART_X_AXIS_LABELS];
                        hrChartInstance.data.datasets[0].data = Array(CHART_X_AXIS_LABELS.length).fill(null);
                        hrChartInstance.update('none');
                    }
                } 
            }

            allSels.forEach(s => { if (s) s.onchange = calcEstTime; });
            if (numEjSel) numEjSel.onchange = () => { calcEstTime(); popEjNameInputs(); };
            if (startBtn) startBtn.onclick = () => { if (rePrep) return; if (!audioCtx || audioCtx.state === 'suspended') initAudio().then(() => { if (!running) startWorkout(); else if (paused) resumeWorkout(); else pauseWorkout(); }); else { if (!running) startWorkout(); else if (paused) resumeWorkout(); else pauseWorkout(); } };
            
            if (finishBtn) finishBtn.onclick = () => {
                if (rePrep) return;
                if (fullHrHistory.data.length > 0) {
                    clearInterval(phaseTimer); clearInterval(totalTimer); phaseTimer = null; totalTimer = null;
                    running = false; paused = false; rePrep = false;
                    if(activeExerciseInfoEl) activeExerciseInfoEl.classList.remove('js-visible-by-state');
                    if (cfg && cfg.numEjercicios) updProgCircles('exercise', curEj, true);
                    if (cfg && cfg.numSeries) updProgCircles('series', curSer, true);
                    phaseSecs = 0;
                    curPhase = 'finalizado';
                    setUI('finished');
                    showWorkoutSummaryModal(); 
                }
                finishWorkout(false); 
            };

            if (restartEjBtn) restartEjBtn.onclick = () => { if (paused && curPhase === 'ejercicio' && !rePrep) { paused = false; restartCurEj(); } else if (!paused && curPhase === 'ejercicio' && !rePrep) restartCurEj(); };
            
            const isFSE = () => !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
            const hFSC = () => {
                const isFS = isFSE();
                bodyEl.classList.toggle('full-screen-mode', isFS);
                if (fsBtn) {
                    fsBtn.innerHTML = `<i data-feather="${isFS ? 'minimize' : 'maximize'}"></i>`;
                    fsBtn.title = isFS ? "Salir Pantalla Completa" : "Modo Pantalla Completa";
                }
                let cs;
                if (!running && !paused && curPhase === '') cs = 'initial';
                else if (curPhase === 'finalizado') cs = 'finished';
                else if (paused) cs = 'paused';
                else cs = 'running';
                setUI(cs); 
            };
            if (fsBtn) {
                 fsBtn.onclick = () => {
                    if (!isFSE()) {
                        if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(e => { console.warn(`FS Err: ${e.message}`) });
                        else if (document.documentElement.webkitRequestFullscreen) document.documentElement.webkitRequestFullscreen();
                        else if (document.documentElement.msRequestFullscreen) document.documentElement.msRequestFullscreen();
                    } else {
                        if (document.exitFullscreen) document.exitFullscreen();
                        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                        else if (document.msExitFullscreen) document.msExitFullscreen();
                    }
                };
                ['fullscreenchange', 'webkitfullscreenchange', 'mozfullscreenchange', 'MSFullscreenChange'].forEach(ev => document.addEventListener(ev, hFSC));
            }

            function applyTh(th) {
                bodyEl.classList.toggle('dark-theme', th === 'dark');
                if (themeBtn) {
                    themeBtn.innerHTML = `<i data-feather="${th === 'dark' ? 'sun' : 'moon'}"></i>`;
                    themeBtn.title = `Cambiar a Tema ${th === 'dark' ? 'Claro' : 'Oscuro'}`;
                }
                if (typeof feather !== 'undefined') feather.replace();
                updPhaseColors(); 
                updUIDisp();
            }
            if (themeBtn) themeBtn.onclick = () => { const newTh = bodyEl.classList.contains('dark-theme') ? 'light' : 'dark'; localStorage.setItem('theme', newTh); applyTh(newTh); };
            
            if(uploadLogoBtn)uploadLogoBtn.onclick=()=>logoUploadIn.click(); if(logoUploadIn)logoUploadIn.onchange=handleLogoUpload; if(remLogoBtn)remLogoBtn.onclick=remLogo;
            async function getCurCfgObj(forRoutineSave = false){ const currentConfig = { numEjercicios: parseInt(numEjSel.value), numSeries: parseInt(numSerSel.value), tiempoEjercicio: parseInt(tEjSel.value), descansoEjercicio: parseInt(dEjSel.value), descansoSerie: parseInt(dSerSel.value) }; const exerciseNames = []; const nInps = ejNamesContEl.querySelectorAll('input[type="text"]'); nInps.forEach((inp, i) => { exerciseNames[i] = inp.value.trim() || `Ejercicio ${i + 1}`; }); for (let i = exerciseNames.length; i < currentConfig.numEjercicios; i++) exerciseNames[i] = `Ejercicio ${i + 1}`; if (forRoutineSave) { return { config: currentConfig, exerciseNames: exerciseNames }; } else { return { ...currentConfig, exerciseNames: exerciseNames, theme: localStorage.getItem('theme') || 'light', allExerciseNames: Array.from(allEjNamesSet), userLogoBase64: (logoEl.src && logoEl.src !== '#' && !logoEl.classList.contains('hidden') && logoEl.src !== DEFAULT_APP_LOGO_PATH) ? logoEl.src : null }; } }
            if(exportBtn)exportBtn.onclick=async()=>{const s=await getCurCfgObj(false),j=JSON.stringify(s,null,2),b=new Blob([j],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='chrono_hiit_settings.json';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);};
            if(importBtn)importBtn.onclick=()=>{importIn.click();};
            if(importIn)importIn.onchange=async e=>{const f=e.target.files[0];if(f){const r=new FileReader();r.onload=async ev=>{try{const s=JSON.parse(ev.target.result);await applyImpCfg(s);alert('Conf. importada. La página se recargará.'); window.location.reload();}catch(err){console.error('Err import conf:',err);alert('Err import.')}};r.readAsText(f);e.target.value=null}};
            async function applyImpCfg(s){if(!s)return;if(s.numEjercicios!==undefined)numEjSel.value=s.numEjercicios;if(s.numSeries!==undefined)numSerSel.value=s.numSeries;if(s.tiempoEjercicio!==undefined)tEjSel.value=s.tiempoEjercicio;if(s.descansoEjercicio!==undefined)dEjSel.value=s.descansoEjercicio;if(s.descansoSerie!==undefined)dSerSel.value=s.descansoSerie;if(s.theme){localStorage.setItem('theme',s.theme);}if(s.allExerciseNames&&Array.isArray(s.allExerciseNames)){allEjNamesSet=new Set(s.allExerciseNames);await dbAction(USER_SETTINGS_STORE, 'readwrite', 'put_kv', EJ_NAMES_K, Array.from(allEjNamesSet))}cfg.exerciseNames=s.exerciseNames||[];if(s.userLogoBase64){try{await dbAction(USER_SETTINGS_STORE, 'readwrite', 'put_kv',LOGO_K,s.userLogoBase64);}catch(e){console.error('Err save imported logo:',e)}}else if(s.hasOwnProperty('userLogoBase64') && s.userLogoBase64===null){try{await dbAction(USER_SETTINGS_STORE, 'readwrite', 'delete',LOGO_K);}catch(e){console.error('Err rem logo from import:',e)}}}
            
            function popExplGrid(){
                if(!explGridEl||!numEjSel)return;
                explGridEl.innerHTML='';
                const numEj=parseInt(numEjSel.value)||0,
                      ejNameInps=ejNamesContEl.querySelectorAll('input[type="text"]');

                for(let i=0;i<numEj;i++){
                    const itmD=document.createElement('div');
                    itmD.className='explanation-item';
                    const numS=document.createElement('span');
                    numS.className='explanation-item-number';
                    numS.textContent=i+1;
                    const nameS=document.createElement('span');
                    nameS.className='explanation-item-name';
                    let curEjName=`Ejercicio ${i+1}`;
                    if(ejNameInps[i]&&ejNameInps[i].value.trim()){
                        curEjName=ejNameInps[i].value.trim()
                    } else if(cfg&&cfg.exerciseNames&&cfg.exerciseNames[i]){
                        curEjName=cfg.exerciseNames[i]
                    }
                    nameS.textContent=curEjName;
                    const descP = document.createElement('p');
                    descP.className = 'explanation-item-description';
                    if (predefinedExercises[curEjName] && predefinedExercises[curEjName].description) {
                        descP.textContent = predefinedExercises[curEjName].description;
                    }
                    const imgCont=document.createElement('div');
                    imgCont.className='explanation-item-image-container';
                    const imgEl=document.createElement('img');
                    imgEl.className='explanation-item-image';
                    if(predefinedExercises[curEjName] && predefinedExercises[curEjName].image){
                        imgEl.src=predefinedExercises[curEjName].image;
                        imgEl.alt=curEjName;
                    } else {
                        imgEl.src='images/generic.webp';
                        imgEl.alt=curEjName;
                    }
                    imgCont.appendChild(imgEl);
                    itmD.append(numS, nameS, descP, imgCont); 
                    explGridEl.appendChild(itmD);
                }
            }

            if(showExplBtn && explScreenEl && closeExplBtn && toggleExplFSBtn){ showExplBtn.onclick = () => { popExplGrid(); explScreenEl.classList.remove('hidden', 'modal-fullscreen-active'); if(toggleExplFSBtn.firstChild) toggleExplFSBtn.innerHTML = '<i data-feather="maximize-2"></i>'; toggleExplFSBtn.title = "Maximizar Vista"; bodyEl.style.overflow = 'hidden'; if(typeof feather !== 'undefined') feather.replace(); }; const closeExplModal = () => { explScreenEl.classList.add('hidden'); explScreenEl.classList.remove('modal-fullscreen-active'); if(toggleExplFSBtn.firstChild) toggleExplFSBtn.innerHTML = '<i data-feather="maximize-2"></i>'; toggleExplFSBtn.title = "Maximizar Vista"; bodyEl.style.overflow = ''; if(typeof feather !== 'undefined') feather.replace(); }; closeExplBtn.onclick = closeExplModal; toggleExplFSBtn.onclick = () => { explScreenEl.classList.toggle('modal-fullscreen-active'); const isModalFS = explScreenEl.classList.contains('modal-fullscreen-active'); if(toggleExplFSBtn.firstChild) toggleExplFSBtn.innerHTML = `<i data-feather="${isModalFS ? 'minimize-2' : 'maximize-2'}"></i>`; toggleExplFSBtn.title = isModalFS ? "Restaurar Vista" : "Maximizar Vista"; if(typeof feather !== 'undefined') feather.replace(); }; window.addEventListener('keydown',e=>{if(e.key==='Escape'&&!explScreenEl.classList.contains('hidden')) closeExplModal(); }); explScreenEl.onclick=e=>{if(e.target===explScreenEl) closeExplModal(); }; }
            function populateManageNamesModal() { if (!manageNamesListEl || !noNamesMsgEl) return; manageNamesListEl.innerHTML = ''; const sortedNames = Array.from(allEjNamesSet).sort((a, b) => a.localeCompare(b)); noNamesMsgEl.classList.toggle('hidden', sortedNames.length > 0); sortedNames.forEach(name => { const li = document.createElement('li'); const nameSpan = document.createElement('span'); nameSpan.className = 'managed-name-text'; nameSpan.textContent = name; const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-name-btn'; deleteBtn.innerHTML = '<i data-feather="trash-2"></i>'; deleteBtn.title = `Eliminar "${name}"`; deleteBtn.onclick = async () => { if (confirm(`¿Seguro que quieres eliminar "${name}"?`)) { if (await removeEjNameFromGlobal(name)) { li.remove(); popEjNameInputs(); if (manageNamesListEl.children.length === 0) noNamesMsgEl.classList.remove('hidden'); } else alert(`Error eliminando "${name}".`); } }; li.append(nameSpan, deleteBtn); manageNamesListEl.appendChild(li); }); if (typeof feather !== 'undefined') feather.replace(); }
            if (manageNamesBtn && manageNamesScreenEl && closeManageNamesBtn) { manageNamesBtn.onclick = () => { populateManageNamesModal(); manageNamesScreenEl.classList.remove('hidden'); bodyEl.style.overflow = 'hidden'; }; const closeManageModal = () => { manageNamesScreenEl.classList.add('hidden'); bodyEl.style.overflow = ''; popEjNameInputs(); }; closeManageNamesBtn.onclick = closeManageModal; window.addEventListener('keydown', e => { if (e.key === 'Escape' && !manageNamesScreenEl.classList.contains('hidden')) closeManageModal(); }); manageNamesScreenEl.onclick = e => { if (e.target === manageNamesScreenEl) closeManageModal(); }; }
            async function saveCurrentRoutine() { const routineName = prompt("Nombre para esta rutina:", `Rutina ${new Date().toLocaleDateString()}`); if (!routineName || routineName.trim() === "") { alert("Nombre inválido."); return; } const routineConfig = await getCurCfgObj(true); const routineToSave = { nombreRutina: routineName.trim(), config: routineConfig.config, exerciseNames: routineConfig.exerciseNames }; try { await dbAction(SAVED_ROUTINES_STORE, 'readwrite', 'put', routineToSave); alert(`Rutina "${routineToSave.nombreRutina}" guardada.`); } catch (err) { console.error("Error guardando rutina:", err); if (err.name === 'ConstraintError') { alert("Error: Ya existe rutina con ese nombre."); } else { alert("Error al guardar rutina."); } } }
            async function populateLoadRoutineModal() { if (!loadRoutineListEl || !noRoutinesMsgEl) return; loadRoutineListEl.innerHTML = ''; try { const routines = await dbAction(SAVED_ROUTINES_STORE, 'readonly', 'getAll') || []; noRoutinesMsgEl.classList.toggle('hidden', routines.length > 0); if (routines.length > 0) { routines.sort((a,b) => a.nombreRutina.localeCompare(b.nombreRutina)).forEach(r => { const li = document.createElement('li'); const nameSpan = document.createElement('span'); nameSpan.className = 'routine-name-text'; nameSpan.textContent = r.nombreRutina; const actionsDiv = document.createElement('div'); actionsDiv.className = 'routine-actions'; const loadBtn = document.createElement('button'); loadBtn.className = 'routine-action-btn'; loadBtn.innerHTML = '<i data-feather="download-cloud"></i> Cargar'; loadBtn.onclick = () => { numEjSel.value = r.config.numEjercicios; numSerSel.value = r.config.numSeries; tEjSel.value = r.config.tiempoEjercicio; dEjSel.value = r.config.descansoEjercicio; dSerSel.value = r.config.descansoSerie; cfg.exerciseNames = r.exerciseNames || []; allSels.forEach(sel => sel.dispatchEvent(new Event('change'))); popEjNameInputs(); calcEstTime(); if (running) finishWorkout(false); else setUI('initial'); loadRoutineScreenEl.classList.add('hidden'); bodyEl.style.overflow = ''; alert(`Rutina "${r.nombreRutina}" cargada.`); }; const deleteBtn = document.createElement('button'); deleteBtn.className = 'routine-action-btn'; deleteBtn.innerHTML = '<i data-feather="trash-2"></i> Eliminar'; deleteBtn.onclick = async () => { if (confirm(`¿Eliminar rutina "${r.nombreRutina}"?`)) { try { await dbAction(SAVED_ROUTINES_STORE, 'readwrite', 'delete', r.nombreRutina); populateLoadRoutineModal(); } catch (err) { console.error("Error eliminando rutina:", err); alert("Error al eliminar rutina."); } } }; actionsDiv.append(loadBtn, deleteBtn); li.append(nameSpan, actionsDiv); loadRoutineListEl.appendChild(li); }); } } catch (err) { console.error("Error cargando rutinas:", err); noRoutinesMsgEl.classList.remove('hidden'); } if (typeof feather !== 'undefined') feather.replace(); }
            if (saveRoutineBtn) saveRoutineBtn.onclick = saveCurrentRoutine;
            if (loadRoutineBtn && loadRoutineScreenEl && closeLoadRoutineBtn) { loadRoutineBtn.onclick = () => { populateLoadRoutineModal(); loadRoutineScreenEl.classList.remove('hidden'); bodyEl.style.overflow = 'hidden';}; const closeLoadModal = () => { loadRoutineScreenEl.classList.add('hidden'); bodyEl.style.overflow = '';}; closeLoadRoutineBtn.onclick = closeLoadModal; window.addEventListener('keydown', e => { if (e.key === 'Escape' && !loadRoutineScreenEl.classList.contains('hidden')) closeLoadModal(); }); loadRoutineScreenEl.onclick = e => { if (e.target === loadRoutineScreenEl) closeLoadModal(); }; }

            if (openHelpModalBtn && helpModalScreenEl && closeHelpModalBtn) {
                openHelpModalBtn.onclick = () => {
                    let hrZoneHelpSection = helpModalScreenEl.querySelector('#hrZoneHelpInfo');
                    if (hrZoneHelpSection) { 
                        let zoneInfoHtml = `<h4>Zonas Cardíacas ${currentUserFcm ? `(FCmáx Estimada: ${currentUserFcm}bpm)` : '(Estándar)'}</h4><ul>`;
                        const zoneOrder = ['warmup', 'fatBurning', 'aerobic', 'anaerobic', 'limit']; 
                         for (const zoneId of zoneOrder) {
                            const zone = hrZones[zoneId];
                            if (zone) { 
                                zoneInfoHtml += `<li><strong>${zone.label.substring(0, zone.label.indexOf('(') > -1 ? zone.label.indexOf('(') : zone.label.length).trim()}</strong>: ${zone.label.substring(zone.label.indexOf('('))}</li>`;
                            }
                        }
                        zoneInfoHtml += `</ul><p>Si has introducido tu edad, las zonas se calculan automáticamente (FCmáx &#8776; 220 - edad). De lo contrario, se usan valores estándar.</p>`;
                        hrZoneHelpSection.innerHTML = zoneInfoHtml;
                    }

                    helpModalScreenEl.classList.remove('hidden');
                    bodyEl.style.overflow = 'hidden';
                     if (typeof feather !== 'undefined') feather.replace(); 
                };
                const closeHelpModal = () => {
                    helpModalScreenEl.classList.add('hidden');
                    bodyEl.style.overflow = '';
                };
                closeHelpModalBtn.onclick = closeHelpModal;
                window.addEventListener('keydown', e => {
                    if (e.key === 'Escape' && !helpModalScreenEl.classList.contains('hidden')) {
                        closeHelpModal();
                    }
                });
                helpModalScreenEl.onclick = e => {
                    if (e.target === helpModalScreenEl) {
                        closeHelpModal();
                    }
                };
            }

            function populateExerciseGuideModal() {
                if (!exerciseGuideListEl || !noPredefinedExercisesMessageEl || !predefinedExercises) return;
                exerciseGuideListEl.innerHTML = ''; 
                const exerciseKeys = Object.keys(predefinedExercises);
                if (exerciseKeys.length === 0) {
                    noPredefinedExercisesMessageEl.classList.remove('hidden');
                    return;
                }
                noPredefinedExercisesMessageEl.classList.add('hidden');
                exerciseKeys.sort((a, b) => a.localeCompare(b));
                exerciseKeys.forEach(exerciseName => {
                    const exerciseData = predefinedExercises[exerciseName];
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'explanation-item'; 
                    const imgCont = document.createElement('div');
                    imgCont.className = 'explanation-item-image-container';
                    const imgEl = document.createElement('img');
                    imgEl.className = 'explanation-item-image';
                    imgEl.src = exerciseData.image || 'images/generic.webp'; 
                    imgEl.alt = exerciseName;
                    imgCont.appendChild(imgEl);
                    const nameSpan = document.createElement('span'); 
                    nameSpan.className = 'explanation-item-name';
                    nameSpan.textContent = exerciseName;
                    const descP = document.createElement('p');
                    descP.className = 'explanation-item-description';
                    descP.textContent = exerciseData.description || 'No hay descripción disponible.';
                    itemDiv.appendChild(imgCont);
                    itemDiv.appendChild(nameSpan);
                    itemDiv.appendChild(descP);    
                    exerciseGuideListEl.appendChild(itemDiv);
                });
            }

            if (openExerciseGuideBtn && exerciseGuideScreenEl && closeExerciseGuideBtn) {
                openExerciseGuideBtn.onclick = () => {
                    populateExerciseGuideModal();
                    exerciseGuideScreenEl.classList.remove('hidden');
                    bodyEl.style.overflow = 'hidden'; 
                };
                const closeGuideModal = () => {
                    exerciseGuideScreenEl.classList.add('hidden');
                    bodyEl.style.overflow = ''; 
                };
                closeExerciseGuideBtn.onclick = closeGuideModal;
                window.addEventListener('keydown', e => {
                    if (e.key === 'Escape' && !exerciseGuideScreenEl.classList.contains('hidden')) {
                        closeGuideModal();
                    }
                });
                exerciseGuideScreenEl.onclick = e => {
                    if (e.target === exerciseGuideScreenEl) {
                        closeGuideModal();
                    }
                };
            }
            
            function initHrChart() {
                if (hrChartInstance) { 
                    hrChartInstance.destroy();
                }
                if (!hrChartCanvasEl) return;

                let displayChartData = {
                    labels: [...CHART_X_AXIS_LABELS], 
                    datasets: [{
                        label: 'BPM', 
                        data: Array(CHART_X_AXIS_LABELS.length).fill(null), 
                        fill: false,
                        tension: 0.2, 
                        pointRadius: 1.5,
                        pointHoverRadius: 4, 
                        borderWidth: 2 
                    }]
                };
                
                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 }, 
                    scales: {
                        x: {
                            grid: { color: rootSt.getPropertyValue('--chart-grid-color').trim(), display: true, drawOnChartArea: true, z: -1 }, 
                            ticks: { 
                                color: rootSt.getPropertyValue('--chart-tick-color').trim(), 
                                autoSkip: false, 
                                maxRotation: 0, 
                                minRotation: 0,
                                font: { size: 9 } 
                            }
                        },
                        y: {
                            beginAtZero: false, 
                            min: 40,  
                            max: 220, 
                            grid: { color: rootSt.getPropertyValue('--chart-grid-color').trim(), display: true, z: -1 },
                            ticks: { 
                                color: rootSt.getPropertyValue('--chart-tick-color').trim(), 
                                stepSize: 20,
                                font: { size: 10 }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }, 
                        tooltip: { 
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                         },
                        annotation: { 
                            annotations: {
                                nowBox: { 
                                    type: 'box',
                                    xMin: "Ahora", 
                                    xMax: "Ahora", 
                                    yMin: 0,       
                                    yMax: 220,     
                                    backgroundColor: rootSt.getPropertyValue('--chart-annotation-box-bg').trim(),
                                    borderColor: 'transparent', 
                                    borderWidth: 0,
                                    drawTime: 'beforeDatasetsDraw' 
                                }
                            }
                        }
                    }
                };
                displayChartData.datasets[0].borderColor = rootSt.getPropertyValue('--chart-line-color').trim();
                displayChartData.datasets[0].pointBackgroundColor = rootSt.getPropertyValue('--chart-point-color').trim();
                displayChartData.datasets[0].pointBorderColor = rootSt.getPropertyValue('--chart-point-color').trim();


                hrChartInstance = new Chart(hrChartCanvasEl, {
                    type: 'line',
                    data: displayChartData,
                    options: chartOptions
                });
                if(hrChartContainerEl) hrChartContainerEl.classList.remove('hidden');
                if (window.ChartAnnotation && !Chart.registry.plugins.get('annotation')) {
                     Chart.register(window.ChartAnnotation);
                }
            }


            function onHRDeviceDisconnected(event) {
                const deviceName = event.target && event.target.name ? event.target.name : "Dispositivo";
                console.log(`Dispositivo HR '${deviceName}' desconectado.`);
                if (connectHrDeviceBtn) {
                    connectHrDeviceBtn.innerHTML = '<i data-feather="bluetooth"></i><span class="btn-text">Pulsera</span>';
                    connectHrDeviceBtn.title = "Conectar Pulsera Cardíaca";
                    if (typeof feather !== 'undefined') feather.replace();
                }
                if (heartRateDisplayAreaEl) {
                    heartRateDisplayAreaEl.classList.add('hidden');
                    heartRateDisplayAreaEl.classList.remove('connected', 'workout-active');
                }
                if (hrValueEl) hrValueEl.textContent = '-';
                if (hrChartContainerEl) hrChartContainerEl.classList.add('hidden');
                if (hrChartInstance) {
                    hrChartInstance.destroy();
                    hrChartInstance = null;
                }
                hrDevice = null;
                hrCharacteristic = null;
                hrServer = null;
                setUI( (running && !paused && curPhase !== 'finalizado') ? 'running' : (paused ? 'paused' : (curPhase === 'finalizado' ? 'finished' : 'initial') ) );
            }

            function handleHeartRateChanged(event) {
                const value = event.target.value; 
                const flags = value.getUint8(0);
                const rate16Bits = flags & 0x1; 
                let heartRate;
                let byteOffset = 1;
                if (rate16Bits) {
                    heartRate = value.getUint16(byteOffset, true); 
                    byteOffset += 2;
                } else {
                    heartRate = value.getUint8(byteOffset);
                    byteOffset += 1;
                }
                if (hrValueEl) {
                    hrValueEl.textContent = heartRate;
                }
                
                if (heartRate > currentSessionMaxHr) {
                    currentSessionMaxHr = heartRate;
                }

                const currentTimestamp = Date.now();
                let durationSinceLastSample = 1000; 
                if (lastHrTimestamp > 0) {
                    durationSinceLastSample = currentTimestamp - lastHrTimestamp;
                }
                lastHrTimestamp = currentTimestamp;

                for (const zoneKey in hrZones) {
                    const zone = hrZones[zoneKey];
                    if (heartRate >= zone.min && heartRate <= zone.max) {
                        zone.time += durationSinceLastSample / 1000; 
                        break; 
                    }
                }

                if (hrChartInstance) {
                    const now = new Date();
                    const timeString = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
                    
                    fullHrHistory.labels.push(timeString); 
                    fullHrHistory.data.push(heartRate);

                    const displayData = hrChartInstance.data.datasets[0].data;
                    displayData.shift(); 
                    displayData.push(heartRate); 

                    hrChartInstance.update('none'); 
                }
            }

            async function connectHeartRateDevice() {
                if (!navigator.bluetooth) {
                    alert('Web Bluetooth API no está disponible en este navegador. Prueba con Chrome.');
                    return;
                }
                if (hrDevice && hrDevice.gatt.connected) {
                     if (confirm("¿Desconectar la pulsera actual?")) {
                        await disconnectHeartRateDevice();
                    }
                    return;
                }

                try {
                    if (connectHrDeviceBtn) {
                        connectHrDeviceBtn.innerHTML = '<i data-feather="loader" class="spin"></i><span class="btn-text">Buscando...</span>';
                         if (typeof feather !== 'undefined') {
                            feather.replace();
                            const loaderIcon = connectHrDeviceBtn.querySelector('i.spin');
                            if (loaderIcon) { 
                                const style = document.createElement('style');
                                style.id = 'spin-animation-style'; 
                                style.innerHTML = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } .spin { animation: spin 1s linear infinite; }`;
                                document.head.appendChild(style);
                            }
                        }
                    }
                    
                    console.log('Solicitando dispositivo Bluetooth...');
                    hrDevice = await navigator.bluetooth.requestDevice({
                        filters: [{ services: ['heart_rate'] }],
                    });
                    
                    console.log(`Dispositivo seleccionado: ${hrDevice.name}`);
                    hrDevice.addEventListener('gattserverdisconnected', onHRDeviceDisconnected);

                    if (connectHrDeviceBtn) {
                        connectHrDeviceBtn.innerHTML = '<i data-feather="activity"></i><span class="btn-text">Conectando...</span>';
                        if (typeof feather !== 'undefined') feather.replace();
                    }

                    console.log('Conectando al servidor GATT...');
                    hrServer = await hrDevice.gatt.connect();
                    console.log('Conectado al servidor GATT.');
                    
                    fullHrHistory.labels = []; 
                    fullHrHistory.data = [];
                    resetZoneTimes(); 
                    initHrChart(); 

                    console.log('Obteniendo servicio de Ritmo Cardíaco...');
                    const service = await hrServer.getPrimaryService('heart_rate');
                    console.log('Servicio obtenido.');

                    console.log('Obteniendo característica de Medición de Ritmo Cardíaco...');
                    hrCharacteristic = await service.getCharacteristic('heart_rate_measurement');
                    console.log('Característica obtenida.');

                    console.log('Iniciando notificaciones de Ritmo Cardíaco...');
                    await hrCharacteristic.startNotifications();
                    lastHrTimestamp = Date.now(); 
                    hrCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRateChanged);
                    console.log('Notificaciones iniciadas. Esperando datos...');

                    if (heartRateDisplayAreaEl) {
                        heartRateDisplayAreaEl.classList.remove('hidden');
                        heartRateDisplayAreaEl.classList.add('connected');
                    }
                    if (connectHrDeviceBtn) {
                        connectHrDeviceBtn.innerHTML = '<i data-feather="zap-off"></i><span class="btn-text">Desconectar</span>';
                        connectHrDeviceBtn.title = `Desconectar ${hrDevice.name || 'Pulsera'}`;
                         if (typeof feather !== 'undefined') feather.replace();
                    }
                    alert(`Conectado a la pulsera: ${hrDevice.name || 'Dispositivo HR'}`);

                } catch (error) {
                    console.error('Error al conectar con el dispositivo HR:', error);
                    alert(`Error al conectar: ${error.message}`);
                    if (connectHrDeviceBtn) {
                         connectHrDeviceBtn.innerHTML = '<i data-feather="bluetooth"></i><span class="btn-text">Pulsera</span>';
                         connectHrDeviceBtn.title = "Conectar Pulsera Cardíaca";
                         if (typeof feather !== 'undefined') feather.replace();
                    }
                    if (heartRateDisplayAreaEl) heartRateDisplayAreaEl.classList.add('hidden');
                    if (hrChartContainerEl) hrChartContainerEl.classList.add('hidden');
                    if (hrChartInstance) { hrChartInstance.destroy(); hrChartInstance = null; }

                    hrDevice = null; 
                    hrServer = null;
                    hrCharacteristic = null;
                } finally {
                    const spinStyle = document.getElementById('spin-animation-style');
                    if (spinStyle) spinStyle.remove();
                    setUI( (running && !paused && curPhase !== 'finalizado') ? 'running' : (paused ? 'paused' : (curPhase === 'finalizado' ? 'finished' : 'initial') ) );
                }
            }

            async function disconnectHeartRateDevice() {
                if (hrDevice && hrDevice.gatt.connected) {
                    console.log('Desconectando dispositivo HR...');
                    try {
                        if (hrCharacteristic) {
                            await hrCharacteristic.stopNotifications();
                            console.log('Notificaciones detenidas.');
                            hrCharacteristic.removeEventListener('characteristicvaluechanged', handleHeartRateChanged);
                        }
                    } catch (error) {
                        console.error('Error deteniendo notificaciones:', error);
                    }
                    
                    hrDevice.removeEventListener('gattserverdisconnected', onHRDeviceDisconnected); 
                    if (hrDevice.gatt.connected) { 
                        await hrDevice.gatt.disconnect(); 
                    } else { 
                         onHRDeviceDisconnected({target: hrDevice}); 
                    }
                    console.log('Dispositivo HR desconectado por el usuario.');
                } else {
                    console.log('Ningún dispositivo HR conectado para desconectar.');
                    onHRDeviceDisconnected({target: hrDevice || {name: "Unknown"}});
                }
            }


            if (connectHrDeviceBtn) {
                connectHrDeviceBtn.onclick = async () => {
                    if (hrDevice && hrDevice.gatt.connected) {
                        await disconnectHeartRateDevice();
                    } else {
                        await connectHeartRateDevice();
                    }
                };
            }
            
            if (closeWorkoutSummaryBtn && workoutSummaryScreenEl) {
                const closeSummaryModal = () => {
                    workoutSummaryScreenEl.classList.add('hidden');
                    bodyEl.style.overflow = '';
                    if (summaryHrChartInstance) { summaryHrChartInstance.destroy(); summaryHrChartInstance = null; }
                    if (summaryZonePieChartInstance) { summaryZonePieChartInstance.destroy(); summaryZonePieChartInstance = null; }
                };
                closeWorkoutSummaryBtn.onclick = closeSummaryModal;
                window.addEventListener('keydown', e => {
                    if (e.key === 'Escape' && !workoutSummaryScreenEl.classList.contains('hidden')) {
                        closeSummaryModal();
                    }
                });
                workoutSummaryScreenEl.onclick = e => {
                    if (e.target === workoutSummaryScreenEl) {
                        closeSummaryModal();
                    }
                };
            }

            try {
                await openDB(); 
                await loadAllEjNames(); 
                await loadLogo(); 
                loadUserProfile(); 

                popSel(numEjSel, 1, 20, 1, 4); popSel(numSerSel, 1, 10, 1, 3); popSel(tEjSel, 30, 90, 5, 45); popSel(dEjSel, 15, 30, 5, 15); popSel(dSerSel, 30, 120, 15, 60);
                calcEstTime();
                const savedTh = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
                applyTh(savedTh); 
                setUI('initial'); 
                popEjNameInputs();
                if (typeof feather !== 'undefined') feather.replace();
            } catch (err) {
                console.error("IDB init o config inicial falló:", err);
                alert("Advertencia: Almacenamiento local o config inicial falló. Algunas características podrían no persistir.");
                loadUserProfile(); 
                updPhaseColors(); calcEstTime(); const savedTh = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark'); applyTh(savedTh); setUI('initial'); popEjNameInputs(); if (typeof feather !== 'undefined') feather.replace();
            }
        });
    </script>
</body>
</html>
